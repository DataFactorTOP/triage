



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for Triage.">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.2">
    
    
      
        <title>Triage Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Triage Documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon">book</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Triage Documentation
            </span>
            <span class="md-header-nav__topic">
              Welcome!
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="http://github.com/dssg/triage" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Triage Documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">book</i>
      
    </a>
    Triage Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="http://github.com/dssg/triage" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Dirty Duck Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Dirty Duck Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/" title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/choose_your_own_adventure/" title="Choose your own adventure" class="md-nav__link">
      Choose your own adventure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/for_the_impatient/" title="For the impatient" class="md-nav__link">
      For the impatient
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/infrastructure/" title="Infrastructure" class="md-nav__link">
      Infrastructure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/data_preparation/" title="Data preparation" class="md-nav__link">
      Data preparation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Case studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        Case studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/intro/" title="Problem description" class="md-nav__link">
      Problem description
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/inspections/" title="Resource prioritization" class="md-nav__link">
      Resource prioritization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/eis/" title="Early Warning System" class="md-nav__link">
      Early Warning System
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">
    
    <label class="md-nav__link" for="nav-2-5">
      Triage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Triage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../docs/triage_intro/" title="A deeper look into triage" class="md-nav__link">
      A deeper look into triage
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Experiment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Experiment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/defining/" title="Defining an Experiment" class="md-nav__link">
      Defining an Experiment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/feature-testing/" title="Testing Feature Configuration" class="md-nav__link">
      Testing Feature Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/running/" title="Running an Experiment" class="md-nav__link">
      Running an Experiment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/upgrading/" title="Upgrading an Experiment" class="md-nav__link">
      Upgrading an Experiment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/temporal-validation/" title="Temporal Validation Deep Dive" class="md-nav__link">
      Temporal Validation Deep Dive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/cohort-labels/" title="Cohort and Label Deep Dive" class="md-nav__link">
      Cohort and Label Deep Dive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/prediction-ranking/" title="Prediction Ranking" class="md-nav__link">
      Prediction Ranking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/features/" title="Feature Generation Recipe Book" class="md-nav__link">
      Feature Generation Recipe Book
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/algorithm/" title="Experiment Algorithm" class="md-nav__link">
      Experiment Algorithm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/architecture/" title="Experiment Architecture" class="md-nav__link">
      Experiment Architecture
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docs/audition/" title="Model selection" class="md-nav__link">
      Model selection
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../postmodeling/" title="Postmodeling" class="md-nav__link">
      Postmodeling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docs/ml_governance/" title="Model governance" class="md-nav__link">
      Model governance
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docs/aws_batch/" title="Scaling up" class="md-nav__link">
      Scaling up
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Welcome!</h1>
                
                <h2>Welcome!</h2>
<p>This tutorial will show you how to use <code>triage</code>, a data science modeling tool developed at the <a href="http://dsapp.uchicago.edu">Center for Data Science and Public Policy</a> (DSaPP) at the University of Chicago.</p>
<p><code>triage</code> helps build models for three <a href="https://dssg.uchicago.edu/data-science-for-social-good-conference-2017/training-workshop-data-science-for-social-good-problem-templates/">common applied problems</a>: (a) Early warning systems (<strong>EWS</strong> or <strong>EIS</strong>), (b) <em>resource prioritization</em> (a.k.a "an inspections problem") and (c) interaction level predictions (a.k.a "appointment level"). These problems are difficult to model because their conceptualization and and implementation are prone to error, thanks to their multi-dimensional, multi-entity, time-series structure.</p>
<p>The last version of this tutorial is published in <a href="https://dssg.github.io/dirtyduck/">https://dssg.github.io/dirtyduck/</a></p>
<p><strong>NOTE</strong> This tutorial is in sync with the latest version of <code>triage</code>. At this moment <a href="https://github.com/dssg/triage/releases/tag/v3.3.0">v3.3.0 (Arepa)</a>.</p>
<h2>Before you start</h2>
<h3>What you need for this tutorial</h3>
<p>Install <a href="http://www.docker.com">Docker CE</a> and <a href="https://docs.docker.com/compose/">Docker Compose</a>. That's it. Follow the links for installation instructions.</p>
<p>Note that if you are using <code>GNU/Linux</code> you should add your user to the <code>docker</code> group following the instructions at this <a href="https://docs.docker.com/install/linux/linux-postinstall/">link</a>.</p>
<p>At the moment only operative systems with *nix-type command lines are supported, such as <code>GNU/Linux</code> and <code>MacOS</code>. Recent versions of <code>Windows</code> may also work.</p>
<h3>How to use this tutorial</h3>
<p>First, clone this repository on your laptop</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/dssg/dirtyduck.git
</pre></div>


<p>Second, run</p>
<div class="codehilite"><pre><span></span>./tutorial.sh start
</pre></div>


<p>This will take several minutes the first time you do it.</p>
<h3>How you can help to improve this tutorial</h3>
<p>If you want to contribute, please follow the suggestions in the <a href="file:///home/nanounanue/projects/dsapp/dirtyduck/README.md">README</a></p>
<h2>Description of the problem</h2>
<p>This tutorial aims to introduce the reader to <a href="https://github.com/dssg/triage">triage</a>, a machine learning modeling tool built by the <a href="https://dsapp.uchicago.edu">Center for Data Science and Public Policy</a>. We will use the well-known <a href="https://data.cityofchicago.org/Health-Human-Services/Food-Inspections/4ijn-s7e5">Chicago Food Inspections dataset</a>.<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></p>
<p>We will present the two problems that <code>triage</code> was built to model<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>:</p>
<ol>
<li><strong>Resource prioritization</strong> (internally known as the <em>inspections problem</em>)<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup> and</li>
<li><strong>Early warning</strong>.<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup></li>
</ol>
<h3>Inspection Prioritization</h3>
<p>In an ideal world, inspectors would frequently visit every food facility, every day<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup> to ensure it meets safety standards. But the real world doesn't have enough inspectors for that to happen, so the city needs to decide how to allocate its limited inspection workforce to find and remediate as many establishments with food hazards as possible. Assuming the city can inspect <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> facilities in the next <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> period of time, they can define the problem like this:</p>
<blockquote>
<p>Which <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> facilities will have a food violation in the following <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> period of time?</p>
</blockquote>
<p>If our inspection workforce is really limited, we should probably just target the most serious violations. Then we'd define the problem like this:</p>
<blockquote>
<p>Which <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> facilities will have a critical or serious violation in the following <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> period of time?</p>
</blockquote>
<h3>Early Warning</h3>
<p>Using the same data set, facility owners or managers would pose the ML problem as an early warning problem. They'd like to know whether an inspector is going to visit their facility so they can prepare for it. They can define the problem like this:</p>
<blockquote>
<p>Will my facility be inspected in the next <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> period of time?</p>
</blockquote>
<p>Note that in both cases, we are defining a period of time in which the event potentially will happen.</p>
<h3>What do they have in common?</h3>
<p>For either problem, <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> could be a day, a week, month, a quarter, a year, 56 days, or some other time period.</p>
<p>Without going into detail, both problems use data where each row describes an <strong>event</strong> in which an <strong>entity</strong> was involved, and each event has a specific <strong>outcome</strong> or result.</p>
<p>The <strong>entity</strong> for both inspection prioritizations and early warnings in this tutorial is a food <em>facility</em>, and the <strong>event</strong> is an inspection. But the <strong>outcome</strong> differs: for inspections the outcome is <em>inspection failed</em> or <em>major violation found</em>, while for early warning the outcome is <em>inspected</em>.</p>
<h3>How do they differ?</h3>
<p>Besides the obvious (i.e. the label), these ML's problem formulations have very different internal structure:</p>
<p>The <em>EIS</em> problem <strong>all</strong> the entities of interest in a given period of time <strong>have</strong> a label. The <em>Inspections</em> problem does not have that luxury: from all the existing entities of interest only a bunch are <em>inspected</em> that means that only those inspected have a label (<code>True/False</code>) but all the remaining ones doesn't have one. This will be reflected, for example in the <em>training</em> matrices: you only train in the facilities that were inspected (so you will have less rows in them). Another impact will be in the metrics: you need to be very careful about interpreting the metrics in an inspections problem. Finally, when you are designing the field validation of your model, you need to take in account this selection bias, if not, you will be inspecting the same facilities over and over<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup></p>
<h2>Infrastructure</h2>
<p>In every data science project you will need several tools to help analyze the data in an efficient<sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup> manner. Examples include a place to store the data (a database management system or <strong>DBMS</strong>); a way to put your model to work, i.e. a way that allows the model to ingest new data and make predictions (an <strong>API</strong>); and a way to examine the performance of trained models (monitor tools).</p>
<p>This tutorial includes a script for managing the infrastructure<sup><a id="fnr.8" class="footref" href="#fn.8">8</a></sup> in a transparent way.</p>
<p>The infrastructure of this tutorial has <em>four</em> pieces:</p>
<ul>
<li>a <code>postgresql</code> database called <code>food_db</code>,</li>
<li>a container that executes <code>triage</code> experiments (we will use this when trying to scale up),</li>
<li>a container for interacting with the data called <code>bastion</code>.</li>
</ul>
<p><code>bastion</code> includes a <code>postgresql</code> client (so you can interact with the database)<sup><a id="fnr.9" class="footref" href="#fn.9">9</a></sup> and a full <code>python</code> environment (so you can code or modify the things for the tutorial).</p>
<p>The only thing you need installed on your laptop is <code>docker</code>.</p>
<p>From your command line (terminal) run the following from the repo directory:</p>
<div class="highlight"><pre><span></span>    ./tutorial.sh
</pre></div>

<div class="highlight"><pre><span></span>   Usage: ./tutorial.sh {start|stop|build|rebuild|run|logs|status|destroy|all|}

   OPTIONS:
      -h|help             Show this message
      start
      stop
      rebuild
      status
      destroy
      -t|triage
      -a|all

   INFRASTRUCTURE:
      Build the infrastructure:
           $ ./tutorial.sh start

      Check the status of the containers:
           $ ./tutorial.sh status

      Stop the tutorial&#39;s infrastructure:
           $ ./tutorial.sh stop

      Destroy all the resources related to the tutorial:
           $ ./tutorial.sh destroy

      View the infrastructure logs:
           $ ./tutorial.sh -l

   EXPERIMENTS:
      NOTE:
         The following commands assume that &quot;sample_experiment_config.yaml&quot;
         is located inside the triage/experiments directory

      Run one experiment:
           $ ./tutorial.sh -t --config_file sample_experiment_config.yaml run

      Run one experiment, do not replace existing matrices or models, and enable debug:
           $ ./tutorial.sh -t --config_file sample_experiment_config.yaml --no-replace --debug run

      Validate experiment configuration file:
           $ ./tutorial.sh triage --config_file sample_experiment_config.yaml validate

      Show the experiment&#39;s temporal cross-validation blocks:
           $ ./tutorial.sh -t --config_file sample_experiment_config.yaml show-temporal-blocks

      Plot model number 4 (for Decision Trees and Random Forests):
           $ ./tutorial.sh -t --config_file sample_experiment_config.yaml show_model_plot --model 4

      Triage help:
           $ ./tutorial.sh triage --help
</pre></div>

<p>Following the instructions on the screen, we can start the infrastructure with:</p>
<div class="highlight"><pre><span></span>    ./tutorial.sh start
</pre></div>

<p>You can check that everything is running smoothly with <code>status</code></p>
<div class="highlight"><pre><span></span>    ./tutorial.sh status
</pre></div>

<div class="highlight"><pre><span></span>    Name                Command              State           Ports
   ------------------------------------------------------------------------
   food_db   docker-entrypoint.sh postgres   Up      0.0.0.0:5434-&gt;5432/tcp
</pre></div>

<p>To access <code>bastion</code>, where the <code>postgresql</code> client is, type:</p>
<div class="highlight"><pre><span></span>   ./tutorial.sh bastion
</pre></div>

<p>Your prompt should change to something like:</p>
<div class="codehilite"><pre><span></span>root@485373fb3c64:/$
</pre></div>


<p><strong>NOTE</strong>: The number you see will be different (i.e. not <code>485373fb3c64</code>).</p>
<p>Inside <code>bastion</code>, type the next command to connect to the database</p>
<div class="highlight"><pre><span></span>   psql <span class="si">${</span><span class="nv">DATABASE_URL</span><span class="si">}</span>
</pre></div>

<p>The prompt will change again to (or something <em>very</em> similar):</p>
<div class="codehilite"><pre><span></span>psql (9.6.7, server 10.2 (Debian 10.2-1.pgdg90+1))
WARNING: psql major version 9.6, server major version 10.
      Some psql features might not work.
Type &quot;help&quot; for help.

food=#
</pre></div>


<p>The previous command is using <code>psql</code>, a powerful command line client for the Postgresql database. If you want to use this client fully, check <a href="https://www.postgresql.org/docs/10/static/app-psql.html">psql's documentation</a>.</p>
<p>The database is running and it's named <code>food</code>. It should contain a single table named <code>inspections</code> in the <code>schema</code> <code>raw</code>. Let's check the structure of the <code>inspections</code> table. Type the following command:</p>
<div class="highlight"><pre><span></span>    <span class="err">\</span><span class="n">d</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
</pre></div>

<table>
<thead>
<tr>
<th>Table "raw.inspections"</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Column</td>
<td>Type</td>
<td>Collation</td>
<td>Nullable</td>
<td>Default</td>
</tr>
<tr>
<td>inspection</td>
<td>character varying</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>dba<sub>name</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>aka<sub>name</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>license<sub>num</sub></td>
<td>numeric</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>facility<sub>type</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>risk</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>address</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>city</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>state</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>zip</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>date</td>
<td>date</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>type</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>results</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>violations</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>latitude</td>
<td>numeric</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>longitude</td>
<td>numeric</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>location</td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>That's it. We will work from this table of raw data.</p>
<p>You can disconnect from the database typing <code>\q</code>. But don't leave the database yet! We still need to do a lot of things <sup><a id="fnr.10" class="footref" href="#fn.10">10</a></sup></p>
<h2>Data preparation</h2>
<p>We need to get the data and transform it into a shape that is suitable for the analysis.</p>
<p><strong>NOTE:</strong> Unless we say otherwise, you should run all the following commands inside <code>bastion</code>.</p>
<h3>Load the data</h3>
<p>Before loading the data into the database, verify that the database table is empty:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>count</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
</tr>
</tbody>
</table>
<p>We will use some <code>postgresql</code> magic in order to get the data in our database. In particular we will use the powerful <a href="https://www.postgresql.org/docs/10/sql-copy.html">copy</a> command and the City of Chicago's data API:</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="k">copy</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span> <span class="k">from</span> <span class="n">program</span> <span class="s1">&#39;curl &quot;https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD&quot;&#39;</span> <span class="n">HEADER</span> <span class="n">CSV</span>
</pre></div>

<p>Now, you should have some data:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;facilities inspected&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>facilities inspected</th>
</tr>
</thead>
<tbody>
<tr>
<td>182,419</td>
</tr>
</tbody>
</table>
<p>You'll probably get a different number because the data are updated every day. Let's peek inside the table<sup><a id="fnr.11" class="footref" href="#fn.11">11</a></sup></p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">inspection</span><span class="p">,</span>
    <span class="n">dba_name</span><span class="p">,</span>
    <span class="n">risk</span><span class="p">,</span>
    <span class="n">results</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>inspection</th>
<th>dba<sub>name</sub></th>
<th>risk</th>
<th>results</th>
</tr>
</thead>
<tbody>
<tr>
<td>2268241</td>
<td>ANTOJITOS PUEBLITA INC</td>
<td>Risk 1 (High)</td>
<td>Pass w/ Conditions</td>
</tr>
</tbody>
</table>
<p>Ok, now you have some data loaded! But we still need to <em>munge</em> it to use it in our machine learning task.</p>
<h3>Transforming (and cleaning) the data</h3>
<h4>Rationale</h4>
<p>To tackle a Machine Learning problem, you need to identify the <strong>entities</strong> for your problem domain, and if your problem involves time, how those entities change, either what <strong>events</strong> happen to the entity or what <strong>events</strong> the entity effects.</p>
<p>We will encode this information in two tables, one named <code>entities</code> and the other <code>events</code>.</p>
<p>The entity, in this example, is the food <strong>facility</strong>, and the events are the <strong>inspections</strong> on the facility.</p>
<p>The <code>entities</code> table should contain a unique identifier for the entity and some data about that entity (like name, age, status). The <code>events</code> table will include data related to the inspection, including the two most important attributes: its spatial and temporal positions <sup><a id="fnr.12" class="footref" href="#fn.12">12</a></sup>.</p>
<p>Before starting the cleaning, make your life easier by following this rule:</p>
<blockquote>
<p><em>Do not change the original data</em></p>
</blockquote>
<p>The reason is, if you make a mistake or want to try a different data transformation, you can always can go back to the <code>raw</code> data and start over.</p>
<h4>Data road</h4>
<p>The transformation "road" that we will take in this tutorial is as follows:</p>
<ol>
<li>Put a copy of the data in the <code>raw</code> schema. (We just did that.)</li>
<li>Apply some simple transformations and store the resulting data in the <code>cleaned</code> schema.</li>
<li>Organize the data in two <em>unnormalized</em><sup><a id="fnr.13" class="footref" href="#fn.13">13</a></sup> tables: <code>events</code> and <code>entities</code> in the <code>semantic</code> schema.</li>
<li>Run <code>triage</code>. It will create several schemas (<code>model_metadata</code>, <code>test_results</code>, <code>train_results</code>).</li>
</ol>
<p><img alt="img" src="images/data_road.png" /></p>
<p><a id="org37b80a0"></a></p>
<h4>Dataset documentation</h4>
<p>The Chicago Food Inspection dataset has documentation <a href="https://data.cityofchicago.org/api/assets/BAD5301B-681A-4202-9D25-51B2CAE672FF?download=true">here</a>.</p>
<p>We can make sense there about the column's meaning, and the process that generates the data.</p>
<p>Most columns are self-explanatory, but some are not:<sup><a id="fnr.14" class="footref" href="#fn.14">14</a></sup></p>
<ul>
<li><strong><em>*Risk category of facility</em>* (<code>risk</code>):</strong></li>
</ul>
<blockquote>
<p>Each establishment is categorized as to its risk of adversely affecting the public’s health, with 1 being the highest and 3 the lowest. The frequency of inspection is tied to this risk, with risk 1 establishments inspected most frequently and risk 3 least frequently.</p>
</blockquote>
<ul>
<li><strong><em>*Inspection type</em>* (<code>type</code>):</strong></li>
</ul>
<blockquote>
<p>An inspection can be one of the following types: canvass, the most common type of inspection performed at a frequency relative to the risk of the establishment; consultation, when the inspection is done at the request of the owner prior to the opening of the establishment; complaint, when the inspection is done in response to a complaint against the establishment; license, when the inspection is done as a requirement for the establishment to receive its license to operate; suspect food poisoning, when the inspection is done in response to one or more persons claiming to have gotten ill as a result of eating at the establishment (a specific type of complaint-based inspection); task-force inspection, when an inspection of a bar or tavern is done. Re-inspections can occur for most types of these inspections and are indicated as such.</p>
</blockquote>
<ul>
<li><strong><em>*Results</em>* (<code>results</code>):</strong></li>
</ul>
<blockquote>
<p>An inspection can pass, pass with conditions, or fail. Establishments receiving a ‘pass’ were found to have no critical or serious violations (violation number 1-14 and 15-29, respectively). Establishments receiving a ‘pass with conditions’ were found to have critical or serious violations, but these were corrected during the inspection. Establishments receiving a ‘fail’ were found to have critical or serious violations that were not correctable during the inspection. An establishment receiving a ‘fail’ does not necessarily mean the establishment’s licensed is suspended. Establishments found to be out of business or not located are indicated as such.</p>
</blockquote>
<ul>
<li><strong><em>*Violations</em>* (<code>violations</code>):</strong></li>
</ul>
<blockquote>
<p>An establishment can receive <strong>one or more</strong> of 45 distinct violations (violation numbers 1-44 and 70). For each violation number listed for a given establishment, <em>the requirement the establishment must meet in order for it</em> to <strong>NOT</strong> <em>receive a violation is noted, followed by a specific description of the findings that caused the violation to be issued</em>.</p>
</blockquote>
<p>We added emphasis to the last one.</p>
<p>From these definitions, we can infer the following:</p>
<ol>
<li><em>risk</em> is related to the frequency of inspections of type <em>canvass</em>.</li>
<li><em>consultation</em> is an inspection <em>before</em> the facility opens (so we can remove it from the data). The same happens with <em>license</em>.</li>
<li><em>complaint</em> and <em>suspected food poisoning</em> are triggered by people.</li>
<li><em>consultation</em> is triggered by the owner of the facility.</li>
<li><em>task-force</em> occurs at bars or taverns.</li>
<li><strong>Critical violations</strong> are coded between <code>1-14</code>, <strong>serious violations</strong> between <code>15-29</code>. We can assume that the violations code <code>30</code> and higher are <em>minor</em> violations.</li>
<li><em>violation</em> describes the problems found, and the comment section describes the steps the facility should take to fix the problem.</li>
<li>There are only three possible results of the inspection. (Also, an inspection may not happen if the facility was not located or went out of business).</li>
<li>There can be several <code>violations</code> per <code>inspection</code>.</li>
</ol>
<h4>Reality check</h4>
<p>It is important to verify that the documentation is correct. Let's start by checking that the <code>risk</code> column <strong>only</strong> has three classifications:</p>
<p><strong>NOTE</strong> Execute this in <code>psql</code> inside the container <code>bastion</code>.</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">risk</span><span class="p">,</span>
      <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">risk</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>risk</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>Risk 1 (High)</td>
<td>129,667</td>
</tr>
<tr>
<td>Risk 2 (Medium)</td>
<td>36,286</td>
</tr>
<tr>
<td>Risk 3 (Low)</td>
<td>16,370</td>
</tr>
<tr>
<td>¤</td>
<td>71</td>
</tr>
<tr>
<td>All</td>
<td>25</td>
</tr>
</tbody>
</table>
<p>Ok, there are two extra <code>risk</code> types, <code>All</code> and <code>NULL</code>, for a grand total of <strong>5</strong>.</p>
<p>What about <code>types</code> of inspections?</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="k">type</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;types of inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>types of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>108</td>
</tr>
</tbody>
</table>
<p>Wow, there are <strong>108</strong> types of inspections instead of the expected <strong>5</strong>!</p>
<p>What are those types? How bad is it?</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">type</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">type</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span>
    <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>type</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>Canvass</td>
<td>96,561</td>
</tr>
<tr>
<td>License</td>
<td>23,785</td>
</tr>
<tr>
<td>Canvass Re-Inspection</td>
<td>18,922</td>
</tr>
<tr>
<td>Complaint</td>
<td>16,953</td>
</tr>
<tr>
<td>License Re-Inspection</td>
<td>8,411</td>
</tr>
<tr>
<td>Complaint Re-Inspection</td>
<td>6,911</td>
</tr>
<tr>
<td>Short Form Complaint</td>
<td>6,491</td>
</tr>
<tr>
<td>Suspected Food Poisoning</td>
<td>817</td>
</tr>
<tr>
<td>Consultation</td>
<td>671</td>
</tr>
<tr>
<td>License-Task Force</td>
<td>605</td>
</tr>
</tbody>
</table>
<p>This column will require also cleaning.</p>
<p>Finally, let's look <code>results</code> (should be 3)</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">results</span><span class="p">,</span>
      <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">results</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>results</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pass</td>
<td>102,592</td>
</tr>
<tr>
<td>Fail</td>
<td>35,252</td>
</tr>
<tr>
<td>Pass w/ Conditions</td>
<td>21,401</td>
</tr>
<tr>
<td>Out of Business</td>
<td>15,973</td>
</tr>
<tr>
<td>No Entry</td>
<td>5,619</td>
</tr>
<tr>
<td>Not Ready</td>
<td>1,516</td>
</tr>
<tr>
<td>Business Not Located</td>
<td>66</td>
</tr>
</tbody>
</table>
<p>Ok, disheartening. But that's the reality of <em>real</em> data. We'll try to clean this mess.</p>
<h4>Cleaning</h4>
<p>Let's look at the data to figure out how we need to transform it. We'll start with all the columns except <code>violations</code>. We'll deal with that one later because it's more complex.</p>
<p>First, we'll remove superfluous spaces; convert the columns <code>type, results, dba_name, aka_name, facility_type, address, city</code> to lower case; and clean <code>risk</code>, keeping only the description (e.g. <code>high</code> instead of <code>Risk 1 (High)</code>).</p>
<p>We still need to clean further the column <code>type</code> (which contains more values than the <strong>seven</strong> mentioned in the documentation: <em>canvass</em>, <em>complaint</em>, <em>license</em>, <em>re-inspection</em>, <em>task-force</em>, <em>consultation</em>, and <em>suspected food poisoning</em>). For simplicity, we will use <em>regular expressions</em> and ignore <em>re-inspection</em>.</p>
<p>For the column <code>risk</code>, we will impute as <code>high</code> all the <code>NULL</code> and <code>All</code> values<sup><a id="fnr.15" class="footref" href="#fn.15">15</a></sup>.</p>
<p>As we have seen (and will continue see) through this tutorial, <em>real data are messy</em>; for example, the column <code>dba_name</code> has several spellings for the same thing: <code>SUBWAY</code> and <code>Subway</code>, <code>MCDONALDS</code> and <code>MC DONALD'S</code>, <code>DUNKIN DONUTS/BASKIN ROBBINS</code> and <code>DUNKIN DONUTS / BASKIN ROBBINS</code>, etc.</p>
<p>We could use <a href="https://www.postgresql.org/docs/current/static/fuzzystrmatch.html">soundex</a> or machine learning <em>deduplication</em><sup><a id="fnr.16" class="footref" href="#fn.16">16</a></sup> to clean these names, but we'll go with a very simple cleaning strategy: convert all the names to lowercase, remove the trailing spaces, remove the apostrophe, and remove the spaces around "<code>/</code>". It won't completely clean those names, but it's good enough for this example project.</p>
<p>Let's review the status of the spatial columns (<code>state, city, zip, latitude, longitude</code>). Beginning with <code>state</code>, all the facilities in the data should be located in <strong>Illinois</strong>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">state</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">state</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>state</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>IL</td>
<td>182,385</td>
</tr>
<tr>
<td>¤</td>
<td>34</td>
</tr>
</tbody>
</table>
<p>Ok, almost correct, there are some <code>NULL</code> values. We will assume that the <code>NULL</code> values are actually <code>IL</code> (i.e. we will impute them). Moving to the next spatial column, we expect that all the values in the column <code>city</code> are Chicago:<sup><a id="fnr.17" class="footref" href="#fn.17">17</a></sup></p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">lower</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">as</span> <span class="n">city</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">lower</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span>
    <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>city</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>chicago</td>
<td>182,011</td>
</tr>
<tr>
<td>¤</td>
<td>157</td>
</tr>
<tr>
<td>cchicago</td>
<td>44</td>
</tr>
<tr>
<td>schaumburg</td>
<td>23</td>
</tr>
<tr>
<td>maywood</td>
<td>16</td>
</tr>
<tr>
<td>elk grove village</td>
<td>13</td>
</tr>
<tr>
<td>evanston</td>
<td>10</td>
</tr>
<tr>
<td>chestnut street</td>
<td>9</td>
</tr>
<tr>
<td>cicero</td>
<td>9</td>
</tr>
<tr>
<td>inactive</td>
<td>8</td>
</tr>
</tbody>
</table>
<p>Oh boy. There are 150-ish rows with <code>NULL</code> values and forty-ish rows with the value <code>cchicago</code>. Farther down the list (if you dare), we even have <code>chicagochicago</code>. All the values are near Chicago, even if they're in different counties, so we will ignore this column (or equivalently, we will assume that all the records are from Chicago).</p>
<p>Zip code has a similar <code>NULL</code> problem:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections w/o zip code&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">where</span>
    <span class="n">zip</span> <span class="k">is</span> <span class="k">null</span> <span class="k">or</span> <span class="n">btrim</span><span class="p">(</span><span class="n">zip</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>number of inspections w/o zip code</th>
</tr>
</thead>
<tbody>
<tr>
<td>75</td>
</tr>
</tbody>
</table>
<p>We could attempt to replace these <code>NULL</code> values using the location point or using similar names of restaurants, but for this tutorial we will remove them. Also, we will convert the coordinates latitude and longitude to a Postgres <code>Point</code>.<sup><a id="fnr.18" class="footref" href="#fn.18">18</a></sup> <sup>, </sup><sup><a id="fnr.19" class="footref" href="#fn.19">19</a></sup> <sup>, </sup><sup><a id="fnr.20" class="footref" href="#fn.20">20</a></sup></p>
<p>We will drop the columns <code>state</code>, <code>latitude</code>, and <code>longitude</code> because the <code>Point</code> contains all that information. We also will remove the column <code>city</code> because almost everything happens in Chicago.</p>
<p>If you're keeping count, we are only keeping two columns related to the spatial location of the events: the location of the facility (<code>location</code>) and one related to inspection assignments (<code>zip_code</code>).</p>
<p>Each inspection can have multiple violations. To handle that as simply as possible, we'll put violations in their own table.</p>
<p>Finally, we will improve the names of the columns (e.g. <code>results -&gt; result, dba_name -&gt; facility</code>, etc).</p>
<p>We will create a new <code>schema</code> called <code>cleaned</code>. The objective of this schema is twofold: to keep our raw data <em>as is <sup><a id="fnr.21" class="footref" href="#fn.21">21</a></sup></em> and to store our assumptions and cleaning decisions separate from the <em>raw</em> data in a schema that <em>semantically</em> transmits that "this is our cleaned data."</p>
<p>The <code>cleaned</code> schema will contain two tables: <code>cleaned.inspections</code> and <code>cleaned.violations</code>.</p>
<div class="highlight"><pre><span></span>  <span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">;</span>
</pre></div>

<p>Then, we will create our mini <strong>ETL</strong> with our cleaning decisions:</p>
<div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">with</span> <span class="n">cleaned</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span>
            <span class="n">inspection</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
            <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">results</span><span class="p">))</span> <span class="k">as</span> <span class="k">result</span><span class="p">,</span>
            <span class="n">license_num</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
            <span class="k">replace</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">dba_name</span><span class="p">)),</span> <span class="s1">&#39;\s{2,}|,|\.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="err">$$</span><span class="s1">&#39;$$,&#39;&#39;) as facility,</span>
<span class="s1">            replace(regexp_replace(btrim(lower(aka_name)), &#39;</span><span class="err">\</span><span class="n">s</span><span class="err">{</span><span class="mi">2</span><span class="p">,</span><span class="err">}</span><span class="o">|</span><span class="p">,</span><span class="o">|</span><span class="err">\</span><span class="p">.</span><span class="s1">&#39;,&#39;&#39;), $$&#39;</span><span class="err">$$</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">facility_aka</span><span class="p">,</span>
            <span class="k">case</span> <span class="k">when</span>
            <span class="n">facility_type</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="k">else</span> <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">facility_type</span><span class="p">))</span>
            <span class="k">end</span> <span class="k">as</span> <span class="n">facility_type</span><span class="p">,</span>
            <span class="k">lower</span><span class="p">(</span><span class="k">substring</span><span class="p">(</span><span class="n">risk</span> <span class="k">from</span> <span class="s1">&#39;\((.+)\)&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">risk</span><span class="p">,</span>
            <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">address</span><span class="p">))</span> <span class="k">as</span> <span class="n">address</span><span class="p">,</span>
            <span class="n">zip</span> <span class="k">as</span> <span class="n">zip_code</span><span class="p">,</span>
            <span class="k">substring</span><span class="p">(</span>
                <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="k">type</span><span class="p">,</span> <span class="s1">&#39;liquor&#39;</span><span class="p">,</span> <span class="s1">&#39;task force&#39;</span><span class="p">,</span> <span class="s1">&#39;gi&#39;</span><span class="p">)))</span>
            <span class="k">from</span> <span class="s1">&#39;canvass|task force|complaint|food poisoning|consultation|license|tag removal&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">type</span><span class="p">,</span>
            <span class="nb">date</span><span class="p">,</span>
            <span class="c1">-- point(longitude, latitude) as location</span>
            <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">),</span> <span class="mi">4326</span><span class="p">)::</span><span class="n">geography</span> <span class="k">as</span> <span class="k">location</span>  <span class="c1">-- We use geography so the measurements are in meters</span>
        <span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
        <span class="k">where</span> <span class="n">zip</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>  <span class="c1">-- removing NULL zip codes</span>
            <span class="p">)</span>

    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">cleaned</span> <span class="k">where</span> <span class="k">type</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
        <span class="p">);</span>
</pre></div>

<p>You could execute this code from the command line using <code>psql</code>:</p>
<div class="highlight"><pre><span></span>psql <span class="si">${</span><span class="nv">DATABASE_URL</span><span class="si">}</span> &lt; /sql/create_cleaned_inspections_table.sql
</pre></div>

<p>Or if you're in <code>psql</code>:</p>
<div class="codehilite"><pre><span></span>\i /sql/create_cleaned_inspections_table.sql
</pre></div>


<p>The number of inspections now is:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">inspection</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>181,546</td>
</tr>
</tbody>
</table>
<p>Note that quantity is smaller than the one from <code>raw.inspections</code>, since we throw away some inspections.</p>
<p>With the <code>cleaned.inspections</code> table created, let's take a closer look at the <code>violations</code> column to figure out how to clean it.</p>
<p>The first thing to note is that the column <code>violation</code> has a lot of information: it describes the code violation, what's required to address it (see <a href="#org37b80a0">Dataset documentation</a>), and the inspector's comments. The comments are free text, which means that they can contain line breaks, mispellings, etc. In particular, note that pipes (<code>|</code>) seperate multiple violations.</p>
<p>The following <code>sql</code> code removes line breaks and multiple spaces and creates an array with all the violations for inspection number <code>2145736</code>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="s1">&#39;[\n\r]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span> <span class="p">),</span> <span class="s1">&#39;|&#39;</span><span class="p">))</span>  <span class="k">as</span> <span class="n">violations_array</span>
<span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">where</span>
    <span class="n">inspection</span> <span class="o">=</span> <span class="s1">&#39;2145736&#39;</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>violations<sub>array</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: FIRST FLOOR GIRL'S WASHROOM,MIDDLE WASHBOWL SINK FAUCET NOT IN GOOD REPAIR, MUST REPAIR AND MAINTAIN.   ONE OUT OF TWO HAND DRYER NOT WORKING IN THE FOLLOWING WASHROOM: FIRST FLOOR  BOY'S AND GIRL'S WASHROOM, AND  BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR AND MAINTAIN.</td>
</tr>
<tr>
<td>34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: DAMAGED FLOOR INSIDE THE BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR, MAKE THE FLOOR SMOOTH EASILY CLEANABLE.</td>
</tr>
<tr>
<td>35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: MISSING PART OF THE COVING(BASEBOARD) BY THE EXPOSED HAND SINK IN THE KITCHEN. MUST REPAIR AND MAINTAIN.   WATER STAINED CEILING TILES IN THE LUNCH ROOM. MUST REPLACE CEILING TILES AND MAINTAIN.  PEELING PAINT ON THE CEILING AND WALLS THROUGHOUT THE SCHOOL. HALLWAYS, INSIDE THE CLASSROOMS, INSIDE THE WASHROOMS IN ALL FLOORS. INSTRUCTED TO SCRAPE PEELING PAINT AND RE PAINT.</td>
</tr>
</tbody>
</table>
<p>This little piece of code is doing a lot: first it replaces all the line breaks <code>[\n\r]+</code> with spaces, then, it splits the string using the pipe and stores it in an array (<code>string_to_array</code>), finally it returns every violation description in a row (<code>unnest</code>).</p>
<p>From this, we can learn that the structure of the <code>violations</code> column follows:</p>
<ul>
<li>If there are several violations reported, those violations will be separated by <code>'|'</code></li>
<li>Every violation begins with a code and a description</li>
<li>Every violation can have <strong>comments</strong>, which appear after the string <code>- Comments:</code></li>
</ul>
<p>We will create a new table called <code>cleaned.violations</code> to store</p>
<ul>
<li>inspection</li>
<li>code</li>
<li>description</li>
<li>comments</li>
</ul>
<div class="highlight"><pre><span></span>   <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">cascade</span><span class="p">;</span>

   <span class="k">create</span> <span class="k">table</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="p">(</span>
   <span class="k">select</span>
       <span class="n">inspection</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
       <span class="n">license_num</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
       <span class="nb">date</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
       <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">as</span> <span class="n">code</span><span class="p">,</span>
       <span class="k">lower</span><span class="p">(</span><span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="k">as</span> <span class="n">description</span><span class="p">,</span>
       <span class="k">lower</span><span class="p">(</span><span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="k">as</span> <span class="k">comment</span><span class="p">,</span>
       <span class="p">(</span><span class="k">case</span>
           <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">then</span> <span class="k">NULL</span>
           <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])::</span><span class="nb">int</span> <span class="k">between</span> <span class="mi">1</span> <span class="k">and</span> <span class="mi">14</span> <span class="k">then</span> <span class="s1">&#39;critical&#39;</span> <span class="c1">-- From the documentation</span>
           <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])::</span><span class="nb">int</span> <span class="k">between</span> <span class="mi">15</span> <span class="k">and</span> <span class="mi">29</span>  <span class="k">then</span> <span class="s1">&#39;serious&#39;</span>
           <span class="k">else</span> <span class="s1">&#39;minor&#39;</span>
           <span class="k">end</span>
           <span class="p">)</span> <span class="k">as</span> <span class="n">severity</span> <span class="k">from</span>
       <span class="p">(</span>
       <span class="k">select</span>
           <span class="n">inspection</span><span class="p">,</span>
           <span class="n">license_num</span><span class="p">,</span>
           <span class="nb">date</span><span class="p">,</span>
           <span class="n">regexp_split_to_array</span><span class="p">(</span>   <span class="c1">-- Create an array we will split the code, description, comment</span>
               <span class="n">regexp_split_to_table</span><span class="p">(</span> <span class="c1">-- Create a row per each comment we split by |</span>
                   <span class="n">coalesce</span><span class="p">(</span>            <span class="c1">-- If there isn&#39;t a violation add &#39;- Comments:&#39;</span>
                       <span class="n">regexp_replace</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="s1">&#39;[\n\r]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span> <span class="p">)</span>  <span class="c1">-- Remove line breaks</span>
                       <span class="p">,</span> <span class="s1">&#39;- Comments:&#39;</span><span class="p">)</span>
                   <span class="p">,</span> <span class="s1">&#39;\|&#39;</span><span class="p">)</span>  <span class="c1">-- Split the violations</span>
               <span class="p">,</span> <span class="s1">&#39;(?&lt;=\d+)\.\s*|\s*-\s*Comments:&#39;</span><span class="p">)</span>  <span class="c1">-- Split each violation in three</span>
            <span class="c1">-- , &#39;\.\s*|\s*-\s*Comments:&#39;)  -- Split each violation in three (Use this if your postgresql is kind off old</span>
           <span class="k">as</span> <span class="n">tuple</span>
       <span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
       <span class="k">where</span> <span class="n">results</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;Fail&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass w/ Conditions&#39;</span><span class="p">)</span> <span class="k">and</span> <span class="n">license_num</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
           <span class="p">)</span> <span class="k">as</span> <span class="n">t</span>
       <span class="p">);</span>
</pre></div>

<p>This code is in <code>/sql/create_violations_table.sql</code>. You can execute it with psql's <code>-f</code> option, as before.</p>
<p>We can verify the result of the previous script</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">inspection</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">description</span>
<span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span>
<span class="k">where</span>
    <span class="n">inspection</span> <span class="o">=</span> <span class="mi">2145736</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">code</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>inspection</th>
<th>date</th>
<th>code</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>2145736</td>
<td>2018-03-01</td>
<td>32</td>
<td>food and non-food contact surfaces properly designed, constructed and maintained</td>
</tr>
<tr>
<td>2145736</td>
<td>2018-03-01</td>
<td>34</td>
<td>floors: constructed per code, cleaned, good repair, coving installed, dust-less cleaning methods used</td>
</tr>
<tr>
<td>2145736</td>
<td>2018-03-01</td>
<td>35</td>
<td>walls, ceilings, attached equipment constructed per code: good repair, surfaces clean and dust-less cleaning methods</td>
</tr>
</tbody>
</table>
<p>If everything worked correctly you should be able to run the following code<sup><a id="fnr.22" class="footref" href="#fn.22">22</a></sup>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">case</span>
    <span class="k">when</span>
    <span class="k">grouping</span><span class="p">(</span><span class="n">severity</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="s1">&#39;TOTAL&#39;</span>
    <span class="k">else</span>
    <span class="n">severity</span>
    <span class="k">end</span> <span class="k">as</span> <span class="n">severity</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">rollup</span> <span class="p">(</span><span class="n">severity</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">severity</span> <span class="n">nulls</span> <span class="k">first</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>severity</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>¤</td>
<td>26,039</td>
</tr>
<tr>
<td>critical</td>
<td>46,443</td>
</tr>
<tr>
<td>minor</td>
<td>465,535</td>
</tr>
<tr>
<td>serious</td>
<td>53,566</td>
</tr>
<tr>
<td>TOTAL</td>
<td>591,583</td>
</tr>
</tbody>
</table>
<p>As a last step, we should create from the cleaned tables the <code>entities</code> and <code>events</code> tables.</p>
<h3>Semantic tables</h3>
<h4>Entities table</h4>
<p>The <code>entities</code> table should uniquely identify each facility and contain descriptive attributes. First, we should investigate how we can uniquely identify a facility. Let's hope it's easy<sup><a id="fnr.23" class="footref" href="#fn.23">23</a></sup>.</p>
<p>Let's start with the obvious option. Perhaps <code>license_num</code> is a unique identifier. Let's confirm our hypothesis with some queries.</p>
<p>We will begin with the following query: <em>What are 5 licenses with the most inspections?</em></p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">license_num</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span><span class="p">,</span>
    <span class="n">coalesce</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">as</span> <span class="ss">&quot;number of failed inspections&quot;</span>
<span class="k">from</span>
    <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">license_num</span>
<span class="k">order</span> <span class="k">by</span>
     <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span>
    <span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>license<sub>num</sub></th>
<th>number of inspections</th>
<th>number of failed inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>454</td>
<td>114</td>
</tr>
<tr>
<td>1354323</td>
<td>192</td>
<td>1</td>
</tr>
<tr>
<td>14616</td>
<td>174</td>
<td>31</td>
</tr>
<tr>
<td>1574001</td>
<td>82</td>
<td>4</td>
</tr>
<tr>
<td>1974745</td>
<td>59</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>This looks weird. There are three license numbers, in particular license number <code>0</code>, that have many more inspections than the rest. Let's investigate <code>license_num</code> = <code>0</code>.</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">facility_type</span><span class="p">,</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span><span class="p">,</span>
      <span class="n">coalesce</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of failed inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">where</span>
      <span class="n">license_num</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">facility_type</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="ss">&quot;number of inspections&quot;</span> <span class="k">desc</span>
  <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>facility<sub>type</sub></th>
<th>number of inspections</th>
<th>number of failed inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>restaurant</td>
<td>104</td>
<td>44</td>
</tr>
<tr>
<td>special event</td>
<td>73</td>
<td>9</td>
</tr>
<tr>
<td>unknown</td>
<td>44</td>
<td>10</td>
</tr>
<tr>
<td>shelter</td>
<td>31</td>
<td>6</td>
</tr>
<tr>
<td>navy pier kiosk</td>
<td>30</td>
<td>4</td>
</tr>
<tr>
<td>church</td>
<td>30</td>
<td>3</td>
</tr>
<tr>
<td>grocery store</td>
<td>16</td>
<td>7</td>
</tr>
<tr>
<td>school</td>
<td>13</td>
<td>1</td>
</tr>
<tr>
<td>long term care</td>
<td>11</td>
<td>2</td>
</tr>
<tr>
<td>church kitchen</td>
<td>11</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>It seems that <code>license_number</code> <code>0</code> is a generic placeholder: Most of these are related to <em>special events</em>, <em>churches</em>, <em>festivals</em>, etc. But what about the <code>restaurants</code> that have <code>license_num</code> = <code>0</code>? Are those the same restaurant?</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">license_num</span><span class="p">,</span>
      <span class="n">facility</span><span class="p">,</span>
      <span class="n">address</span><span class="p">,</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span><span class="p">,</span>
      <span class="n">coalesce</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">as</span> <span class="ss">&quot;number of failed inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">where</span>
      <span class="n">license_num</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">and</span>
      <span class="n">facility_type</span> <span class="o">=</span> <span class="s1">&#39;restaurant&#39;</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">address</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="ss">&quot;number of inspections&quot;</span> <span class="k">desc</span>
  <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>license<sub>num</sub></th>
<th>facility</th>
<th>address</th>
<th>number of inspections</th>
<th>number of failed inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>british airways</td>
<td>11601 w touhy ave</td>
<td>5</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>rib lady 2</td>
<td>4203 w cermak rd</td>
<td>4</td>
<td>3</td>
</tr>
<tr>
<td>0</td>
<td>taqueria la capital</td>
<td>3508 w 63rd st</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>nutricion familiar</td>
<td>3000 w 59th st</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>salvation army</td>
<td>506 n des plaines st</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>herbalife</td>
<td>6214 w diversey ave</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>0</td>
<td>la michoacana</td>
<td>4346 s california ave</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>las quecas</td>
<td>2500 s christiana ave</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>mrs ts southern fried chicken</td>
<td>3343 n broadway</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>unlicensed</td>
<td>7559 n ridge blvd</td>
<td>3</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Nope. Unfortunately, <code>license_num</code> is not a unique identifier.</p>
<p>Perhaps <code>license_num</code> and <code>address</code> are a unique identifier.</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
  <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">license_num</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of licenses&quot;</span><span class="p">,</span>
  <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">facility</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of facilities&quot;</span><span class="p">,</span>
  <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">address</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of addresses&quot;</span>
  <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>number of licenses</th>
<th>number of facilities</th>
<th>number of addresses</th>
</tr>
</thead>
<tbody>
<tr>
<td>35,546</td>
<td>25,917</td>
<td>17,515</td>
</tr>
</tbody>
</table>
<p>We were expecting (naively) that we should get one <code>license_num</code> per <code>facility</code> per <code>address</code>, but that isn't the case. Perhaps several facilities share a name (e.g. "Subway" or "McDonalds") or license, or perhaps several facilities share the same address, such as facilities at the stadium or the airport.</p>
<p>We will try to use the combination of <code>license_num</code>, <code>facility</code>, <code>facility_aka</code>, <code>facility_type</code>, and <code>address</code> to identify a facility:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span> <span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility_type</span>
<span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>license<sub>num</sub></th>
<th>facility</th>
<th>facility<sub>type</sub></th>
<th>facility<sub>aka</sub></th>
<th>address</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>1142451</td>
<td>jewel foodstore # 3345</td>
<td>grocery store</td>
<td>jewel foodstore # 3345</td>
<td>1224 s wabash ave</td>
<td>46</td>
</tr>
<tr>
<td>1490035</td>
<td>mcdonalds</td>
<td>restaurant</td>
<td>mcdonalds</td>
<td>6900 s lafayette ave</td>
<td>46</td>
</tr>
<tr>
<td>1596210</td>
<td>food 4 less midwest #552</td>
<td>grocery store</td>
<td>food 4 less</td>
<td>7030 s ashland ave</td>
<td>45</td>
</tr>
<tr>
<td>2083833</td>
<td>marianos fresh market #8503</td>
<td>grocery store</td>
<td>marianos fresh market</td>
<td>333 e benton pl</td>
<td>45</td>
</tr>
<tr>
<td>60184</td>
<td>taqueria el ranchito</td>
<td>restaurant</td>
<td>taqueria el ranchito</td>
<td>2829 n milwaukee ave</td>
<td>42</td>
</tr>
<tr>
<td>1476553</td>
<td>petes produce</td>
<td>grocery store</td>
<td>petes produce</td>
<td>1543 e 87th st</td>
<td>41</td>
</tr>
<tr>
<td>1000572</td>
<td>jewel food store #3030</td>
<td>grocery store</td>
<td>jewel food store #3030</td>
<td>7530 s stony island ave</td>
<td>40</td>
</tr>
<tr>
<td>1302136</td>
<td>mcdonalds</td>
<td>restaurant</td>
<td>mcdonalds</td>
<td>70 e garfield blvd</td>
<td>40</td>
</tr>
<tr>
<td>1094</td>
<td>one stop food &amp; liquor store</td>
<td>grocery store</td>
<td>one stop food &amp; liquor store</td>
<td>4301-4323 s lake park ave</td>
<td>40</td>
</tr>
<tr>
<td>2108657</td>
<td>morrisons restaurant</td>
<td>restaurant</td>
<td>morrisons restaurant</td>
<td>8127 s ashland ave</td>
<td>38</td>
</tr>
</tbody>
</table>
<p>Yay, it looks like these columns enable us to identify a facility!<sup><a id="fnr.24" class="footref" href="#fn.24">24</a></sup></p>
<p>The <code>entities</code> table should store two other types of attributes. The first type describe the entity no matter the time. If the entity were a person, date of birth would be an example but age would not because the latter changes but the former does not. We'll include <code>zip_code</code> and <code>location</code> as two facility attributes.</p>
<p>The second type describes when the entity is available for action (e.g. inspection). In this case, the columns <code>start_time, end_time</code> describe the interval in which the facility is in business or <em>active</em>. These columns are important because we don't want to make predictions for inactive entities.</p>
<p>The data don't contain active/inactive date columns, so we will use the date of the facility's first inspection as <code>start_time</code>, and either <code>NULL</code> or the date of inspection if the result was <code>out of business</code> or <code>business not located</code> as <code>end_time</code>.</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">;</span>

<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">with</span> <span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span>
            <span class="k">distinct</span> <span class="k">on</span> <span class="p">(</span>
                <span class="n">license_num</span><span class="p">,</span>
                <span class="n">facility</span><span class="p">,</span>
                <span class="n">facility_aka</span><span class="p">,</span>
                <span class="n">facility_type</span><span class="p">,</span>
                <span class="n">address</span>
                <span class="p">)</span>
            <span class="n">license_num</span><span class="p">,</span>
            <span class="n">facility</span><span class="p">,</span>
            <span class="n">facility_aka</span><span class="p">,</span>
            <span class="n">facility_type</span><span class="p">,</span>
            <span class="n">address</span><span class="p">,</span>
            <span class="n">zip_code</span><span class="p">,</span>
            <span class="k">location</span><span class="p">,</span>
            <span class="k">min</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">start_time</span><span class="p">,</span>
            <span class="k">max</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="k">result</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;out of business&#39;</span><span class="p">,</span> <span class="s1">&#39;business not located&#39;</span><span class="p">)</span>
                <span class="k">then</span> <span class="nb">date</span>
                <span class="k">else</span> <span class="k">NULL</span>
                <span class="k">end</span><span class="p">)</span>
            <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">end_time</span>
        <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
        <span class="k">order</span> <span class="k">by</span>
            <span class="n">license_num</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_aka</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_type</span> <span class="k">asc</span><span class="p">,</span> <span class="n">address</span> <span class="k">asc</span><span class="p">,</span>
            <span class="nb">date</span> <span class="k">asc</span> <span class="c1">-- IMPORTANT!!</span>
            <span class="p">)</span>

    <span class="k">select</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">start_time</span> <span class="k">asc</span><span class="p">,</span> <span class="n">license_num</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_aka</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_type</span> <span class="k">asc</span><span class="p">,</span> <span class="n">address</span> <span class="k">asc</span> <span class="p">)</span> <span class="k">as</span> <span class="n">entity_id</span><span class="p">,</span>
        <span class="n">license_num</span><span class="p">,</span>
        <span class="n">facility</span><span class="p">,</span>
        <span class="n">facility_aka</span><span class="p">,</span>
        <span class="n">facility_type</span><span class="p">,</span>
        <span class="n">address</span><span class="p">,</span>
        <span class="n">zip_code</span><span class="p">,</span>
        <span class="k">location</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">,</span>
        <span class="n">end_time</span><span class="p">,</span>
        <span class="n">daterange</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">activity_period</span>
    <span class="k">from</span> <span class="n">entities</span>
        <span class="p">);</span>
</pre></div>

<p>Note that we added a <em>unique</em> identifier (<code>entity_id</code>) to this table. This identifier was assigned using a PostgreSQL idiom: <code>distinct on()</code>. <code>DISTINCT ON</code> keeps the "first" row of each group. If you are interested in this powerful technique see this <a href="http://www.postgresqltutorial.com/postgresql-select-distinct/">blogpost</a>.</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">entity_id</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">entities</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>entities</th>
</tr>
</thead>
<tbody>
<tr>
<td>36,910</td>
</tr>
</tbody>
</table>
<p>We will add some indexes to this table<sup><a id="fnr.25" class="footref" href="#fn.25">25</a></sup>:</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">index</span> <span class="n">entities_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">entity_id</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_license_num_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">license_num</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_facility_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">facility</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_facility_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">facility_type</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_zip_code_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">zip_code</span><span class="p">);</span>

<span class="c1">-- Spatial index</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_location_gix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">using</span> <span class="n">gist</span> <span class="p">(</span><span class="k">location</span><span class="p">);</span>

<span class="k">create</span> <span class="k">index</span> <span class="n">entities_full_key_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</pre></div>

<h4>Events table</h4>
<p>We are ready to create the events table. This table will describe the inspection, like the <em>type</em> of inspection, <em>when</em> and <em>where</em> the inspection happened, and the inspection <em>result</em>. We will add the violations as a <code>JSONB</code> column.<sup><a id="fnr.26" class="footref" href="#fn.26">26</a></sup> Finally, we'll rename <code>inspection</code> as <code>event_id</code>.<sup><a id="fnr.27" class="footref" href="#fn.27">27</a></sup></p>
<div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">as</span> <span class="p">(</span>

        <span class="k">with</span> <span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span>
            <span class="p">),</span>

        <span class="n">inspections</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span>
            <span class="n">i</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_aka</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
            <span class="n">jsonb_agg</span><span class="p">(</span>
                <span class="n">jsonb_build_object</span><span class="p">(</span>
                    <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">severity</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="k">comment</span>
                <span class="p">)</span>
            <span class="k">order</span>  <span class="k">by</span> <span class="n">code</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
        <span class="k">from</span>
            <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">as</span> <span class="n">i</span>
            <span class="k">inner</span> <span class="k">join</span>
            <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="n">v</span>
            <span class="k">on</span> <span class="n">i</span><span class="p">.</span><span class="n">inspection</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">inspection</span>
        <span class="k">group</span> <span class="k">by</span>
            <span class="n">i</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="n">facility_aka</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span>
            <span class="p">)</span>

    <span class="k">select</span>
        <span class="n">i</span><span class="p">.</span><span class="n">inspection</span> <span class="k">as</span> <span class="n">event_id</span><span class="p">,</span>
        <span class="n">e</span><span class="p">.</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span><span class="p">,</span>
        <span class="n">e</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
        <span class="n">i</span><span class="p">.</span><span class="n">violations</span>
    <span class="k">from</span>
        <span class="n">entities</span> <span class="k">as</span> <span class="n">e</span>
        <span class="k">inner</span> <span class="k">join</span>
        <span class="n">inspections</span> <span class="k">as</span> <span class="n">i</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">zip_code</span><span class="p">)</span>
        <span class="p">);</span>

<span class="c1">-- Add some indices</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_entity_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">entity_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_event_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">event_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="k">type</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_date_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span><span class="p">(</span><span class="nb">date</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_facility_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>  <span class="p">(</span><span class="n">facility_type</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_zip_code_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>  <span class="p">(</span><span class="n">zip_code</span><span class="p">);</span>

<span class="c1">-- Spatial index</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_location_gix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gist</span> <span class="p">(</span><span class="k">location</span><span class="p">);</span>

<span class="c1">-- JSONB indices</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_violations</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gin</span><span class="p">(</span><span class="n">violations</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_violations_json_path</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gin</span><span class="p">(</span><span class="n">violations</span> <span class="n">jsonb_path_ops</span><span class="p">);</span>

<span class="k">create</span> <span class="k">index</span> <span class="n">events_event_entity_zip_code_date</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">event_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">,</span> <span class="n">entity_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">,</span> <span class="n">zip_code</span><span class="p">,</span> <span class="nb">date</span> <span class="k">desc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
</pre></div>

<p>Success! We have one row per event.<sup><a id="fnr.28" class="footref" href="#fn.28">28</a></sup> Our semantic data looks like:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">event_id</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="k">type</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">risk</span><span class="p">,</span>
    <span class="k">result</span><span class="p">,</span>
    <span class="n">facility_type</span><span class="p">,</span>
    <span class="n">zip_code</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>event<sub>id</sub></th>
<th>entity<sub>id</sub></th>
<th>type</th>
<th>date</th>
<th>risk</th>
<th>result</th>
<th>facility<sub>type</sub></th>
<th>zip<sub>code</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>1343315</td>
<td>22053</td>
<td>canvass</td>
<td>2013-06-06</td>
<td>low</td>
<td>fail</td>
<td>newsstand</td>
<td>60623</td>
</tr>
</tbody>
</table>
<p>We omitted <code>violations</code> and <code>location</code> for brevity. The total number of inspections is</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">events</span>
<span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>events</th>
</tr>
</thead>
<tbody>
<tr>
<td>156,682</td>
</tr>
</tbody>
</table>
<p>Now that we have our data in a good shape, we are ready to use <strong>Triage</strong>.</p>
<h3>Let's EDA &#x2026;</h3>
<p>It is always a good idea to do some <em>Exploratory Data Analysis<sup><a id="fnr.29" class="footref" href="#fn.29">29</a></sup></em> or <strong>EDA</strong> for short. This will help us to learn more about the dynamics of the entities or the inspections.</p>
<p>We will generate a few plots, just to know:</p>
<ul>
<li>how many entities/events are every month?</li>
<li>how many entities/events ended in a failed state every month? and,</li>
<li>how many entities/events have in a critical violation in a failed inspection?</li>
</ul>
<h4>Inspections over time</h4>
<p>First, we will try the answer the question: <em>how many inspections are realized every month?</em></p>
<p><img alt="img" src="images/inspections_over_time.png" title="Number of inspections per month across our whole dataset" /></p>
<h4>Number of facilities <em>inspected</em> over time</h4>
<p>The previous plot was about the number of <em>events</em> every month, now we will plot how many <em>entities</em> are acted every month.</p>
<p>One question, that is useful to answer is: Are there facilities that are inspected more than once in a month?</p>
<blockquote>
<p>We are doing an emphasis in <em>inspected</em> since our data set doesn't contain <strong>all</strong> the facilities in Chicago. This will have an effect on the modeling stage.</p>
</blockquote>
<p><img alt="img" src="images/facilities_inspected_over_time.png" title="Number of unique facilities inspected every month." /></p>
<h4>Number of failed inspections over time</h4>
<p>What is the proportion of inspections every month that actually end in a failed inspection?</p>
<p><img alt="img" src="images/failed_inspections_over_time.png" title="Number of failed inspections every month." /></p>
<h4>Number of facilities with failed inspections over time</h4>
<p>Now let's see the behavior of the <em>outcomes</em> of the inspection across time. First just if the inspection failed.</p>
<p><img alt="img" src="images/facilities_with_inspections_failed_over_time.png" title="Number of unique facilities with failed inspections every month." /></p>
<h4>Number of severe violations found in a failed inspection over time</h4>
<p>Finally let's analyze the evolution of failed inspections with severe violations (violation code in 15-29)</p>
<p><img alt="img" src="images/failed_inspections_severe_violations_over_time.png" title="Number of failed inspection with critical violation found" /></p>
<h4>Number of facilities with severe violations found in a failed inspection over time</h4>
<p><img alt="img" src="images/facilities_with_failed_inspections_severe_violations_over_time.png" title="Number of facilities which failed inspections with severe violations." /></p>
<p>This few plots give us a sense of how the data behaves and will help us in detect weird bugs or model-behavior later.</p>
<h2>Triage</h2>
<p>Predictive analytics projects require coordinating many tasks, such as feature generation, classifier training, evaluation, and list generation. Each of these tasks is complicated in its own right, but it also needs to be combined with the other tasks throughout the course of the project.</p>
<p>DSaPP built <code>triage</code> to facilitate the creation of supervised learning models, in particular <em>binary</em> classification models with a strong temporal component in the data.</p>
<p>The dataset's temporal component mainly affects two modeling steps: <em>feature creation</em> (you need to be careful to avoid <em>leaking</em> information from the future through your <em>features</em>) and hyperparameter selection. <code>triage</code> solves both by splitting the data into temporal blocks and automating temporal cross-validation (TCC) and the feature generation.</p>
<p><code>triage</code> uses the concept of an <em>experiment</em>. An <em>experiment</em> consists of a series of steps that aim to generate a good model for predicting the <em>label</em> of an entity in the data set. The steps are <em>data time-splitting</em>, <em>label generation</em>, <em>feature generation</em>, <em>matrix creation</em>, <em>model training</em>, <em>predictions</em>, and <em>model evaluation</em>. In each of these steps, <code>triage</code> will handle the temporal nuances of the data.</p>
<p>Nowadays <code>triage</code> will help you to select the best model (<em>model selection</em>) and it allows you to explore and understand the behavior of your models using <strong>post-modeling</strong> techniques.</p>
<p>You need to specify (via a configuration file) how you want to split your data temporally, which combination of machine learning algorithms and their hyperparameters you'd like to use, which kinds of features you want to generate, which subsets of those features you want to try in each model, and which metrics you'd like to use to evaluate performance and provide some criteria to select the best model.</p>
<p>An <strong>experiment run</strong> consists in fitting every combination of algorithm, hyperparameters, and feature subsets to the temporally split data and evaluating their predictive performance on future data splits using the user's metrics.</p>
<p><code>triage</code> calls a unique combination of algorithm, hyperparameters, and feature subsets a <code>model_group</code> and a model group fit to a specific data matrix a <code>model</code>. Our data typically span multiple time periods, so triage fits multiple models for each model group.</p>
<p><code>triage</code> is simple to use, but it contains a lot of complex concepts that we will try to clarify in this section. First we will explain <em>how</em> to run <code>triage</code>, and then we will create a toy experiment that helps explain triage's main concepts.</p>
<h3>Triage interface</h3>
<p>To run a <code>triage</code> experiment, you need the following:</p>
<ul>
<li>
<p>A database with the data that you want to model.</p>
<ul>
<li>In this tutorial, the credentials are part of the <code>DATABASE_URL</code> environment variable</li>
</ul>
</li>
<li>
<p><code>triage</code> installed in your environment. You can verify that <code>triage</code> is indeed installed if you type in <code>bastion</code>:</p>
</li>
</ul>
<div class="highlight"><pre><span></span>triage -h
</pre></div>

<ul>
<li>An <em>experiment config file</em>. This is where the magic happens. We will discuss this file at length in this section of the tutorial.</li>
</ul>
<p>We are providing a <code>docker</code> container, <code>bastion</code>, that executes <code>triage</code> experiments. You already had the database (you were working on it the last two sections of this tutorial, remember?). So, like a real project, you just need to worry about the <em>experiment configuration file</em>.</p>
<p>In the following section of the tutorial we will use a small experiment configuration file located at &lt;../triage/experiments/simple_test_skeleton.yaml&gt;.</p>
<p>We will show you how to setup the experiment while explaining the inner workings of <code>triage</code>. We will modify the configuration file to show the effects of the configuration parameters. If you want to follow along, we suggest you copy that file and modify by yourself.</p>
<p>You can run that experiment with:</p>
<div class="codehilite"><pre><span></span># Remember to run this in bastion NOT in your laptop!
triage experiment --matrix-format hdf experiments/simple_test_skeleton.yaml
</pre></div>


<p>Every time you modify the configuration file and see the effects, you should execute the experiment again using the previous command.</p>
<h3>A simple <code>triage</code> experiment</h3>
<h4>A brief recap of Machine Learning</h4>
<p><strong>Triage</strong> helps you to run a <em>Machine learning</em> experiment. An experiment in this context means the use of Machine Learning to explore a dynamic system in order to do some predictions about it.</p>
<p>Before execute the <em>any</em> ML experiment, you need to define some <em>boundaries</em>:</p>
<ul>
<li>Which are the entities that you want to study?</li>
<li>What will you want to know about them?</li>
</ul>
<p>In DSaPP, we build ML systems that aim to have social impact, i.e. help government offices, NGOs or other agents to do their job better. "Do their job better" means increase their reach (e.g. identify correctly more entities with some characteristics) using more efficiently their (scarce) resources (e.g. inspectors, medics, money, etc).</p>
<p>With this optic, the <em>boundaries</em> are:</p>
<ul>
<li><strong>Cohort:</strong> Which are the entities that you want to reach?</li>
<li><strong>Label:</strong> What will you want to know about them?</li>
<li><strong>Label timespan:</strong> In what time period?</li>
<li><strong>Update frequency:</strong> How frequently do you want to intervene?</li>
<li><strong>List size:</strong> How many resources do you have to intervene?</li>
</ul>
<p>Triage's experiment configuration file structures this information.</p>
<p><a id="orgd27c756"></a></p>
<h4>Cohorts, labels, event dates and as of dates</h4>
<p>We will use the <em>inspections prioritization</em> as a narrative to help clarify these concepts:</p>
<ul>
<li><strong><em>Which are the entities that you want to reach?</em>:</strong> Active facilities, i.e. facilities that exists at the day of the <em>planning</em> inspections. We don't want to waste city resources (inspectors time) going to facilities that are out of business.</li>
<li><strong>What will you want to know about them?:</strong> Will those facilities fail the inspection?</li>
<li><strong>In what time period?:</strong> Will those facilities fail the inspection in the following month?</li>
<li><strong>How frequently do you want to intervene?:</strong> Every month.</li>
<li><strong>How many resources do you have to intervene?:</strong> We only have one inspector, so, one inspection per month</li>
</ul>
<p>To exemplify and explain the inner workings of <code>triage</code> in this scenario, we will use a subset of the <code>semantic.events</code> table with the following facilities (i.e. imagine that Chicago only has this three facilities):</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="n">license_num</span><span class="p">,</span>
    <span class="n">facility_aka</span><span class="p">,</span>
    <span class="n">facility_type</span><span class="p">,</span>
    <span class="n">activity_period</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span>
<span class="k">where</span>
    <span class="n">license_num</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1596210</span><span class="p">,</span> <span class="mi">1874347</span><span class="p">,</span> <span class="mi">1142451</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">entity_id</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>entity<sub>id</sub></th>
<th>license<sub>num</sub></th>
<th>facility<sub>aka</sub></th>
<th>facility<sub>type</sub></th>
<th>activity<sub>period</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>229</td>
<td>1596210</td>
<td>food 4 less</td>
<td>grocery store</td>
<td>[2010-01-08,)</td>
</tr>
<tr>
<td>355</td>
<td>1874347</td>
<td>mcdonalds</td>
<td>restaurant</td>
<td>[2010-01-12,2017-11-09)</td>
</tr>
<tr>
<td>840</td>
<td>1142451</td>
<td>jewel foodstore # 3345</td>
<td>grocery store</td>
<td>[2010-01-26,)</td>
</tr>
</tbody>
</table>
<p>The first thing <code>triage</code> does when executes the experiment, is split the time that the data covers in blocks considering the time horizon for the <em>label</em> ( <em>Which facilities will fail an inspection in the following month?</em> in this scenario of <strong>inspection prioritization<sup><a id="fnr.30" class="footref" href="#fn.30">30</a></sup></strong>) . This time horizon is calculated from a set of specific dates (<code>as_of_date</code> in triage parlance) that divide the blocks in past (for training the model) and future (for testing the model). The set of <code>as_of_dates</code> is (<em>mainly</em>) calculated from the <em>label timespan</em> and the <em>update frequency</em><sup><a id="fnr.31" class="footref" href="#fn.31">31</a></sup>. The <em>as of date</em> is not the <em>event date</em>. The <em>event date</em> occurred <em>when</em> the facility was inspected. The <em>as of date</em> is when the planning of the future facilities to be inspected happens.</p>
<p><code>triage</code> will create those <em>labels</em> using information about the <em>outcome</em> of the event<sup><a id="fnr.32" class="footref" href="#fn.32">32</a></sup>, taking into account the temporal structure of the data. In our example: if a facility is inspected is an event, and whether it fails the inspection (outcome <em>true</em>) or not (outcome <em>false</em>).</p>
<p>For a given entity on a given <em>as of date</em>, <code>triage</code> asks whether there's an outcome in the future time horizon. If so, <code>triage</code> will generate a <em>label</em> for that specific entity on that <em>as of date</em>.</p>
<p>For this example, the <em>label</em> will be if given an <em>as of date</em> (e.g. January first, 2014), the facility will have a failed inspection in the following year.</p>
<p>The following example hopefully will clarify the difference between <em>outcome</em> and <em>label</em>. We will focus on events (inspections) that happened in the year of 2014.</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="p">(</span><span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outcome</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
<span class="k">where</span>
    <span class="s1">&#39;[2014-01-01, 2015-01-01]&#39;</span><span class="p">::</span><span class="n">daterange</span> <span class="o">@&gt;</span> <span class="nb">date</span>
    <span class="k">and</span>
    <span class="n">entity_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">229</span><span class="p">,</span><span class="mi">355</span><span class="p">,</span><span class="mi">840</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="nb">date</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>date</th>
<th>entity<sub>id</sub></th>
<th>outcome</th>
</tr>
</thead>
<tbody>
<tr>
<td>2014-01-14</td>
<td>840</td>
<td>f</td>
</tr>
<tr>
<td>2014-02-04</td>
<td>229</td>
<td>f</td>
</tr>
<tr>
<td>2014-02-24</td>
<td>840</td>
<td>t</td>
</tr>
<tr>
<td>2014-03-05</td>
<td>840</td>
<td>f</td>
</tr>
<tr>
<td>2014-04-10</td>
<td>355</td>
<td>t</td>
</tr>
<tr>
<td>2014-04-15</td>
<td>229</td>
<td>f</td>
</tr>
<tr>
<td>2014-04-18</td>
<td>355</td>
<td>f</td>
</tr>
<tr>
<td>2014-05-06</td>
<td>840</td>
<td>f</td>
</tr>
<tr>
<td>2014-08-28</td>
<td>355</td>
<td>f</td>
</tr>
<tr>
<td>2014-09-19</td>
<td>229</td>
<td>f</td>
</tr>
<tr>
<td>2014-09-30</td>
<td>355</td>
<td>t</td>
</tr>
<tr>
<td>2014-10-10</td>
<td>355</td>
<td>f</td>
</tr>
<tr>
<td>2014-10-31</td>
<td>840</td>
<td>f</td>
</tr>
</tbody>
</table>
<p>We can observe that the facilities had several inspections, but in that timeframe <code>362</code> y <code>859</code> had failed inspections.</p>
<p>Continuing the narrative, from the perspective of the day of <code>2014-01-01</code> (<em>as of date</em>), those facilities will have positive <em>label</em>.</p>
<p>We can express that in a query and getting the <em>labels</em> for that <em>as of date</em> :</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="s1">&#39;2014-01-01&#39;</span> <span class="k">as</span> <span class="n">as_of_date</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="n">bool_or</span><span class="p">(</span><span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">)::</span><span class="nb">integer</span> <span class="k">as</span> <span class="n">label</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
<span class="k">where</span>
    <span class="s1">&#39;2014-01-01&#39;</span><span class="p">::</span><span class="k">timestamp</span> <span class="o">&lt;=</span> <span class="nb">date</span>
    <span class="k">and</span> <span class="nb">date</span> <span class="o">&lt;</span> <span class="s1">&#39;2014-01-01&#39;</span><span class="p">::</span><span class="k">timestamp</span> <span class="o">+</span> <span class="nb">interval</span> <span class="s1">&#39;1 year&#39;</span>
    <span class="k">and</span> <span class="n">entity_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">229</span><span class="p">,</span><span class="mi">355</span><span class="p">,</span><span class="mi">840</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">entity_id</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>as<sub>of</sub><sub>date</sub></th>
<th>entity<sub>id</sub></th>
<th>label</th>
</tr>
</thead>
<tbody>
<tr>
<td>2014-01-01</td>
<td>229</td>
<td>0</td>
</tr>
<tr>
<td>2014-01-01</td>
<td>355</td>
<td>1</td>
</tr>
<tr>
<td>2014-01-01</td>
<td>840</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Note that ee transform the <em>label</em> to integer, since the machine learning algorithms only work with numeric data.</p>
<p>We also need a way to store the <em>state</em> of each entity. We can group entities in <em>cohorts</em> defined by the state. The <em>cohort</em> can be used to decide which facilities you want to predict on (i.e. include in the ML train/test matrices). The rationale of this comes from the need to only predict for entities in a particular state: <em>Is the restaurant new?</em> <em>Is this facility on this zip code</em>? <em>Is the facility "active"?</em><sup><a id="fnr.33" class="footref" href="#fn.33">33</a></sup></p>
<p>We will consider a facility as <strong>active</strong> if a given <em>as of date</em> is in the interval defined by the <code>start_date</code> and <code>end_date</code>.</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="s1">&#39;2018-01-01&#39;</span><span class="p">::</span><span class="nb">date</span> <span class="k">as</span> <span class="n">as_of_date</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="n">activity_period</span><span class="p">,</span>
<span class="k">case</span> <span class="k">when</span>
<span class="n">activity_period</span> <span class="o">@&gt;</span> <span class="s1">&#39;2018-01-01&#39;</span><span class="p">::</span><span class="nb">date</span> <span class="c1">-- 2018-01-01 is as of date</span>
<span class="k">then</span> <span class="s1">&#39;active&#39;</span><span class="p">::</span><span class="nb">text</span>
<span class="k">else</span> <span class="s1">&#39;inactive&#39;</span><span class="p">::</span><span class="nb">text</span>
<span class="k">end</span> <span class="k">as</span> <span class="k">state</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span>
<span class="k">where</span>
    <span class="n">entity_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">229</span><span class="p">,</span><span class="mi">355</span><span class="p">,</span><span class="mi">840</span><span class="p">);</span>
</pre></div>

<table>
<thead>
<tr>
<th>as<sub>of</sub><sub>date</sub></th>
<th>entity<sub>id</sub></th>
<th>activity<sub>period</sub></th>
<th>state</th>
</tr>
</thead>
<tbody>
<tr>
<td>2018-01-01</td>
<td>229</td>
<td>[2010-01-08,)</td>
<td>active</td>
</tr>
<tr>
<td>2018-01-01</td>
<td>355</td>
<td>[2010-01-12,2017-11-09)</td>
<td>inactive</td>
</tr>
<tr>
<td>2018-01-01</td>
<td>840</td>
<td>[2010-01-26,)</td>
<td>active</td>
</tr>
</tbody>
</table>
<p><code>Triage</code> will use a simple modification of the queries that we just discussed for automate the generation of the <em>cohorts</em> and <em>labels</em> for our experiment.</p>
<h3>Experiment configuration file</h3>
<p>The <em>experiment configuration file</em> is used to create the <code>experiment</code> object. Here, you will specify the temporal configuration, the features to be generated, the labels to learn, and the models that you want to train in your data.</p>
<p>The configuration file is a <code>yaml</code> file with the following main sections:</p>
<ul>
<li>
<p><strong><a href="#org176be7c"><code>temporal_config</code></a>:</strong> Temporal specification of the data, used for creating the blocks for temporal crossvalidation.</p>
</li>
<li>
<p><strong><code>cohort_config</code>:</strong> Using the state of the entities, define (using <code>sql</code>) <em>cohorts</em> to filter out objects that shouldn't be included in the training and prediction stages. This will generate a table call <code>cohort_{experiment_hash}</code></p>
</li>
<li>
<p><strong><code>label_config</code>:</strong> Specify (using <code>sql</code>) how to generate <em>labels</em> from the event's <em>outcome</em>. A table named <code>labels_{experiment_hash}</code> will be created.</p>
</li>
<li>
<p><strong><a href="#org8ed59f5"><code>feature_aggregation</code></a>:</strong> Which spatio-temporal aggregations of the columns in the data set do you want to generate as features for the models?</p>
</li>
<li>
<p><strong><code>model_group_keys</code>:</strong> How do you want to identify the <code>model_group</code> in the database (so you can run analysis on them)?</p>
</li>
<li>
<p><strong><a href="#org2a31032"><code>grid_config</code></a>:</strong> Which combination of hyperparameters and algorithms will be trained and evaluated in the data set?</p>
</li>
<li>
<p><strong><code>scoring</code>:</strong> Which metrics will be calculated?</p>
</li>
</ul>
<p>Two of the more important (and potentially confusing) sections are <code>temporal_config</code> and <code>feature_generation</code>. We will explain them in detail in the next sections.</p>
<p><a id="org176be7c"></a></p>
<h3>Temporal crossvalidation</h3>
<p>Cross validation is a common technique to select a model that generalizes well to new data. Standard cross validation randomly splits the training data into subsets, fits models on all but one, and calculates the metric of interest (e.g. precision/recall) on the one left out, rotating through the subsets and leaving each out once. You select the model that performed best across the left-out sets, and then retrain it on the complete training data.</p>
<p>Unfortunately, standard cross validation is inappropriate for most real-world data science problems. If your data have temporal correlations, standard cross validation lets the model peek into the future, training on some future observations and testing on past observations. To avoid this problem, you should design your training and testing to mimic how your model will be used, making predictions only using the data that would be available at that time (i.e. from the past).</p>
<p>In temporal crossvalidation, rather than randomly splitting the dataset into training and test splits, temporal cross validation splits the data by time.</p>
<p><code>triage</code> uses the <code>timechop</code> library for this purpose. <code>Timechop</code> will "chop" the data set in several temporal blocks. These blocks are then used for creating the features and matrices for training and evaluation of the machine learning models.</p>
<p>Assume we want to select which restaurant (of two in our example dataset) we should inspect next year based on its higher risk of violating some condition. Also assume that the process of picking which facility is repeated every year on January 1st<sup><a id="fnr.34" class="footref" href="#fn.34">34</a></sup></p>
<p>Following the problem description template given in Section <strong>Description of the problem to solve</strong>, the question that we'll attempt to answer is:</p>
<blockquote>
<p>Which facility ( <span><span class="MathJax_Preview">n=1</span><script type="math/tex">n=1</script></span> ) is likely to violate some inspected condition in the following year ( <span><span class="MathJax_Preview">X=1</span><script type="math/tex">X=1</script></span> )?</p>
</blockquote>
<p>The traditional approach in machine learning is splitting the data in training and test datasets. Train or fit the algorithm on the training data set to generate a train model and test or evaluate the model on the test data set. We will do the same here, but, with the help of <code>timechop</code> we will take in account the time:</p>
<p>We will fit models on training set up to 2014-01-01 and see how well those models would have predicted 2015; fit more models on training set up to 2015-01-01 and see how well those models would have predicted 2016; and so on. That way, we choose models that have historically performed best at our task, forecasting. It’s why this approach is sometimes called <em>evaluation on a rolling forecast origin</em> because the origin at which the prediction is made rolls forward in time. <sup><a id="fnr.35" class="footref" href="#fn.35">35</a></sup></p>
<p><img alt="img" src="images/rolling-origin.png" title="Cartoonish view of temporal splitting for Machine Learning, each point represents an *as of date*, the orange area are the past of that *as of date* and is used for feature generation. The blue area is the label span, it lies in the future of the *as of date*." /></p>
<p>The data at which the model will do the predictions is denominated as <em>as of date</em> in <code>triage</code> (<em>as of date</em> = January first in our example). The length of the prediction time window (1 year) is called <em>label span</em>. Training and predicting with a new model <em>as of date</em> (every year) is the <em>model update frequency</em>.</p>
<p>Because it's inefficient to calculate by hand all the <em>as of dates</em> or prediction points, <code>timechop</code> will take care of that for us. To do so, we need to specify some more constraints besides the <em>label span</em> and the <em>model update frequency</em>:</p>
<ul>
<li>What is the date range covered by our data?</li>
<li>What is the date range in which we have information about labels?</li>
<li>How frequently do you receive information about your entities?</li>
<li>How far in the future you want to predict?</li>
<li>How much of the past data do you want to use?</li>
</ul>
<p>With this information, <code>timechop</code> will calculate as-of train and test dates from the last date in which you have label data, using the label span in both test and train sets, plus the constraints just mentioned.</p>
<p>In total <code>timechop</code> uses 11 configuration parameters<sup><a id="fnr.36" class="footref" href="#fn.36">36</a></sup>.</p>
<ul>
<li>
<p>There are parameters related to the boundaries of the available data set:</p>
<ul>
<li><strong><code>feature_start_time</code>:</strong> data aggregated into features begins at this point (earliest date included in features)</li>
<li><strong><code>feature_end_time</code>:</strong> data aggregated into features is from before this point (latest date included in features)</li>
<li><strong><code>label_start_time</code>:</strong> data aggregated into labels begins at this point (earliest event date included in any label (event date &gt;= label<sub>start</sub><sub>time</sub>)</li>
<li><strong><code>label_end_time</code>:</strong> data aggregated is from before this point (event date &lt; label<sub>end</sub><sub>time</sub> to be included in any label)</li>
</ul>
</li>
<li>
<p>Parameters that control the <em>labels</em>' time horizon on the train and test sets:</p>
<ul>
<li>
<p><strong><code>training_label_timespans</code>:</strong> how much time is covered by training labels (e.g., outcomes in the next 3 days? 2 months? 1 year?) (training prediction span)</p>
</li>
<li>
<p><strong><code>test_label_timespans</code>:</strong> how much time is covered by test prediction (e.g., outcomes in the next 3 days? 2 months? 1 year?) (test prediction span)</p>
</li>
</ul>
<p>These parameters will be used with the <em>outcomes</em> table to generate the <em>labels</em>. In an <strong>early warning</strong> setting, they will often have the same value. For <strong>inspections prioritization</strong>, this value typically equals <code>test_durations</code> and <code>model_update_frequency</code>.</p>
</li>
<li>
<p>Parameters related about how much data we want to use, both in the future and in the past relative to the <em>as-of date</em>:</p>
<ul>
<li>
<p><strong><code>test_durations</code>:</strong> how far into the future should a model be used to make predictions (test span)</p>
<p><strong>NOTE</strong>: in the typical case of wanting a single prediction set immediately after model training, this should be set to 0 days</p>
</li>
</ul>
<p>For early warning problems, <code>test_durations</code> should equal <code>model_update_frequency</code>. For inspection prioritization, organizational process determines the value: <em>how far out are you scheduling for?</em></p>
<p>The equivalent of <code>test_durations</code> for the training matrices is <code>max_training_histories</code>:</p>
<ul>
<li><strong><code>max_training_histories</code>:</strong> the maximum amount of history for each entity to train on (early matrices may contain less than this time if it goes past label/feature start times). If patterns have changed significantly, models trained on recent data may outperform models trained on a much lengthier history.</li>
</ul>
</li>
<li>
<p>Finally, we should specify how many rows per <code>entity_id</code> in the train and test matrix:</p>
<ul>
<li>
<p><strong><code>training_as_of_date_frequencies</code>:</strong> how much time between rows for a single entity in a training matrix (list time between rows for same entity in train matrix).</p>
</li>
<li>
<p><strong><code>test_as_of_date_frequencies</code>:</strong> how much time between rows for a single entity in a test matrix (time between rows for same entity in test matrix).</p>
</li>
</ul>
</li>
</ul>
<p>The following images (we will show how to generate them later) shows the time blocks created by several temporal configurations. We will change a parameter at a time so you could see how it affects the resulting blocks.</p>
<p>If you want to try the modifications (or your own) and generate the temporal blocks images run the following (they'll be generated in &lt;./images/&gt;):</p>
<div class="codehilite"><pre><span></span># Remember to run this in bastion NOT in laptop&#39;s shell!
triage experiment experiments/simple_test_skeleton.yaml --show-timechop
</pre></div>


<ul>
<li>
<p><code>{feature, label}_{end, start}_time</code></p>
<p>The image below shows these <code>{feature, label}_start_time</code> are equal, as are the <code>{feature, label}_end_time</code>. These parameters show in the image as dashed vertical black lines. This setup will be our <strong>baseline</strong> example.</p>
<p>The plot is divided in two horizontal lines ("Block 0" and "Block 1"). Each line is divided by vertical dashed lines &#x2013; the grey lines outline the boundaries of the data for features and data for labels, which in this image coincide. The black dash lines represent the beginning and the end of the test set. In "Block 0" those lines correspond to <code>2017</code> and <code>2018</code>, and in "Block 1" they correspond to <code>2016</code> and <code>2017</code>.</p>
<p><img alt="img" src="images/timechop_1.png" title="feature and label start, end time equal" /></p>
<p>The shaded areas (in this image there is just one per block, but you will see other examples below) represents the span of the <em>as of dates</em>. They start with the oldest <em>as of date</em> and end with the latest. Each line inside that area represents the label span. Those lines begin at the <em>as of date</em>. At each <em>as of date</em>, timechop generates each entity's features (from the past) and labels (from the future). So in the image, we will have two sets of train/test datasets. Each facility will have 13 rows in "Block 0" and 12 rows in "Block 1". The trained models will predict the label using the features calculated for that test set <em>as of date</em>. The single line represents the label's time horizon in testing.</p>
<p>This is the temporal configuration that generated the previous image:</p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;1y&#39;
</pre></div>


<p>In that configuration the date ranges of features and labels are equal, but they can be different (maybe you have more data for features that data for labels) as is shown in the following image and in their configuration parameters.</p>
<p><img alt="img" src="images/timechop_2.png" title="feature&lt;sub&gt;start&lt;/sub&gt;&lt;sub&gt;time&lt;/sub&gt; different different that label&lt;sub&gt;start&lt;/sub&gt;&lt;sub&gt;time&lt;/sub&gt;." /></p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2010-01-01&#39;   # &lt;------- The change happened here!
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;1y&#39;
</pre></div>


</li>
<li>
<p><code>model_update_frequency</code></p>
<p>From our <strong>baseline</strong> <code>temporal_config</code> example (<a href="#org2052acb">302</a>), we will change how often we want a new model, which generates more time blocks (if there are time-constrained data, obviously).</p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;6month&#39; # &lt;------- The change happened here!
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;1y&#39;
</pre></div>


<p><img alt="img" src="images/timechop_3.png" title="A smaller model&lt;sub&gt;update&lt;/sub&gt;&lt;sub&gt;frequency&lt;/sub&gt; (from 1y to 6month) (The number of blocks grew)" /></p>
</li>
<li>
<p><code>max_training_histories</code></p>
<p>With this parameter you could get a <em>growing window</em> for training (depicted in <a href="#org86370b8">310</a>) or as in all the other examples, <em>fixed training windows</em>.</p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;10y&#39;  # &lt;------- The change happened here!
</pre></div>


<p><img alt="img" src="images/timechop_4.png" title="The size of the block is bigger now" /></p>
</li>
<li>
<p><code>_as_of_date_frequencies</code> and <code>test_durations</code></p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;3month&#39; # &lt;------- The change happened here!

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;10y&#39;
</pre></div>


<p><img alt="img" src="images/timechop_5.png" title="Less rows per entity in the training block" /></p>
<p>Now, change <code>test_as_of_date_frequencies</code>:</p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;3month&#39;&lt;------- The change happened here!

    max_training_histories: &#39;10y&#39;
</pre></div>


<p><img alt="img" src="images/timechop_6.png" title="We should get more rows per entity in the test matrix, but that didn't happen. Why?" /></p>
<p>Nothing changed because the test set doesn't have "space" to allow more spans. The "space" is controlled by <code>test_durations</code>, so let's change it to <code>6month</code>:</p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;6month&#39; &lt;------- The change happened here!
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;10y&#39;
</pre></div>


<p><img alt="img" src="images/timechop_7.png" title="The test duration is bigger now, so we got 6 rows (since the &quot;base&quot; frequency is 1 month)" /></p>
<p>So, now we will move both parameters: <code>test_durations</code>, <code>test_as_of_date_frequencies</code></p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;6month&#39; &lt;------- The change happened here!
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;3month&#39; &lt;------- and also here!

    max_training_histories: &#39;10y&#39;
</pre></div>


<p><img alt="img" src="images/timechop_8.png" title="With more room in testing, now test&lt;sub&gt;as&lt;/sub&gt;&lt;sub&gt;of&lt;/sub&gt;&lt;sub&gt;date&lt;/sub&gt;&lt;sub&gt;frequencies&lt;/sub&gt; has some effect." /></p>
</li>
<li>
<p><code>_label_timespans</code></p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;1y&#39;]
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;3month&#39;]  &lt;------- The change happened here!
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;10y&#39;
</pre></div>


<p><img alt="img" src="images/timechop_9.png" title="The label time horizon in the test dataset now is smaller" /></p>
<div class="codehilite"><pre><span></span>temporal_config:
    feature_start_time: &#39;2014-01-01&#39;
    feature_end_time: &#39;2018-01-01&#39;
    label_start_time: &#39;2014-01-02&#39;
    label_end_time: &#39;2018-01-01&#39;

    model_update_frequency: &#39;1y&#39;
    training_label_timespans: [&#39;3month&#39;] &lt;------- The change happened here!
    training_as_of_date_frequencies: &#39;1month&#39;

    test_durations: &#39;0d&#39;
    test_label_timespans: [&#39;1y&#39;]
    test_as_of_date_frequencies: &#39;1month&#39;

    max_training_histories: &#39;10y&#39;
</pre></div>


<p><img alt="img" src="images/timechop_10.png" title="The label time horizon is smaller in the trainning dataset. One effect is that now we have more room for more rows per entity." /></p>
<p>That's it! Now you have the power to bend time!<sup><a id="fnr.37" class="footref" href="#fn.37">37</a></sup></p>
<p>With the time blocks defined, <code>triage</code> will create the <em>labels</em> and then the features for our train and test sets. We will discuss <em>features</em> in the following section.</p>
</li>
</ul>
<p><a id="org8ed59f5"></a></p>
<h3>Feature engineering</h3>
<p>We will show how to create features using the <em>experiments config file</em>. <code>triage</code> uses <code>collate</code> for this.<sup><a id="fnr.38" class="footref" href="#fn.38">38</a></sup> The <code>collate</code> library controls the generation of features (including the imputation rules for each feature generated) using the time blocks generated by <code>timechop</code>. <code>Collate</code> helps the modeler create features based on <em>spatio-temporal aggregations</em> into the <em>as of date</em>. <code>Collate</code> generates <code>SQL</code> queries that will create <em>features</em> per each <em>as of date</em>.</p>
<p>As before, we will try to mimic what <code>triage</code> does behind the scenario. <code>Collate</code> will help you to create features based on the following template:</p>
<blockquote>
<p>For a given <em>as of date</em>, how the <em>aggregation function</em> operates into a column taking into account a previous <em>time interval</em> and some <em>attributes</em>.</p>
</blockquote>
<p>Two possible features could be framed as:</p>
<div class="codehilite"><pre><span></span>As of 2016-01-01, how many inspections
has each facility had in the previous 6 months?
</pre></div>


<p>and</p>
<div class="codehilite"><pre><span></span>As of 2016-01-01, how many &quot;high risk&quot; findings has the
facility had in the previous 6 months?
</pre></div>


<p>In our data, that date range (between 2016-01-01 and 2015-07-01) looks like:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">event_id</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="n">risk</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
<span class="k">where</span>
    <span class="nb">date</span> <span class="o">&lt;@</span> <span class="n">daterange</span><span class="p">((</span><span class="s1">&#39;2016-01-01&#39;</span><span class="p">::</span><span class="nb">date</span> <span class="o">-</span> <span class="nb">interval</span> <span class="s1">&#39;6 months&#39;</span><span class="p">)::</span><span class="nb">date</span><span class="p">,</span> <span class="s1">&#39;2016-01-01&#39;</span><span class="p">)</span>
    <span class="k">and</span> <span class="n">entity_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">229</span><span class="p">,</span><span class="mi">355</span><span class="p">,</span><span class="mi">840</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="nb">date</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>event<sub>id</sub></th>
<th>date</th>
<th>entity<sub>id</sub></th>
<th>risk</th>
</tr>
</thead>
<tbody>
<tr>
<td>1561324</td>
<td>2015-07-17</td>
<td>840</td>
<td>high</td>
</tr>
<tr>
<td>1561517</td>
<td>2015-07-24</td>
<td>840</td>
<td>high</td>
</tr>
<tr>
<td>1562122</td>
<td>2015-08-12</td>
<td>840</td>
<td>high</td>
</tr>
<tr>
<td>1547403</td>
<td>2015-08-20</td>
<td>229</td>
<td>high</td>
</tr>
<tr>
<td>1547420</td>
<td>2015-08-28</td>
<td>229</td>
<td>high</td>
</tr>
<tr>
<td>1547448</td>
<td>2015-09-14</td>
<td>355</td>
<td>medium</td>
</tr>
<tr>
<td>1547462</td>
<td>2015-09-21</td>
<td>355</td>
<td>medium</td>
</tr>
<tr>
<td>1547504</td>
<td>2015-10-09</td>
<td>355</td>
<td>medium</td>
</tr>
<tr>
<td>1547515</td>
<td>2015-10-16</td>
<td>355</td>
<td>medium</td>
</tr>
<tr>
<td>1583249</td>
<td>2015-10-21</td>
<td>840</td>
<td>high</td>
</tr>
<tr>
<td>1583577</td>
<td>2015-10-28</td>
<td>840</td>
<td>high</td>
</tr>
<tr>
<td>1583932</td>
<td>2015-11-04</td>
<td>840</td>
<td>high</td>
</tr>
</tbody>
</table>
<p>We can transform those data to two features: <code>number_of_inspections</code> and <code>flagged_as_high_risk</code>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="s1">&#39;2016-01-01&#39;</span> <span class="k">as</span> <span class="n">as_of_date</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">inspections</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">risk</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">flagged_as_high_risk</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
<span class="k">where</span>
    <span class="nb">date</span> <span class="o">&lt;@</span> <span class="n">daterange</span><span class="p">((</span><span class="s1">&#39;2016-01-01&#39;</span><span class="p">::</span><span class="nb">date</span> <span class="o">-</span> <span class="nb">interval</span> <span class="s1">&#39;6 months&#39;</span><span class="p">)::</span><span class="nb">date</span><span class="p">,</span> <span class="s1">&#39;2016-01-01&#39;</span><span class="p">)</span>
    <span class="k">and</span> <span class="n">entity_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">229</span><span class="p">,</span><span class="mi">355</span><span class="p">,</span><span class="mi">840</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">grouping</span> <span class="k">sets</span><span class="p">(</span><span class="n">entity_id</span><span class="p">);</span>
</pre></div>

<table>
<thead>
<tr>
<th>entity<sub>id</sub></th>
<th>as<sub>of</sub><sub>date</sub></th>
<th>inspections</th>
<th>flagged<sub>as</sub><sub>high</sub><sub>risk</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>229</td>
<td>2016-01-01</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>355</td>
<td>2016-01-01</td>
<td>4</td>
<td>0</td>
</tr>
<tr>
<td>840</td>
<td>2016-01-01</td>
<td>6</td>
<td>6</td>
</tr>
</tbody>
</table>
<p>This query is making an <em>aggregation</em>. Note that the previous <code>SQL</code> query has five parts:</p>
<ul>
<li>The <em>filter</em> ((<code>risk = 'high')::int</code>)</li>
<li>The <em>aggregation function</em> (<code>count()</code>)</li>
<li>The <em>name</em> of the resulting transformation (<code>flagged_as_high_risk</code>)</li>
<li>The <em>context</em> in which it is aggregated (by <code>entity_id</code>)</li>
<li>The <em>date range</em> (between 2016-01-01 and 6 months before)</li>
</ul>
<p>What about if we want to add proportions and totals of failed and passed inspections?</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="s1">&#39;2016-01-01&#39;</span> <span class="k">as</span> <span class="n">as_of_date</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">inspections</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">risk</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">flagged_as_high_risk</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span><span class="o">=</span><span class="s1">&#39;pass&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">passed_inspections</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">((</span><span class="k">result</span><span class="o">=</span><span class="s1">&#39;pass&#39;</span><span class="p">)::</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">proportion_of_passed_inspections</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">failed_inspections</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">((</span><span class="k">result</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">)::</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">proportion_of_failed_inspections</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
<span class="k">where</span>
    <span class="nb">date</span> <span class="o">&lt;@</span> <span class="n">daterange</span><span class="p">((</span><span class="s1">&#39;2016-01-01&#39;</span><span class="p">::</span><span class="nb">date</span> <span class="o">-</span> <span class="nb">interval</span> <span class="s1">&#39;6 months&#39;</span><span class="p">)::</span><span class="nb">date</span><span class="p">,</span> <span class="s1">&#39;2016-01-01&#39;</span><span class="p">)</span>
    <span class="k">and</span> <span class="n">entity_id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">229</span><span class="p">,</span><span class="mi">355</span><span class="p">,</span><span class="mi">840</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">grouping</span> <span class="k">sets</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>
</pre></div>

<table>
<thead>
<tr>
<th>entity<sub>id</sub></th>
<th>as<sub>of</sub><sub>date</sub></th>
<th>inspections</th>
<th>flagged<sub>as</sub><sub>high</sub><sub>risk</sub></th>
<th>passed<sub>inspections</sub></th>
<th>proportion<sub>of</sub><sub>passed</sub><sub>inspections</sub></th>
<th>failed<sub>inspections</sub></th>
<th>proportion<sub>of</sub><sub>failed</sub><sub>inspections</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>229</td>
<td>2016-01-01</td>
<td>2</td>
<td>2</td>
<td>1</td>
<td>0.50</td>
<td>1</td>
<td>0.50</td>
</tr>
<tr>
<td>355</td>
<td>2016-01-01</td>
<td>4</td>
<td>0</td>
<td>1</td>
<td>0.25</td>
<td>2</td>
<td>0.50</td>
</tr>
<tr>
<td>840</td>
<td>2016-01-01</td>
<td>6</td>
<td>6</td>
<td>4</td>
<td>0.67</td>
<td>2</td>
<td>0.33</td>
</tr>
</tbody>
</table>
<p>But what if we want to also add features for "medium" and "low" risk? And what would the query look like if we want to use several time intervals, like <em>3 months</em>, <em>5 years</em>, etc? What if we want to contextualize this by location? Plus we need to calculate all these features for several <em>as of dates</em> and manage the imputation strategy for all of them!!!</p>
<p>You will realize that even with this simple set of features we will require very complex <code>SQL</code> to be constructed.</p>
<p>But fear not. <code>triage</code> will automate that for us!</p>
<p>The following blocks of code represent a snippet of <code>triage</code>'s configuration file related to feature aggregation. It shows the <code>triage</code> syntax for the <code>inspections</code> feature constructed above:</p>
<div class="codehilite"><pre><span></span>feature_aggregations:
  -
    prefix: &#39;inspections&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    aggregates:
      -
        quantity:
          total: &quot;*&quot;
        imputation:
           count:
              type: &#39;zero_noflag&#39;
        metrics:
          - &#39;count&#39;

    intervals: [&#39;6month&#39;]

    groups:
        - &#39;entity_id&#39;
</pre></div>


<p><code>feature_aggregations</code> is a <code>yaml</code> list<sup><a id="fnr.39" class="footref" href="#fn.39">39</a></sup> of <em>feature groups construction specification</em> or just <em>feature group</em>. A <em>feature group</em> is a way of grouping several features that share <code>intervals</code> and <code>groups</code>. <code>triage</code> requires the following configuration parameter for every <em>feature group</em>:</p>
<ul>
<li><strong><code>prefix</code>:</strong> This will be used for name of the <em>feature</em> created</li>
<li><strong><code>from_obj</code>:</strong> Represents a <code>TABLE</code> object in <code>PostgreSQL</code>. You can pass a <em>table</em> like in the example above (<code>semantic.events</code>) or a <code>SQL</code> query that returns a table. We will see an example of this later. <code>triage</code> will use it like the <code>FROM</code> clause in the <code>SQL</code> query.</li>
<li><strong><code>knowlege_date_column</code>:</strong> Column that indicates the date of the event.</li>
<li><strong><code>intervals</code>:</strong> A <code>yaml</code> list. <code>triage</code> will create one feature per interval listed.</li>
<li><strong><code>groups</code>:</strong> A <code>yaml</code> list of the attributes that we will use to aggregate. This will be translated to a <code>SQL</code> <code>GROUP BY</code> by <code>triage</code>.</li>
</ul>
<p>The last section to discuss is <code>imputation</code>. Imputation is very important step in the modeling, and you should carefully think about how you will impute the missing values in the feature. After deciding the best way of impute <em>each</em> feature, you should avoid leakage (For example, imagine that you want to impute with the <strong>mean</strong> one feature. You could have leakage if you take all the values of the column, including ones of the future to calculate the imputation). We will return to this later in this tutorial.</p>
<p><code>Collate</code> is in charge of creating the <code>SQL</code> agregation queries. Another way of thinking about it is that <code>collate</code> encapsulates the <code>FROM</code> part of the query (<code>from_obj</code>) as well as the <code>GROUP BY</code> columns (<code>groups</code>).</p>
<p><code>triage</code> (<code>collate</code>) supports two types of objects to be aggregated: <code>aggregates</code> and <code>categoricals</code> (more on this one later)<sup><a id="fnr.40" class="footref" href="#fn.40">40</a></sup>. The <code>aggregates</code> subsection represents a <code>yaml</code> list of <em>features</em> to be created. Each element on this represents a column (<code>quantity</code>, in the example, the whole row <code>*</code>) and an alias (<code>total</code>), defines the <code>imputation</code> strategy for <code>NULLs</code>, and the <code>metric</code> refers to the <code>aggregation function</code> to be applied to the <code>quantity</code> (<code>count</code>).</p>
<p><code>triage</code> will generate the following (or a very similar one), one per each combination of <code>interval</code> &times; <code>groups</code> &times; <code>quantity</code>:</p>
<div class="codehilite"><pre><span></span>select
  metric(quantity) as alias
from
  from_obj
where
  as_of_date &lt;@ (as_of_date - interval, as_of_date)
group by
  groups
</pre></div>


<p>With the previous configuration <code>triage</code> will generate <strong>1</strong> feature with the following name:<sup><a id="fnr.41" class="footref" href="#fn.41">41</a></sup></p>
<ul>
<li><code>inspections_entity_id_6month_total_count</code></li>
</ul>
<p>All the features of that <em>feature group</em> (in this case only 1) will be stored in the table.</p>
<ul>
<li><code>features.inspections_aggregation_imputed</code></li>
</ul>
<p>In general the names of the generated tables are constructed as follows:</p>
<div class="codehilite"><pre><span></span>schema.prefix_group_aggregation_imputed
</pre></div>


<p><strong>NOTE</strong>: the outputs are stored in the <code>features</code> schema.</p>
<p>Inside each of those new tables, the feature name will follow this pattern:</p>
<div class="codehilite"><pre><span></span>prefix_group_interval_alias_aggregation_operation
</pre></div>


<p>If we complicate a little the above configuration adding new intervals:</p>
<div class="codehilite"><pre><span></span>feature_aggregations:
  -
    prefix: &#39;inspections&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    aggregates:
      - # number of inspections
        quantity:
          total: &quot;*&quot;

        imputation:
          count:
            type: &#39;zero_noflag&#39;

        metrics: [&#39;count&#39;]

    intervals: [&#39;1month&#39;, &#39;3month&#39;, &#39;6month&#39;, &#39;1y&#39;, &#39;all&#39;]

    groups:
        - &#39;entity_id&#39;
</pre></div>


<p>You will end with 5 new <em>features</em>, one for each interval (5) &times; the only aggregate definition we have. Note the weird <code>all</code> in the <code>intervals</code> definition. <code>all</code> is the time interval between the <code>feature_start_time</code> and the <code>as_of_date</code>.</p>
<p><code>triage</code> also supports <code>categorical</code> objects. The following code adds a <em>feature</em> for the <code>risk</code> flag.</p>
<div class="codehilite"><pre><span></span>feature_aggregations:
  -
    prefix: &#39;inspections&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    aggregates:
      - # number of inspections
        quantity:
          total: &quot;*&quot;

        imputation:
          count:
            type: &#39;zero_noflag&#39;

        metrics: [&#39;count&#39;]

    intervals: [&#39;1month&#39;, &#39;3month&#39;, &#39;6month&#39;, &#39;1y&#39;, &#39;all&#39;]

    groups:
        - &#39;entity_id&#39;
  -
    prefix: &#39;risks&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    categoricals_imputation:
      sum:
        type: &#39;zero&#39;

    categoricals:
      -
        column: &#39;risk&#39;
        choice_query: &#39;select distinct risk from semantic.events&#39;
          metrics:
            - &#39;sum&#39;

    intervals: [&#39;1month&#39;, &#39;3month&#39;, &#39;6month&#39;, &#39;1y&#39;, &#39;all&#39;]

    groups:
      - &#39;entity_id&#39;
</pre></div>


<p>There are several changes. First, the imputation strategy in this new <em>feature group</em> is for every categorical features in that feature group (in that example only one). The next change is the type: instead of <code>aggregates</code>, it's <code>categoricals</code>. <code>categoricals</code> define a <code>yaml</code> list too. Each <code>categorical</code> feature needs to define a <code>column</code> to be aggregated and the query to get all the distinct values.</p>
<p>With this configuration, <code>triage</code> will generate two tables, one per <em>feature group</em>. The new table will be <code>features.risks_aggregation_imputed</code>. This table will have more columns: <code>intervals</code> (5) &times; <code>groups</code> (1) &times; <code>metric</code> (1) &times; <em>features</em> (1) &times; <em>number of choices returned by the query</em>.</p>
<p>The query:</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">distinct</span> <span class="n">risk</span> <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>risk</th>
</tr>
</thead>
<tbody>
<tr>
<td>¤</td>
</tr>
<tr>
<td>medium</td>
</tr>
<tr>
<td>high</td>
</tr>
<tr>
<td>low</td>
</tr>
</tbody>
</table>
<p>returns 4 possible values (including <code>NULL</code>). When dealing with categorical aggregations you need to be careful. Could be the case that in some period of time, in your data, you don't have all the possible values of the categorical variable. This could cause problems down the road. Triage allows you to specify the possible values (<em>choices</em>) of the variable. Instead of using <code>choice_query</code>, you could use <code>choices</code> as follows:</p>
<div class="codehilite"><pre><span></span>feature_aggregations:
  -
    prefix: &#39;inspections&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    aggregates:
      - # number of inspections
        quantity:
          total: &quot;*&quot;

        imputation:
          count:
            type: &#39;mean&#39;

        metrics: [&#39;count&#39;]

    intervals: [&#39;1month&#39;, &#39;3month&#39;, &#39;6month&#39;, &#39;1y&#39;, &#39;all&#39;]

    groups:
        - &#39;entity_id&#39;
  -
    prefix: &#39;risks&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    categoricals_imputation:
      sum:
        type: &#39;zero&#39;

    categoricals:
      -
        column: &#39;risk&#39;
        choices: [&#39;low&#39;, &#39;medium&#39;, &#39;high&#39;]
          metrics:
            - &#39;sum&#39;

    intervals: [&#39;1month&#39;, &#39;3month&#39;, &#39;6month&#39;, &#39;1y&#39;, &#39;all&#39;]

    groups:
      - &#39;entity_id&#39;
</pre></div>


<p>In both cases <code>triage</code> will generate <code>20</code> new features, as expected.</p>
<p>The features generated from categorical objects will have the following pattern:</p>
<div class="codehilite"><pre><span></span>prefix_group_interval_column_choice_aggregation_operation
</pre></div>


<p>So, <code>risks_entity_id_1month_risk_medium_sum</code> will be among our new features in the last example.</p>
<p>As a next step, let's investigate the effect of having several elements in the <code>groups</code> list.</p>
<div class="codehilite"><pre><span></span>feature_aggregations:
  -
    prefix: &#39;inspections&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    aggregates:
      - # number of inspections
        quantity:
          total: &quot;*&quot;

        imputation:
          count:
            type: &#39;mean&#39;

        metrics: [&#39;count&#39;]

    intervals: [&#39;1month&#39;, &#39;3month&#39;, &#39;6month&#39;, &#39;1y&#39;, &#39;all&#39;]

    groups:
        - &#39;entity_id&#39;

  -
    prefix: &#39;risks&#39;
    from_obj: &#39;semantic.events&#39;
    knowledge_date_column: &#39;date&#39;

    categoricals_imputation:
      sum:
        type: &#39;zero&#39;

    categoricals:
      -
        column: &#39;risk&#39;
        choices: [&#39;low&#39;, &#39;medium&#39;, &#39;high&#39;]
          metrics:
            - &#39;sum&#39;

    intervals: [&#39;1month&#39;, &#39;3month&#39;, &#39;6month&#39;, &#39;1y&#39;, &#39;all&#39;]

    groups:
      - &#39;entity_id&#39;
      - &#39;zip_code&#39;
</pre></div>


<p>The number of features created in the table <code>features.risks_aggregation_imputed</code> is now 60 (<code>intervals</code> (5) &times; <code>groups</code> (2) &times; <code>metric</code> (2) &times; <em>features</em> (1) &times; <em>number of choices</em> (3).</p>
<p><code>Triage</code> will add several imputation <em>flag</em> (binary) columns per feature. Those columns convey information about if that particular value was <em>imputed</em> or <em>not</em>. So in the last counting we need to add 20 more columns to a grand total of 80 columns.</p>
<h4>Imputation</h4>
<p><code>Triage</code> currently supports the following imputation strategies:</p>
<ul>
<li>
<p><strong>mean:</strong> The mean value of the feature.</p>
</li>
<li>
<p><strong>constant:</strong> Fill with a constant (you need to provide the constant value).</p>
</li>
<li>
<p><strong>zero:</strong> Same that the previous one, but the constant is zero.</p>
</li>
<li>
<p><strong>zero<sub>noflag</sub>:</strong> Sometimes, the absence (i.e. a NULL) doesn't mean that the value is missing, that actually means that the event didn't happen to that entity. For example a <code>NULL</code> in the <code>inspections_entity_id_1month_total_count</code> column in <code>features.inspections_aggreagtion_imputed</code> doesn't mean that the value is missing, it means that <em>zero</em> inspections happen to that facility in the last month. Henceforth, the <em>flag</em> column is not needed.</p>
</li>
</ul>
<p>Only for aggregates:</p>
<ul>
<li><strong>binary<sub>mode</sub>:</strong> Takes the mode of a binary feature</li>
</ul>
<p>Only for categoricals::</p>
<ul>
<li><strong>null<sub>category</sub>:</strong> Just flag null values with the null category column</li>
</ul>
<p>and finally, if you are sure that is not possible to have <em>NULLS:</em></p>
<ul>
<li><strong>error:</strong> Raise an exception if ant null values are encountered.</li>
</ul>
<h4>Feature groups strategies</h4>
<p>Another interesting thing that <code>triage</code> controls is how many feature groups are used in the machine learning grid. This would help you to understand the effect of using different groups in the final performance of the models.</p>
<p>In <code>simple_test_skeleton.yaml</code> you will find the following blocks:</p>
<div class="codehilite"><pre><span></span>feature_group_definition:
  prefix:
    - &#39;results&#39;
    - &#39;risks&#39;
    - &#39;inspections&#39;

feature_group_strategies: [&#39;all&#39;]
</pre></div>


<p>This configuration adds to the <em>number</em> of model groups to be created.</p>
<p>The possible feature group strategies are:</p>
<ul>
<li><strong><code>all</code>:</strong> All the features groups are used.</li>
<li><strong><code>leave-one-out</code>:</strong> All the combinations of: "All the feature groups except one are used".</li>
<li><strong><code>leave-one-in</code>:</strong> All the combinations of "One feature group except the rest is used"</li>
<li><strong><code>all-combinations</code>:</strong> All the combinations of <em>feature groups</em></li>
</ul>
<p>In order to clarify these concepts, let's use <code>simple_test_skeleton.yaml</code> configuration file. In it there are three feature groups: <code>inspections</code>, <code>results</code>, <code>risks</code>.</p>
<p>Using <code>all</code> will create just one set containg all the features of the three feature groups:</p>
<ul>
<li><code>{inspections, results, risks}</code></li>
</ul>
<p>If you modify <code>feature_group_strategies</code> to <code>['leave-one-out']</code>: the following sets will be created:</p>
<ul>
<li><code>{inspections, results}, {inspections, risks}, {results, risks}</code></li>
</ul>
<p>Using the <code>leave-one-in</code> strategy:</p>
<ul>
<li><code>{inspections}, {results}, {risks}</code></li>
</ul>
<p>Finally choosing <code>all-combinations</code>:</p>
<ul>
<li><code>{inspections}, {results}, {risks}, {inspections, results}</code>, <code>{inspections, risks}, {results, risks}, {inspections, results, risks}</code></li>
</ul>
<h4>Controlling the size of the tables</h4>
<blockquote>
<p>This section is a little technical, you can skip it if you fell like it.</p>
</blockquote>
<p>By default, <code>triage</code> will use the biggest column type for the features table (<code>integer</code>, <code>numeric</code>, etc). This could lead to humongous tables, with sizes several hundred of gigabytes. <code>Triage</code> took that decision, because it doesn't know anything about the possible values of your data (e.g. Is it possible to have millions of inspections in one month? or just a few dozens?).</p>
<p>If you are facing this difficulty, you can force <code>triage</code> to <em>cast</em> the column in the <em>features</em> table. Just add <code>coltype</code> to the <code>aggregate/categorical</code> block:</p>
<div class="highlight"><pre><span></span> <span class="nt">aggregates</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>
    <span class="nt">quantity</span><span class="p">:</span>
      <span class="nt">total</span><span class="p">:</span> <span class="s">&quot;*&quot;</span>
    <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;count&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">coltype</span><span class="p">:</span> <span class="s">&#39;smallint&#39;</span>
</pre></div>

<p><a id="org2a31032"></a></p>
<h3>The Grid</h3>
<p>Before applying Machine Learning to your dataset you don't know which combination of algorithm and hyperparameters will be the best given a specific matrix.</p>
<p><code>Triage</code> approaches this problem exploring a algorithm + hyperparameters + feature groups grid. At this time, this exploration is a exhaustive one, i.e. it covers the complete grid, so you would get (number of algorithms) <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> (number of hyperparameters) <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> (number of feature group strategies) models groups. The number of models trained is (number of model groups) <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> (number of time splits).</p>
<p>In our simple experiment the grid is very simple:</p>
<div class="highlight"><pre><span></span><span class="nt">grid_config</span><span class="p">:</span>
    <span class="nt">&#39;sklearn.dummy.DummyClassifier&#39;</span><span class="p">:</span>
        <span class="nt">strategy</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">most_frequent</span><span class="p p-Indicator">]</span>
</pre></div>

<p>Just one algorithm and one hyperparameter (also we have only one feature group strategy: <code>all</code>), and two time splits. So we will get 2 models, 1 model group.</p>
<p>Keep in mind that the grid is providing more than way to select a model. You can use the tables generated by the grid (see next section, <a href="#orgb0b0811">Machine learning governance</a>) and <em>analyze</em> and <em>understand</em> your data. In other words, analyzing the results (evaluations, predictions, hyperparameter space, etc.) is like applying <strong>Data mining</strong> concepts to your data using Machine learning. We will return to this when we apply post modeling to our models.</p>
<p><a id="orgb0b0811"></a></p>
<h3>Machine learning governance</h3>
<p>When <code>triage</code> executes the experiment, it creates a series of new schemas for storing the copious output of the experiment. The schemas are <code>test_results, train_results</code>, and <code>model_metadata</code>. These schemas store the metadata of the trained models, features, parameters, and hyperparameters used in their training. It also stores the predictions and evaluations of the models on the test sets.</p>
<p>The schema <code>model_metadata</code> is composed by the tables:</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">dt</span> <span class="n">model_metadata</span><span class="p">.</span><span class="o">*</span>
</pre></div>

<table>
<thead>
<tr>
<th>List of relations</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Schema</td>
<td>Name</td>
<td>Type</td>
<td>Owner</td>
</tr>
<tr>
<td>model<sub>metadata</sub></td>
<td>experiment<sub>matrices</sub></td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>model<sub>metadata</sub></td>
<td>experiment<sub>models</sub></td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>model<sub>metadata</sub></td>
<td>experiments</td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>model<sub>metadata</sub></td>
<td>list<sub>predictions</sub></td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>model<sub>metadata</sub></td>
<td>matrices</td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>model<sub>metadata</sub></td>
<td>model<sub>groups</sub></td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>model<sub>metadata</sub></td>
<td>models</td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
</tbody>
</table>
<p>The tables contained in <code>test_results</code> are:</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">dt</span> <span class="n">test_results</span><span class="p">.</span><span class="o">*</span>
</pre></div>

<table>
<thead>
<tr>
<th>List of relations</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Schema</td>
<td>Name</td>
<td>Type</td>
<td>Owner</td>
</tr>
<tr>
<td>test<sub>results</sub></td>
<td>evaluations</td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>test<sub>results</sub></td>
<td>individual<sub>importances</sub></td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>test<sub>results</sub></td>
<td>predictions</td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
</tbody>
</table>
<p>Lastly, if you have interest in how the model performed in the <em>training</em> data sets you could consult <code>train_results</code></p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">dt</span> <span class="n">train_results</span><span class="p">.</span><span class="o">*</span>
</pre></div>

<table>
<thead>
<tr>
<th>List of relations</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Schema</td>
<td>Name</td>
<td>Type</td>
<td>Owner</td>
</tr>
<tr>
<td>train<sub>results</sub></td>
<td>evaluations</td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>train<sub>results</sub></td>
<td>feature<sub>importances</sub></td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>train<sub>results</sub></td>
<td>predictions</td>
<td>table</td>
<td>food<sub>user</sub></td>
</tr>
</tbody>
</table>
<h4>What are all the results tables about?</h4>
<p><code>model_groups</code> stores the algorithm (<code>model_type</code>), the hyperparameters (<code>hyperparameters</code>), and the features shared by a particular set of models. <code>models</code> contains data specific to a model: the <code>model_group</code> (you can use <code>model_group_id</code> for linking the model to a model group), temporal information (like <code>train_end_time</code>), and the train matrix UUID (<code>train_matrix_uuid</code>). This <strong>UUID</strong> is important because it's the name of the file in which the matrix is stored.</p>
<p>Lastly, <code>{train, test}_results.predictions</code> contains all the <em>scores</em> generated by every model for every entity. <code>{train_test}_results.evaluation</code> stores the value of all the <strong>metrics</strong> for every model, which were specified in the <code>scoring</code> section in the config file.</p>
<ul>
<li>
<p><code>model_metadata.experiments</code></p>
<p>This table has the two columns: <code>experiment_hash</code> and <code>config</code></p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">d</span> <span class="n">model_metadata</span><span class="p">.</span><span class="n">experiments</span>
</pre></div>

<table>
<thead>
<tr>
<th>Table "model<sub>metadata.experiments</sub>"</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Column</td>
<td>Type</td>
<td>Collation</td>
<td>Nullable</td>
<td>Default</td>
</tr>
<tr>
<td>experiment<sub>hash</sub></td>
<td>character varying</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>config</td>
<td>jsonb</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Indexes:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"experiments<sub>pkey</sub>" PRIMARY KEY, btree (experiment<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Referenced by:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "model<sub>metadata.experiment</sub><sub>matrices</sub>" CONSTRAINT "experiment<sub>matrices</sub><sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (experiment<sub>hash</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "model<sub>metadata.experiment</sub><sub>models</sub>" CONSTRAINT "experiment<sub>models</sub><sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (experiment<sub>hash</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "model<sub>metadata.matrices</sub>" CONSTRAINT "matrices<sub>built</sub><sub>by</sub><sub>experiment</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "model<sub>metadata.models</sub>" CONSTRAINT "models<sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><code>experiment_hash</code> contains the hash of the configuration file that we used for our <code>triage</code> run.<sup><a id="fnr.42" class="footref" href="#fn.42">42</a></sup> <code>config</code> that contains the configuration experiment file that we used for our <code>triage</code> run, stored as <code>jsonb</code>.</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">experiment_hash</span><span class="p">,</span>
<span class="n">config</span> <span class="o">-&gt;</span>  <span class="s1">&#39;user_metadata&#39;</span> <span class="k">as</span> <span class="n">user_metadata</span>
<span class="k">from</span> <span class="n">model_metadata</span><span class="p">.</span><span class="n">experiments</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>experiment<sub>hash</sub></th>
<th>user<sub>metadata</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>67a1d564d31811b9c20ca63672c25abd</td>
<td>{"org": "DSaPP", "team": "Tutorial", "author": "Adolfo De Unanue", "etl<sub>date</sub>": "2019-02-21", "experiment<sub>type</sub>": "test", "label<sub>definition</sub>": "failed<sub>inspection</sub>"}</td>
</tr>
</tbody>
</table>
<p>We could use the following advice: If we are interested in all models that resulted from a certain config, we could lookup that config in <code>model_metadata.experiments</code> and then use its <code>experiment_hash</code> on other tables to find all the models that resulted from that configuration.</p>
</li>
<li>
<p><code>metadata_model.model_groups</code></p>
<p>Do you remember how we defined in <code>grid_config</code> the different classifiers that we want <code>triage</code> to train? For example, we could use in a configuration file the following:</p>
<div class="codehilite"><pre><span></span>&#39;sklearn.tree.DecisionTreeClassifier&#39;:
    criterion: [&#39;entropy&#39;]
    max_depth: [1, 2, 5, 10]
    random_state: [2193]
</pre></div>


<p>By doing so, we are saying that we want to train 4 decision trees (<code>max_depth</code> is one of <code>1, 2, 5, 10</code>). However, remember that we are using temporal crossvalidation to build our models, so we are going to have different temporal slices that we are training models on, e.g., 2010-2011, 2011-2012, etc.</p>
<p>Therefore, we are going to train our four decision trees on each temporal slice. Therefore, the trained model (or the instance of that model) will change across temporal splits, but the configuration will remain the same. This table lets us keep track of the different configurations (<code>model_groups</code>) and gives us an <code>id</code> for each configuration (<code>model_group_id</code>). We can leverage the <code>model_group_id</code> to find all the models that were trained using the same config but on different slices of time.</p>
<p>In our simple test configuration file we have:</p>
<div class="codehilite"><pre><span></span>&#39;sklearn.dummy.DummyClassifier&#39;:
    strategy: [most_frequent]
</pre></div>


<p>Therefore, if we run the following</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">model_config</span> <span class="o">-&gt;</span> <span class="s1">&#39;feature_groups&#39;</span> <span class="k">as</span> <span class="n">feature_groups</span><span class="p">,</span>
    <span class="n">model_config</span> <span class="o">-&gt;</span> <span class="s1">&#39;cohort_name&#39;</span> <span class="k">as</span> <span class="n">cohort</span><span class="p">,</span>
    <span class="n">model_config</span> <span class="o">-&gt;</span> <span class="s1">&#39;label_name&#39;</span> <span class="k">as</span> <span class="n">label</span><span class="p">,</span>
    <span class="n">model_config</span> <span class="o">-&gt;</span> <span class="s1">&#39;label_definition&#39;</span> <span class="k">as</span> <span class="n">label_definition</span><span class="p">,</span>
    <span class="n">model_config</span> <span class="o">-&gt;</span> <span class="s1">&#39;experiment_type&#39;</span> <span class="k">as</span> <span class="n">experiment_type</span><span class="p">,</span>
    <span class="n">model_config</span> <span class="o">-&gt;</span> <span class="s1">&#39;etl_date&#39;</span> <span class="k">as</span> <span class="n">etl_date</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>type</sub></th>
<th>hyperparameters</th>
<th>feature<sub>groups</sub></th>
<th>cohort</th>
<th>label</th>
<th>label<sub>definition</sub></th>
<th>experiment<sub>type</sub></th>
<th>etl<sub>date</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>["prefix: results", "prefix: risks", "prefix: inspections"]</td>
<td>"test<sub>facilities</sub>"</td>
<td>"failed<sub>inspections</sub>"</td>
<td>"failed<sub>inspection</sub>"</td>
<td>"test"</td>
<td>"2019-02-21"</td>
</tr>
</tbody>
</table>
<p>You can see that a model group is defined by the classifier (<code>model_type</code>), its hyperparameters (<code>hyperparameters</code>), the features (<code>feature_list</code>) (not shown), and the <code>model_config</code>.</p>
<p>The field <code>model_config</code> is created using information from the block <code>model_group_keys</code>. In our test configuration file the block is:</p>
<div class="highlight"><pre><span></span><span class="nt">model_group_keys</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;class_path&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;parameters&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;feature_names&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;feature_groups&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;cohort_name&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;state&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_name&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_timespan&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;training_as_of_date_frequency&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;max_training_history&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_definition&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;experiment_type&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;org&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;team&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;author&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;etl_date&#39;</span>
</pre></div>

<p><em>What can we learn from that?</em> For example, if we add a new feature and rerun <code>triage</code>, <code>triage</code> will create a new <code>model_group</code> even if the classifier and the <code>hyperparameters</code> are the same as before.</p>
</li>
<li>
<p><code>model_metadata.models</code></p>
<p>This table stores the information about our actual <em>models</em>, i.e., instances of our classifiers trained on specific temporal slices.</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">d</span> <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span>
</pre></div>

<table>
<thead>
<tr>
<th>Table "model<sub>metadata.models</sub>"</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Column</td>
<td>Type</td>
<td>Collation</td>
<td>Nullable</td>
<td>Default</td>
</tr>
<tr>
<td>model<sub>id</sub></td>
<td>integer</td>
<td></td>
<td>not null</td>
<td>nextval('model<sub>metadata.models</sub><sub>model</sub><sub>id</sub><sub>seq</sub>'::regclass)</td>
</tr>
<tr>
<td>model<sub>group</sub><sub>id</sub></td>
<td>integer</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>model<sub>hash</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>run<sub>time</sub></td>
<td>timestamp without time zone</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>batch<sub>run</sub><sub>time</sub></td>
<td>timestamp without time zone</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>model<sub>type</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>hyperparameters</td>
<td>jsonb</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>model<sub>comment</sub></td>
<td>text</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>batch<sub>comment</sub></td>
<td>text</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>config</td>
<td>json</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>built<sub>by</sub><sub>experiment</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>train<sub>end</sub><sub>time</sub></td>
<td>timestamp without time zone</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>test</td>
<td>boolean</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>train<sub>matrix</sub><sub>uuid</sub></td>
<td>text</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>training<sub>label</sub><sub>timespan</sub></td>
<td>interval</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>model<sub>size</sub></td>
<td>real</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Indexes:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"models<sub>pkey</sub>" PRIMARY KEY, btree (model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"ix<sub>results</sub><sub>models</sub><sub>model</sub><sub>hash</sub>" UNIQUE, btree (model<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Foreign-key constraints:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"matrix<sub>uuid</sub><sub>for</sub><sub>models</sub>" FOREIGN KEY (train<sub>matrix</sub><sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"models<sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"models<sub>model</sub><sub>group</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>group</sub><sub>id</sub>) REFERENCES model<sub>metadata.model</sub><sub>groups</sub>(model<sub>group</sub><sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Referenced by:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "test<sub>results.evaluations</sub>" CONSTRAINT "evaluations<sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "train<sub>results.feature</sub><sub>importances</sub>" CONSTRAINT "feature<sub>importances</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "test<sub>results.individual</sub><sub>importances</sub>" CONSTRAINT "individual<sub>importances</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "model<sub>metadata.list</sub><sub>predictions</sub>" CONSTRAINT "list<sub>predictions</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "test<sub>results.predictions</sub>" CONSTRAINT "predictions<sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "train<sub>results.evaluations</sub>" CONSTRAINT "train<sub>evaluations</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "train<sub>results.predictions</sub>" CONSTRAINT "train<sub>predictions</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Noteworthy columns are:</p>
<ul>
<li><strong><code>model_id</code>:</strong> The id of the model (i.e., instance&#x2026;). We will use this ID to trace a model evaluation to a <code>model_group</code> and vice versa.</li>
<li><strong><code>model_group_id</code>:</strong> The id of the models <em>model group</em> we encountered above.</li>
<li><strong><code>model_hash</code>:</strong> The <em>hash</em> of our model. We can use the hash to load the actual model. It gets stored under <code>TRIAGE_OUTPUT_PATH/trained_models/{model_hash}</code>. We are going to this later to look at a trained decision tree.</li>
<li><strong><code>run_time</code>:</strong> Time when the model was trained.</li>
<li><strong><code>model_type</code>:</strong> The algorithm used for training.</li>
<li><strong><code>model_comment</code>:</strong> Literally the text in the <code>model_comment</code> block in the configuration file</li>
<li><strong><code>hyperparameters</code>:</strong> Hyperparameters used for the model configuration.</li>
<li><strong><code>built_by_experiment</code>:</strong> The hash of our experiment. We encountered this value in the <code>results.experiments</code> table before.</li>
<li><strong><code>train_end_time</code>:</strong> When building the training matrix, we included training samples up to this date.</li>
<li><strong><code>train_matrix_uuid</code>:</strong> The <em>hash</em> of the matrix that we used to train this model. The matrix gets stored as <code>csv</code> under <code>TRIAGE_OUTPUT_PATH/matrices/{train_matrix_uuid}.csv</code>. This is helpful when trying to inspect the matrix and features that were used for training.</li>
<li><strong><code>train_label_timespan</code>:</strong> How big was our window to get the labels for our training matrix? For example, a <code>train_label_window</code> of 1 year would mean that we look one year from a given date in the training matrix into the future to find the label for that training sample.</li>
</ul>
</li>
<li>
<p><code>model_metadata.matrices</code></p>
<p>This schema contains information about the matrices used in the model's training. You could use this information to debug your models. Important columns are <code>matrix_uuid</code> (The matrix gets stored as <code>TRIAGE_OUTPUT_PATH/matrices/{train_matrix_uuid}.csv</code>), <code>matrix_type</code> (indicated if the matrix was used for <em>training</em> models or <em>testing</em> them), <code>lookback_duration</code> and <code>feature_starttime</code> (give information about the temporal setting of the features) and <code>num_observations</code> (size of the matrices).</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">d</span> <span class="n">model_metadata</span><span class="p">.</span><span class="n">matrices</span>
</pre></div>

<table>
<thead>
<tr>
<th>Table "model<sub>metadata.matrices</sub>"</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Column</td>
<td>Type</td>
<td>Collation</td>
<td>Nullable</td>
<td>Default</td>
</tr>
<tr>
<td>matrix<sub>id</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>matrix<sub>uuid</sub></td>
<td>character varying</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>matrix<sub>type</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>labeling<sub>window</sub></td>
<td>interval</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>num<sub>observations</sub></td>
<td>integer</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>creation<sub>time</sub></td>
<td>timestamp with time zone</td>
<td></td>
<td></td>
<td>now()</td>
</tr>
<tr>
<td>lookback<sub>duration</sub></td>
<td>interval</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>feature<sub>start</sub><sub>time</sub></td>
<td>timestamp without time zone</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>matrix<sub>metadata</sub></td>
<td>jsonb</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>built<sub>by</sub><sub>experiment</sub></td>
<td>character varying</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Indexes:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"matrices<sub>pkey</sub>" PRIMARY KEY, btree (matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"ix<sub>model</sub><sub>metadata</sub><sub>matrices</sub><sub>matrix</sub><sub>uuid</sub>" UNIQUE, btree (matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Foreign-key constraints:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"matrices<sub>built</sub><sub>by</sub><sub>experiment</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Referenced by:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "test<sub>results.evaluations</sub>" CONSTRAINT "evaluations<sub>matrix</sub><sub>uuid</sub><sub>fkey</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "train<sub>results.evaluations</sub>" CONSTRAINT "evaluations<sub>matrix</sub><sub>uuid</sub><sub>fkey</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "model<sub>metadata.models</sub>" CONSTRAINT "matrix<sub>uuid</sub><sub>for</sub><sub>models</sub>" FOREIGN KEY (train<sub>matrix</sub><sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "test<sub>results.predictions</sub>" CONSTRAINT "matrix<sub>uuid</sub><sub>for</sub><sub>testpred</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "train<sub>results.predictions</sub>" CONSTRAINT "matrix<sub>uuid</sub><sub>for</sub><sub>trainpred</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TABLE "train<sub>results.predictions</sub>" CONSTRAINT "train<sub>predictions</sub><sub>matrix</sub><sub>uuid</sub><sub>fkey</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>{test, train}_results.evaluations</code></p>
<p>These tables lets us analyze how well our models are doing. Based on the config that we used for our <code>triage</code> run, <code>triage</code> is calculating metrics and storing them in this table, e.g., our model's precision in top 10%.</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">d</span> <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span>
</pre></div>

<table>
<thead>
<tr>
<th>Table "test<sub>results.evaluations</sub>"</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Column</td>
<td>Type</td>
<td>Collation</td>
<td>Nullable</td>
<td>Default</td>
</tr>
<tr>
<td>model<sub>id</sub></td>
<td>integer</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>evaluation<sub>start</sub><sub>time</sub></td>
<td>timestamp without time zone</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>evaluation<sub>end</sub><sub>time</sub></td>
<td>timestamp without time zone</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>as<sub>of</sub><sub>date</sub><sub>frequency</sub></td>
<td>interval</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>metric</td>
<td>character varying</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>parameter</td>
<td>character varying</td>
<td></td>
<td>not null</td>
<td></td>
</tr>
<tr>
<td>value</td>
<td>numeric</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>num<sub>labeled</sub><sub>examples</sub></td>
<td>integer</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>num<sub>labeled</sub><sub>above</sub><sub>threshold</sub></td>
<td>integer</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>num<sub>positive</sub><sub>labels</sub></td>
<td>integer</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>sort<sub>seed</sub></td>
<td>integer</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>matrix<sub>uuid</sub></td>
<td>text</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Indexes:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"evaluations<sub>pkey</sub>" PRIMARY KEY, btree (model<sub>id</sub>, evaluation<sub>start</sub><sub>time</sub>, evaluation<sub>end</sub><sub>time</sub>, as<sub>of</sub><sub>date</sub><sub>frequency</sub>, metric, parameter)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Foreign-key constraints:</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"evaluations<sub>matrix</sub><sub>uuid</sub><sub>fkey</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>"evaluations<sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Its columns are:</p>
<ul>
<li><strong><code>model_id</code>:</strong> Our beloved <code>model_id</code> that we have encountered before.</li>
<li><strong><code>evaluation_start_time</code>:</strong> After training the model, we evaluate it on a test matrix. This column tells us the earliest time that an example in our test matrix could have.</li>
<li><strong><code>evaluation_end_time</code>:</strong> After training the model, we evaluate it on a test matrix. This column tells us the latest time that an example in our test matrix could have.</li>
<li><strong><code>metric</code>:</strong> Indicates which metric we are evaluating, e.g., <code>precision@</code>.</li>
<li><code>parameter</code> ::Indicates at which parameter we are evaluating our metric, e.g., a metric of precision@ and a parameter of <code>100.0_pct</code> shows us the <code>precision@100pct</code>.</li>
<li><strong><code>value</code>:</strong> The value observed for our metric@parameter.</li>
<li><strong><code>num_labeled_examples</code>:</strong> The number of labeled examples in our test matrix. Why does it matter? It could be the case that we have entities that have no label for the test timeframe (for example, not all facilities will have an inspection). We still want to make predictions for these entities but can't include them when calculating performance metrics.</li>
<li><strong><code>num_labeled_above_threshold</code>:</strong> How many examples above our threshold were labeled?</li>
<li><strong><code>num_positive_labels</code>:</strong> The number of rows that had true positive labels.</li>
</ul>
<p>A look at the table shows that we have multiple rows for each model, each showing a different performance metric.</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">evaluation_end_time</span><span class="p">,</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">metric</span> <span class="o">||</span> <span class="k">parameter</span> <span class="k">as</span> <span class="n">metric</span><span class="p">,</span>
    <span class="n">value</span><span class="p">,</span>
    <span class="n">num_labeled_examples</span><span class="p">,</span>
    <span class="n">num_labeled_above_threshold</span><span class="p">,</span>
    <span class="n">num_positive_labels</span>
<span class="k">from</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span>
<span class="k">where</span>
    <span class="k">parameter</span> <span class="o">=</span> <span class="s1">&#39;100.0_pct&#39;</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>evaluation<sub>end</sub><sub>time</sub></th>
<th>model<sub>id</sub></th>
<th>metric</th>
<th>value</th>
<th>num<sub>labeled</sub><sub>examples</sub></th>
<th>num<sub>labeled</sub><sub>above</sub><sub>threshold</sub></th>
<th>num<sub>positive</sub><sub>labels</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>2016-01-01 00:00:00</td>
<td>1</td>
<td>precision@100.0<sub>pct</sub></td>
<td>0.6666666666666666</td>
<td>3</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>2016-01-01 00:00:00</td>
<td>1</td>
<td>recall@100.0<sub>pct</sub></td>
<td>1.0</td>
<td>3</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>2017-01-01 00:00:00</td>
<td>2</td>
<td>precision@100.0<sub>pct</sub></td>
<td>0.3333333333333333</td>
<td>3</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>2017-01-01 00:00:00</td>
<td>2</td>
<td>recall@100.0<sub>pct</sub></td>
<td>1.0</td>
<td>3</td>
<td>3</td>
<td>1</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Remember that at 100%, the <code>recall</code> should be 1, and the <code>precision</code> is equal to the <em>baserate</em>. If these two things don't match, there are problems in your data, pipeline, etl. You must get this correct!</p>
</blockquote>
<p><em>What does this query tell us?</em></p>
<p>We can now see how the different instances (trained on different temporal slices, but with the same model params) of a model group performs over time. Note how we only included the <em>models</em> that belong to our <em>model group</em> <code>1</code>.</p>
</li>
<li>
<p><code>{test, train}_results.predictions</code></p>
<p>You can think of the previous table <code>{test, train}_results.{test, train}_predictions</code> as a summary of individuals predictions that our model is making. But where can you find the individual predictions that our model is making? (So you can generate a list from here). And where can we find the test matrix that the predictions are based on? Let us introduce you to the <code>results.predictions</code> table.</p>
<p>Here is what its first row looks like:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="n">as_of_date</span><span class="p">,</span>
    <span class="n">score</span><span class="p">,</span>
    <span class="n">label_value</span><span class="p">,</span>
    <span class="n">matrix_uuid</span>
<span class="k">from</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">predictions</span>
<span class="k">where</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">score</span> <span class="k">desc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>id</sub></th>
<th>entity<sub>id</sub></th>
<th>as<sub>of</sub><sub>date</sub></th>
<th>score</th>
<th>label<sub>value</sub></th>
<th>matrix<sub>uuid</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>229</td>
<td>2016-01-01 00:00:00</td>
<td>1.0</td>
<td>1</td>
<td>cd0ae68d6ace43033b49ee0390c3583e</td>
</tr>
<tr>
<td>1</td>
<td>355</td>
<td>2016-01-01 00:00:00</td>
<td>1.0</td>
<td>1</td>
<td>cd0ae68d6ace43033b49ee0390c3583e</td>
</tr>
<tr>
<td>1</td>
<td>840</td>
<td>2016-01-01 00:00:00</td>
<td>1.0</td>
<td>0</td>
<td>cd0ae68d6ace43033b49ee0390c3583e</td>
</tr>
</tbody>
</table>
<p>As you can see, the table contains our models' predictions for a given entity and date.</p>
<p>And do you notice the field <code>matrix_uuid</code>? Doesn't it look similar to the fields from above that gave us the names of our training matrices? In fact, it is the same. You can find the test matrix that was used to make this prediction under <code>TRIAGE_OUTPUT_PATH/matrices/{matrix_uuid}.csv</code>.</p>
</li>
<li>
<p><code>{test, train}_results.feature_importances</code></p>
<p>This tables store the feature importance of all the models.</p>
</li>
</ul>
<h3>Audition</h3>
<p><strong>Audition</strong> is a tool for helping you select a subset of trained classifiers from a triage experiment. Often, production-scale experiments will come up with thousands of trained models, and sifting through all of those results can be time-consuming even after calculating the usual basic metrics like precision and recall.</p>
<p>You will be facing questions as:</p>
<ul>
<li>Which metrics matter most?</li>
<li>Should you prioritize the best metric value over time or treat recent data as most important?</li>
<li>Is low metric variance important?</li>
</ul>
<p>The answers to questions like these may not be obvious. <strong>Audition</strong> introduces a structured, semi-automated way of filtering models based on what you consider important.</p>
<h3>Post-modeling</h3>
<p>As the name indicates, <strong>postmodeling</strong> occurs <strong>after</strong> you have modeled (potentially) thousands of models (different hyperparameters, different time windows, different algorithms, etc), and using <code>audition</code> you <em>pre</em> selected a small number of models.</p>
<p>Now, with the <strong>postmodeling</strong> tools you will be able to select your final model for <em>production</em> use.</p>
<p>Triage's postmodeling capabilities include:</p>
<ul>
<li>Show the score distribution</li>
<li>Compare the list generated by a set of models</li>
<li>Compare the feature importance between a set of models</li>
<li>Diplay the probability calibration curves</li>
<li>Analyze the errors using a decision tree trained on the errors of the model.</li>
<li>Cross-tab analysis</li>
<li>Bias analysis</li>
</ul>
<p>If you want to see <strong>Audition</strong> and <strong>Postmodeling</strong> in action, we will use them after <strong>Inspections</strong> and <strong>EIS modeling</strong>.</p>
<h3>Final cleaning</h3>
<p>In the next section we will start modeling, so it is a good idea to clean the <code>{test, train}_results</code> schemas and have a fresh start:</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">nuke_triage</span><span class="p">();</span>
</pre></div>

<table>
<thead>
<tr>
<th>nuke<sub>triage</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>triage was send to the oblivion. Long live to triage!</td>
</tr>
</tbody>
</table>
<p><code>triage</code> also creates a lot of files (we will see why in the next section). Let's remove them too.</p>
<div class="highlight"><pre><span></span>rm -r /triage/matrices/*
</pre></div>

<div class="highlight"><pre><span></span>rm -r /triage/trained_models/*
</pre></div>

<h2>Inpection prioritization</h2>
<h3>Problem description</h3>
<p>We will begin with the <strong>inspection prioritization</strong> problem. We want to generate a list of facilities that will have a <strong>critical</strong> or <strong>serious</strong> food violation <em>if</em> inspected.</p>
<p>The scenario is the following: you work for the City of Chicago and you have limited food inspectors, so you try to prioritize them to focus on the highest-risk facilities. So you will use the data to answer the next question:</p>
<blockquote>
<p>Which X facilities are most likely to fail a food inspection in the following Y period of time?</p>
</blockquote>
<p>A more technical way of writing the question is: What is the <em>probability distribution</em> of facilities that are at <strong>risk</strong> of fail a food inspection if they are inspected in the following period of time?<sup><a id="fnr.43" class="footref" href="#fn.43">43</a></sup></p>
<p>If you want to focus on major violations only, you can do that too:</p>
<blockquote>
<p>Which X facilities are most likely to have a critical or serious violation in the following Y period of time?</p>
</blockquote>
<p>This situation is very common in governmental agencies that provide social services: <em>they need to prioritize their resources and use them in the facilities that are most likely to have problems</em></p>
<p>We will use Machine Learning to accomplish this. This means that we will use <em>historical</em> data to train our models, and we will use temporal cross validation to test the performance of them.</p>
<p>For the <strong>resource prioritization</strong> problems there are commonly two problems with the data: (a) bias and (b) incompleteness.</p>
<p>First, note that our data have bias: We only have data on facilities that <em>were</em> inspected. That means that our data set contains information about the probability of have a violation (<span><span class="MathJax_Preview">V</span><script type="math/tex">V</script></span>) given that the facility was inspected (<span><span class="MathJax_Preview">I</span><script type="math/tex">I</script></span>), <span><span class="MathJax_Preview">P(V|I)</span><script type="math/tex">P(V|I)</script></span>. But the probability that we try to find is <span><span class="MathJax_Preview">P(V)</span><script type="math/tex">P(V)</script></span>.</p>
<p>A different problem that our data set could have is if our dataset contains <strong>all</strong> the facilities in Chicago, i.e. if our <em>entities</em> table represents the Universe of facilities. There are almost 40,000 entities in our database. We could make the case that <strong>every</strong> facility in Chicago is in the database, since <strong>every</strong> facility that opens will be subject to an inspection. We will assume that <strong>all</strong> the facilities are in our data.</p>
<h3>Creating the labels</h3>
<p>We will define two labels:</p>
<ul>
<li><strong>Which facilities are likely to fail an inspection?</strong></li>
</ul>
<p>The label takes a 1 if the inspection had at least one <code>result</code> = <code>'fail'</code> and a 0 otherwise.</p>
<ul>
<li><strong>Which facilities fail an inspection with a major violation?</strong></li>
</ul>
<p>Critical violations are coded between <code>1-14</code>, serious violations between <code>15-29</code>, everything above <code>30</code> is assumed to be a minor violation. The label takes a 1 if the inspection had at least one <code>result</code> = <code>'fail'</code> and a violation between 1 and 29, and a 0 otherwise.</p>
<p>We can extract the severity of the violation using the following code:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">event_id</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="k">result</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="k">distinct</span> <span class="n">obj</span> <span class="o">-&gt;&gt;</span><span class="s1">&#39;severity&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">violations_severity</span><span class="p">,</span>
    <span class="p">(</span><span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">failed</span><span class="p">,</span>
    <span class="n">coalesce</span><span class="p">(</span>
    <span class="p">(</span><span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span> <span class="k">and</span>
        <span class="p">(</span><span class="s1">&#39;serious&#39;</span> <span class="o">=</span> <span class="k">ANY</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">obj</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;severity&#39;</span><span class="p">))</span> <span class="k">or</span> <span class="s1">&#39;critical&#39;</span> <span class="o">=</span> <span class="k">ANY</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">obj</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;severity&#39;</span><span class="p">)))</span>
        <span class="p">),</span> <span class="k">false</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">failed_major_violation</span>
<span class="k">from</span>
    <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">event_id</span><span class="p">,</span>
        <span class="n">entity_id</span><span class="p">,</span>
        <span class="nb">date</span><span class="p">,</span>
        <span class="k">result</span><span class="p">,</span>
        <span class="n">jsonb_array_elements</span><span class="p">(</span><span class="n">violations</span><span class="p">::</span><span class="n">jsonb</span><span class="p">)</span> <span class="k">as</span> <span class="n">obj</span>
    <span class="k">from</span>
        <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
        <span class="k">limit</span> <span class="mi">20</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">t1</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">entity_id</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="k">result</span>
<span class="k">order</span> <span class="k">by</span>
   <span class="nb">date</span> <span class="k">desc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>event<sub>id</sub></th>
<th>entity<sub>id</sub></th>
<th>date</th>
<th>result</th>
<th>violations<sub>severity</sub></th>
<th>failed</th>
<th>failed<sub>major</sub><sub>violation</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>1770568</td>
<td>30841</td>
<td>2016-05-11</td>
<td>pass</td>
<td>{minor}</td>
<td>f</td>
<td>f</td>
</tr>
<tr>
<td>1763967</td>
<td>30841</td>
<td>2016-05-03</td>
<td>fail</td>
<td>{critical,minor,serious}</td>
<td>t</td>
<td>t</td>
</tr>
<tr>
<td>1434534</td>
<td>21337</td>
<td>2014-04-03</td>
<td>pass</td>
<td>{NULL}</td>
<td>f</td>
<td>f</td>
</tr>
<tr>
<td>1343315</td>
<td>22053</td>
<td>2013-06-06</td>
<td>fail</td>
<td>{minor,serious}</td>
<td>t</td>
<td>t</td>
</tr>
<tr>
<td>1235707</td>
<td>21337</td>
<td>2013-03-27</td>
<td>pass</td>
<td>{NULL}</td>
<td>f</td>
<td>f</td>
</tr>
<tr>
<td>537439</td>
<td>13458</td>
<td>2011-06-10</td>
<td>fail</td>
<td>{NULL}</td>
<td>t</td>
<td>f</td>
</tr>
<tr>
<td>569377</td>
<td>5570</td>
<td>2011-06-01</td>
<td>pass</td>
<td>{NULL}</td>
<td>f</td>
<td>f</td>
</tr>
</tbody>
</table>
<p>Remember from the section <a href="#orgd27c756">Cohorts, labels, event dates and as of dates</a> that the <em>outcome</em> will be used by <code>triage</code> to generate the labels. The following image tries to show the meaning of the <em>outcomes</em> for the <em>inspection failed</em> problem definition.</p>
<p><img alt="img" src="images/outcomes-inspections.png" title="The image shows three facilities and, next to each, a temporal line with 6 days (0-5). Each dot represents an inspection. Color is the *outcome* of the inspection. Green means the facility passed the inspection, and red means it failed. Each facility in the image had two inspections, but only the facility in the middle passed both." /></p>
<h3>Modeling Using Machine Learning</h3>
<p>It is time to put these steps together. All the coding is complete (<code>triage</code> dev team did that for us); we just need to modify the <code>triage</code> experiment’s configuration file.</p>
<h4>Defining a baseline</h4>
<p>As a first step, lets do an experiment that defines our <em>baseline</em>. The rationale of this is that the knowing the <em>baseline</em> will allow us to verify if our Machine Learning model is better than the baseline<sup><a id="fnr.44" class="footref" href="#fn.44">44</a></sup>. It is also very fast to train ( <code>DummyClassifier</code> is not computationally expensive, so it will help us to verify that the experiment configuration is correct without waiting for a long time).</p>
<p>We need to write the experiment config file for that. Let's break it down and explain the sections.</p>
<p>The config file for this first experiment is located in <a href="triage/experiments/inspections_baseline.yaml">triage/experiments/inspections<sub>baseline.yaml</sub></a>.</p>
<p>The first lines of the experiment config file specify the config-file version (<code>v6</code> at the moment of writing this tutorial), a comment (<code>model_comment</code>, which will end up as a value in the <code>model_metadata.models</code> table), and a list of user-defined metadata (<code>user_metadata</code>) that can help to identify the resulting model groups. For this example, if you run experiments that share a temporal configuration but that use different label definitions (say, labeling inspections with <strong>any</strong> violation as positive versus only labeling inspections with major violations as positive), you can use the user metadata keys to indicate that the matrices from these experiments have different labeling criteria. The matrices from the two experiments will have different filenames (and should not be overwritten or incorrectly used), and if you add the <code>label_definition</code> key to the <code>model_group_keys</code>, models made on different label definitions will belong to different model groups.</p>
<div class="highlight"><pre><span></span><span class="nt">config_version</span><span class="p">:</span> <span class="s">&#39;v6&#39;</span>

<span class="nt">model_comment</span><span class="p">:</span> <span class="nt">&#39;inspections</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">baseline&#39;</span>

<span class="nt">user_metadata</span><span class="p">:</span>
    <span class="nt">label_definition</span><span class="p">:</span> <span class="s">&#39;failed&#39;</span>
    <span class="nt">experiment_type</span><span class="p">:</span> <span class="s">&#39;inspections</span><span class="nv"> </span><span class="s">prioritization&#39;</span>
    <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
      <span class="no">Baseline calculation</span>
    <span class="nt">purpose</span><span class="p">:</span> <span class="s">&#39;baseline&#39;</span>
    <span class="nt">org</span><span class="p">:</span> <span class="s">&#39;DSaPP&#39;</span>
    <span class="nt">team</span><span class="p">:</span> <span class="s">&#39;Tutorial&#39;</span>
    <span class="nt">author</span><span class="p">:</span> <span class="s">&#39;Your</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">here&#39;</span>
    <span class="nt">etl_date</span><span class="p">:</span> <span class="s">&#39;2019-02-21&#39;</span>

<span class="nt">model_group_keys</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;class_path&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;parameters&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;feature_names&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;feature_groups&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;cohort_name&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;state&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_name&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_timespan&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;training_as_of_date_frequency&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;max_training_history&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_definition&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;experiment_type&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;org&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;team&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;author&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;purpose&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;etl_date&#39;</span>
</pre></div>

<p>(Obviously, change <code>'Your name here'</code> for your name)</p>
<p>Next comes the <strong>temporal configuration</strong> section. The first four parameters are related to the availability of data: How much data you have for feature creation? How much data you have for label generation? For simplicity we will assume that we can use the full <code>semantic.events</code> time span for both.</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">min</span><span class="p">(</span><span class="nb">date</span><span class="p">),</span> <span class="k">max</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
</pre></div>

<table>
<thead>
<tr>
<th>min</th>
<th>max</th>
</tr>
</thead>
<tbody>
<tr>
<td>2010-01-04</td>
<td>2019-02-20</td>
</tr>
</tbody>
</table>
<p>The next parameters are related to the training intervals:</p>
<ul>
<li>How frequently to retrain models? (<code>model_update_frequency</code>)</li>
<li>How many rows per entity in the train matrices? (<code>training_as_of_date_frequencies</code>)</li>
<li>How much time is covered by labels in the training matrices? (<code>training_label_timespans</code>)</li>
</ul>
<p>The remaining elements are related to the <strong>testing</strong> matrices. For <strong>inspections</strong>, you can choose them as follows:</p>
<ul>
<li><code>test_as_of_date_frequencies</code> is planning/scheduling frequency</li>
<li><code>test_durations</code> how far ahead do you schedule inspections?</li>
<li><code>test_label_timespan</code> is equal to <code>test_durations</code></li>
</ul>
<p>Let's assume that we need to do rounds of inspections every month (<code>test_as_of_date_frequencies = 1month</code>) and we need to complete that round in exactly one month (<code>test_durations = test_label_timespan = 1month</code>).</p>
<p>We will assume that the data is more or less stable<sup><a id="fnr.45" class="footref" href="#fn.45">45</a></sup>, at least for one year, so <code>model_update_frequency</code> = <code>1 year.</code></p>
<div class="highlight"><pre><span></span><span class="nt">temporal_config</span><span class="p">:</span>
    <span class="nt">feature_start_time</span><span class="p">:</span> <span class="s">&#39;2010-01-04&#39;</span>
    <span class="nt">feature_end_time</span><span class="p">:</span> <span class="s">&#39;2019-01-01&#39;</span>
    <span class="nt">label_start_time</span><span class="p">:</span> <span class="s">&#39;2015-02-01&#39;</span>
    <span class="nt">label_end_time</span><span class="p">:</span> <span class="s">&#39;2019-01-01&#39;</span>

    <span class="nt">model_update_frequency</span><span class="p">:</span> <span class="s">&#39;1y&#39;</span>
    <span class="nt">training_label_timespans</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">training_as_of_date_frequencies</span><span class="p">:</span> <span class="s">&#39;1month&#39;</span>

    <span class="nt">test_durations</span><span class="p">:</span> <span class="s">&#39;1y&#39;</span>
    <span class="nt">test_label_timespans</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">test_as_of_date_frequencies</span><span class="p">:</span> <span class="s">&#39;1month&#39;</span>

    <span class="nt">max_training_histories</span><span class="p">:</span> <span class="s">&#39;5y&#39;</span>
</pre></div>

<p>We can visualize the splitting using the function <code>show-timechop</code> introduced in <a href="04_triage_intro.md">Introduction to triage</a></p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_baseline.yaml --show-timechop
</pre></div>

<p><img alt="img" src="triage/images/inspections_baseline.png" title="Temporal blocks for inspections&lt;sub&gt;dt&lt;/sub&gt; experiment" /></p>
<p>We need to specify our labels. For this first experiment we will use the label <code>failed</code>, using the same query from the <code>simple_skeleton_experiment.yaml</code></p>
<div class="highlight"><pre><span></span><span class="nt">label_config</span><span class="p">:</span>
  <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">select</span>
    <span class="no">entity_id,</span>
    <span class="no">bool_or(result = &#39;fail&#39;)::integer as outcome</span>
    <span class="no">from semantic.events</span>
    <span class="no">where &#39;{as_of_date}&#39;::timestamp &lt;= date</span>
    <span class="no">and date &lt; &#39;{as_of_date}&#39;::timestamp + interval &#39;{label_timespan}&#39;</span>
    <span class="no">group by entity_id</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;failed_inspections&#39;</span>
</pre></div>

<p>It should be obvious, but let's state it anyway: We are only training in facilities that <strong>were</strong> inspected, but we will <strong>test</strong> our model in all the facilities in our cohort<sup><a id="fnr.46" class="footref" href="#fn.46">46</a></sup>. So, in the train matrices we will have only <code>0</code> and <code>1</code> as possible labels, but in the test matrices we will found <code>0</code>, <code>1</code> and <code>NULL</code>.</p>
<p>In the section regarding to <em>Early Warning Systems</em> we will learn how to incorporate <em>all</em> the facilities of the cohort in the train matrices.</p>
<p>We just want to include <strong>active</strong> facilities<sup><a id="fnr.47" class="footref" href="#fn.47">47</a></sup> in our matrices, so we tell <code>triage</code> to take that in account:</p>
<div class="highlight"><pre><span></span><span class="nt">cohort_config</span><span class="p">:</span>
  <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">with buckets as (</span>
    <span class="no">select *, ntile(5) over (order by number_of_inspections asc) as bucket</span>
    <span class="no">from (</span>
    <span class="no">select entity_id, count(*) as number_of_inspections</span>
    <span class="no">from semantic.events</span>
    <span class="no">group by entity_id</span>
    <span class="no">) as t</span>
    <span class="no">)</span>
    <span class="no">select e.entity_id</span>
    <span class="no">from semantic.entities as e</span>
    <span class="no">inner join</span>
    <span class="no">buckets as b</span>
    <span class="no">using (entity_id)</span>
    <span class="no">where</span>
    <span class="no">daterange(start_time, end_time, &#39;[]&#39;) @&gt; &#39;{as_of_date}&#39;::date</span>
    <span class="no">and bucket in (5)</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;active_facilities&#39;</span>
</pre></div>

<p><code>Triage</code> will generate the features for us, but we need to tell it which features we want in the section <code>feature_aggregations</code>. Here, each entry describes a <code>collate.SpacetimeAggregation</code> object and the arguments needed to create it. For this experiment, we will use only one feature (number of inspections). <code>DummyClassifier</code> don't use any feature to do the "prediction", so we won't expend compute cycles doing the feature/matrix creation:</p>
<div class="highlight"><pre><span></span><span class="nt">feature_aggregations</span><span class="p">:</span>
  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;inspections&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">aggregates_imputation</span><span class="p">:</span>
      <span class="nt">count</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero_noflag&#39;</span>

    <span class="nt">aggregates</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">quantity</span><span class="p">:</span>
          <span class="nt">total</span><span class="p">:</span> <span class="s">&quot;*&quot;</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;count&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>

<span class="nt">feature_group_definition</span><span class="p">:</span>
   <span class="nt">prefix</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;inspections&#39;</span>

<span class="nt">feature_group_strategies</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>
</pre></div>

<p>If we observe the image generated from the <code>temporal_config</code> section, each particular date is the beginning of the rectangles that describes the rows in the matrix. In that date (<code>as_of_date</code> in <code>timechop</code> parlance) we will calculate both features, and we will repeat that for every other rectangle in that image.</p>
<p>Now, let's discuss how we will specify the models to try (remember that the model is specified by the algorithm, the hyperparameters, and the subset of features to use). In <code>triage</code> you need to specify in the <code>grid_config</code> section a list of machine learning algorithms that you want to train and a list of hyperparameters. You can use any algorithm that you want; the only requirement is that it respects the <code>sklearn</code> API.</p>
<div class="highlight"><pre><span></span><span class="nt">grid_config</span><span class="p">:</span>
    <span class="nt">&#39;sklearn.dummy.DummyClassifier&#39;</span><span class="p">:</span>
        <span class="nt">strategy</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">prior</span><span class="p p-Indicator">,</span><span class="nv">uniform</span><span class="p p-Indicator">,</span> <span class="nv">most_frequent</span><span class="p p-Indicator">]</span>
</pre></div>

<p>Finally, we should define wich metrics we care about for evaluating our model. Here we will concentrate only in <code>precision</code> and <code>recall</code> at an specific value <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> <sup><a id="fnr.48" class="footref" href="#fn.48">48</a></sup>.</p>
<p>In this setting <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> represents the resource’s constraint: It is the number of inspections that the city could do in a month given all the inspectors available.</p>
<div class="highlight"><pre><span></span><span class="nt">scoring</span><span class="p">:</span>
    <span class="nt">testing_metric_groups</span><span class="p">:</span>
        <span class="p p-Indicator">-</span>
          <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
          <span class="nt">thresholds</span><span class="p">:</span>
            <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
            <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>

    <span class="nt">training_metric_groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">accuracy</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
        <span class="nt">thresholds</span><span class="p">:</span>
          <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
          <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>
</pre></div>

<p>You should be warned that precision and recall at <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> in this setting is kind of ill-defined (because you will end with a lot of <code>NULL</code> labels, remember, only a few of facilities are inspected in each period)<sup><a id="fnr.49" class="footref" href="#fn.49">49</a></sup>.</p>
<p>We will want a <strong>list</strong> of facilities to be inspected. The length of our list is constrained by our inspection resources, i.e. the answer to the question <em>How many facilities can I inspect in a month?</em> In this experiment we are assuming that the maximum capacity is <strong>10%</strong> but we are evaluating for a larger space of possibilities (see <code>top_n</code>, <code>percentiles</code> above).</p>
<p>The execution of the experiments can take a long time, so it is a good practice to <em>validate</em> the configuration file <em>before</em> running the model. You don't want to wait for hours (or days) and then discover that something went wrong.</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_baseline.yaml  --validate-only
</pre></div>

<p>If everything was ok, you should see an <code>Experiment validation ran to completion with no errors</code>.</p>
<p>You can execute the experiment as<sup><a id="fnr.50" class="footref" href="#fn.50">50</a></sup></p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment --matrix-format hdf experiments/inspections_baseline.yaml --profile
</pre></div>

<p>This will print a lot of output, and if everything is correct it will create <strong>6</strong> matrices (3 for training, 3 for testing) in <code>triage/matrices</code> and every matrix will be represented by two files, one with the metadata of the matrix (a <code>yaml</code> file) and one with the actual matrix (the <code>h5</code> file).</p>
<div class="highlight"><pre><span></span><span class="c1"># We will use some bash magic</span>

ls matrices <span class="p">|</span> awk -F . <span class="s1">&#39;{print $NF}&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq -c
</pre></div>

<p><code>Triage</code> also will store <strong>9</strong> trained models in <code>triage/trained_models</code>:</p>
<div class="highlight"><pre><span></span>ls trained_models <span class="p">|</span> wc -l
</pre></div>

<p>And it will populate the <code>results</code> schema in the database. As mentioned, we will get <strong>3</strong> <em>model groups</em>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>type</sub></th>
<th>hyperparameters</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "prior"}</td>
</tr>
<tr>
<td>2</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "uniform"}</td>
</tr>
<tr>
<td>3</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
</tr>
</tbody>
</table>
<p>And <strong>9</strong> <em>models</em>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">train_end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_end_times</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>models</th>
<th>train<sub>end</sub><sub>times</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>{1,4,7}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>2</td>
<td>{2,5,8}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>3</td>
<td>{3,6,9}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
</tbody>
</table>
<p>From that last query, you should note that the order in which <code>triage</code> trains the models is from oldest to newest <code>train_end_time</code> and <code>model_group</code> , also in ascending order. It will not go to the next block until all the <em>models groups</em> are trained.</p>
<p>You can check with which matrix the models are trained:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_id</span><span class="p">,</span> <span class="n">train_end_time</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">model_hash</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">model_hash</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">train_matrix_uuid</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_matrix_uuid</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span> <span class="k">as</span> <span class="n">observations</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">lookback_duration</span> <span class="k">as</span> <span class="n">feature_lookback_duration</span><span class="p">,</span>  <span class="n">ma</span><span class="p">.</span><span class="n">feature_start_time</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">join</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">matrices</span> <span class="k">as</span> <span class="n">ma</span>
    <span class="k">on</span> <span class="n">train_matrix_uuid</span> <span class="o">=</span> <span class="n">matrix_uuid</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>id</sub></th>
<th>train<sub>end</sub><sub>time</sub></th>
<th>model<sub>hash</sub></th>
<th>train<sub>matrix</sub><sub>uuid</sub></th>
<th>observations</th>
<th>feature<sub>lookback</sub><sub>duration</sub></th>
<th>feature<sub>start</sub><sub>time</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>2015-12-01 00:00:00</td>
<td>ff2f3</td>
<td>a4455</td>
<td>6715</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>2016-12-01 00:00:00</td>
<td>faf2f</td>
<td>bf455</td>
<td>15104</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>1</td>
<td>7</td>
<td>2017-12-01 00:00:00</td>
<td>faf19</td>
<td>b0237</td>
<td>22860</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>2015-12-01 00:00:00</td>
<td>1435f</td>
<td>a4455</td>
<td>6715</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>2</td>
<td>5</td>
<td>2016-12-01 00:00:00</td>
<td>3ad95</td>
<td>bf455</td>
<td>15104</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>2</td>
<td>8</td>
<td>2017-12-01 00:00:00</td>
<td>cc595</td>
<td>b0237</td>
<td>22860</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>2015-12-01 00:00:00</td>
<td>cdf77</td>
<td>a4455</td>
<td>6715</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
<td>2016-12-01 00:00:00</td>
<td>83ed9</td>
<td>bf455</td>
<td>15104</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9</td>
<td>2017-12-01 00:00:00</td>
<td>67a54</td>
<td>b0237</td>
<td>22860</td>
<td>@ 5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
</tbody>
</table>
<p>As expected, we have three models per model group. Each model was trained with the matrix indicated in the column <code>train_matrix_uuid</code>. This <code>uuid</code> is the file name of the stored matrix. The model itself was stored under the file named with the <code>model_hash</code>.</p>
<p>If you want to see in which matrix the model was <em>tested</em> you need to run the following query</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">model_group_id</span><span class="p">,</span> <span class="n">train_end_time</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">model_hash</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">model_hash</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">matrix_uuid</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">test_matrix_uuid</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span> <span class="k">as</span> <span class="n">observations</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">lookback_duration</span> <span class="k">as</span> <span class="n">feature_lookback_duration</span><span class="p">,</span>  <span class="n">ma</span><span class="p">.</span><span class="n">feature_start_time</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span> <span class="k">as</span> <span class="n">ev</span> <span class="k">using</span> <span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="k">join</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">matrices</span> <span class="k">as</span> <span class="n">ma</span> <span class="k">on</span> <span class="n">ev</span><span class="p">.</span><span class="n">matrix_uuid</span> <span class="o">=</span> <span class="n">ma</span><span class="p">.</span><span class="n">matrix_uuid</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">,</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>id</sub></th>
<th>model<sub>group</sub><sub>id</sub></th>
<th>train<sub>end</sub><sub>time</sub></th>
<th>model<sub>hash</sub></th>
<th>test<sub>matrix</sub><sub>uuid</sub></th>
<th>observations</th>
<th>feature<sub>lookback</sub><sub>duration</sub></th>
<th>feature<sub>start</sub><sub>time</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>2015-12-01 00:00:00</td>
<td>ff2f3</td>
<td>865e3</td>
<td>69472</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>2016-12-01 00:00:00</td>
<td>faf2f</td>
<td>3f3e1</td>
<td>66275</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>7</td>
<td>1</td>
<td>2017-12-01 00:00:00</td>
<td>faf19</td>
<td>4203c</td>
<td>62194</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>2015-12-01 00:00:00</td>
<td>1435f</td>
<td>865e3</td>
<td>69472</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>2016-12-01 00:00:00</td>
<td>3ad95</td>
<td>3f3e1</td>
<td>66275</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>8</td>
<td>2</td>
<td>2017-12-01 00:00:00</td>
<td>cc595</td>
<td>4203c</td>
<td>62194</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>2015-12-01 00:00:00</td>
<td>cdf77</td>
<td>865e3</td>
<td>69472</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
<td>2016-12-01 00:00:00</td>
<td>83ed9</td>
<td>3f3e1</td>
<td>66275</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>9</td>
<td>3</td>
<td>2017-12-01 00:00:00</td>
<td>67a54</td>
<td>4203c</td>
<td>62194</td>
<td>@ 1 year</td>
<td>2010-01-04 00:00:00</td>
</tr>
</tbody>
</table>
<p>All the models were stored in <code>/triage/trained_models/{model_hash}</code> using the standard serialization of sklearn models. Every model was trained with the matrix <code>train_matrix_uuid</code> stored in the directory <code>/triage/matrices</code>.</p>
<p>What's the performance of this model groups?</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="k">set</span> <span class="n">k</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span>

<span class="k">select</span> <span class="k">distinct</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">feature_start_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">train_end_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_end_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">observations</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_examples</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;total labeled examples&quot;</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_positive_labels</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;total positive labels&quot;</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_positive_labels</span><span class="o">*</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_examples</span><span class="p">,</span> <span class="s1">&#39;0.999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">baserate</span><span class="p">,</span>
    <span class="p">:</span><span class="n">k</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">as</span> <span class="ss">&quot;k%&quot;</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;labeled examples @ 10%&quot;</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(:</span><span class="n">k</span> <span class="o">*</span> <span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;predicted positive (PP) @ 10%&quot;</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;true positive (TP) @ 10%&quot;</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;0.999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;precision@10%&quot;</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span> <span class="k">as</span> <span class="n">ev</span> <span class="k">using</span> <span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="k">join</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">matrices</span> <span class="k">as</span> <span class="n">ma</span> <span class="k">on</span> <span class="n">ev</span><span class="p">.</span><span class="n">matrix_uuid</span> <span class="o">=</span> <span class="n">ma</span><span class="p">.</span><span class="n">matrix_uuid</span>
<span class="k">where</span>
    <span class="n">ev</span><span class="p">.</span><span class="n">metric</span> <span class="o">||</span> <span class="n">ev</span><span class="p">.</span><span class="k">parameter</span> <span class="o">=</span> <span class="s1">&#39;precision@10_pct&#39;</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_id</span><span class="p">,</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>id</sub></th>
<th>feature<sub>start</sub><sub>time</sub></th>
<th>train<sub>end</sub><sub>time</sub></th>
<th>evaluation<sub>start</sub><sub>time</sub></th>
<th>evaluation<sub>end</sub><sub>time</sub></th>
<th>observations</th>
<th>total labeled examples</th>
<th>total positive labels</th>
<th>baserate</th>
<th>k%</th>
<th>labeled examples @ 10%</th>
<th>predicted positive (PP) @ 10%</th>
<th>true positive (TP) @ 10%</th>
<th>precision@10%</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>2010-01-04</td>
<td>2015-12-01</td>
<td>2015-12-01</td>
<td>2016-11-01</td>
<td>69,472</td>
<td>8,389</td>
<td>2,326</td>
<td>0.277</td>
<td>10.0</td>
<td>824</td>
<td>6,947</td>
<td>243</td>
<td>0.295</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>2010-01-04</td>
<td>2015-12-01</td>
<td>2015-12-01</td>
<td>2016-11-01</td>
<td>69,472</td>
<td>8,389</td>
<td>2,326</td>
<td>0.277</td>
<td>10.0</td>
<td>824</td>
<td>6,947</td>
<td>243</td>
<td>0.295</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>2010-01-04</td>
<td>2015-12-01</td>
<td>2015-12-01</td>
<td>2016-11-01</td>
<td>69,472</td>
<td>8,389</td>
<td>2,326</td>
<td>0.277</td>
<td>10.0</td>
<td>824</td>
<td>6,947</td>
<td>243</td>
<td>0.295</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>2010-01-04</td>
<td>2016-12-01</td>
<td>2016-12-01</td>
<td>2017-11-01</td>
<td>66,275</td>
<td>7,756</td>
<td>2,077</td>
<td>0.268</td>
<td>10.0</td>
<td>811</td>
<td>6,628</td>
<td>196</td>
<td>0.242</td>
</tr>
<tr>
<td>2</td>
<td>5</td>
<td>2010-01-04</td>
<td>2016-12-01</td>
<td>2016-12-01</td>
<td>2017-11-01</td>
<td>66,275</td>
<td>7,756</td>
<td>2,077</td>
<td>0.268</td>
<td>10.0</td>
<td>811</td>
<td>6,628</td>
<td>196</td>
<td>0.242</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
<td>2010-01-04</td>
<td>2016-12-01</td>
<td>2016-12-01</td>
<td>2017-11-01</td>
<td>66,275</td>
<td>7,756</td>
<td>2,077</td>
<td>0.268</td>
<td>10.0</td>
<td>811</td>
<td>6,628</td>
<td>196</td>
<td>0.242</td>
</tr>
<tr>
<td>1</td>
<td>7</td>
<td>2010-01-04</td>
<td>2017-12-01</td>
<td>2017-12-01</td>
<td>2018-11-01</td>
<td>62,194</td>
<td>5,619</td>
<td>1,462</td>
<td>0.260</td>
<td>10.0</td>
<td>546</td>
<td>6,219</td>
<td>137</td>
<td>0.251</td>
</tr>
<tr>
<td>2</td>
<td>8</td>
<td>2010-01-04</td>
<td>2017-12-01</td>
<td>2017-12-01</td>
<td>2018-11-01</td>
<td>62,194</td>
<td>5,619</td>
<td>1,462</td>
<td>0.260</td>
<td>10.0</td>
<td>546</td>
<td>6,219</td>
<td>137</td>
<td>0.251</td>
</tr>
<tr>
<td>3</td>
<td>9</td>
<td>2010-01-04</td>
<td>2017-12-01</td>
<td>2017-12-01</td>
<td>2018-11-01</td>
<td>62,194</td>
<td>5,619</td>
<td>1,462</td>
<td>0.260</td>
<td>10.0</td>
<td>546</td>
<td>6,219</td>
<td>137</td>
<td>0.251</td>
</tr>
</tbody>
</table>
<p>The columns <code>num_labeled_examples, num_labeled_above_threshold, num_positive_labels</code> represent the number of selected entities on the prediction date that are labeled, the number of entities with a positive label above the threshold, and the number of entities with positive labels among all the labeled entities respectively.</p>
<p>We added some extra columns: <code>baserate</code>, <code>=predicted positive (PP)</code> and <code>true positive (TP)</code>. <em>Baserate</em> represents the proportion of the all the facilities that were inspected that failed the inspection, i.e. <span><span class="MathJax_Preview">P(V|I)</span><script type="math/tex">P(V|I)</script></span>. The <code>PP</code> and <code>TP</code> are approximate since it were calculated using the value of <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span>. But you could get the exact value of those from the <code>test_results.predictions</code> table.</p>
<blockquote>
<p>Note that the <em>baserate</em> should be equal to the <em>precision@100%</em>, if is not there is something wrong …</p>
</blockquote>
<h4>Creating a simple experiment: ML as a Data Mining technique</h4>
<p>We will try one of the simplest machine learning algorithms: a <strong>Decision Tree Classifier</strong> (<em>DT</em>) as a second experiment. The rationale of this is that the DT is very fast to train (so it will help us to verify that the experiment configuration is correct without waiting for a long time) and it helps you to understand the structure of your data.</p>
<p>The config file for this first experiment is located in &lt;./triage/experiments/inspections_dt.yaml&gt;</p>
<p>Note that we don't modify the <code>temporal_config</code> section neither the <code>feature_aggregations</code>, <code>cohort_config</code> or <code>label_config</code>. Triage is smart enough to use the previous tables and matrices instead of generating them from scratch.</p>
<div class="highlight"><pre><span></span><span class="nt">config_version</span><span class="p">:</span> <span class="s">&#39;v6&#39;</span>

<span class="nt">model_comment</span><span class="p">:</span> <span class="nt">&#39;inspections</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DT&#39;</span>

<span class="nt">user_metadata</span><span class="p">:</span>
  <span class="nt">label_definition</span><span class="p">:</span> <span class="s">&#39;failed&#39;</span>
  <span class="nt">experiment_type</span><span class="p">:</span> <span class="s">&#39;inspections</span><span class="nv"> </span><span class="s">prioritization&#39;</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Decision Tree Classifier</span>
  <span class="nt">purpose</span><span class="p">:</span> <span class="s">&#39;data</span><span class="nv"> </span><span class="s">mining&#39;</span>
  <span class="nt">org</span><span class="p">:</span> <span class="s">&#39;DSaPP&#39;</span>
  <span class="nt">team</span><span class="p">:</span> <span class="s">&#39;Tutorial&#39;</span>
  <span class="nt">author</span><span class="p">:</span> <span class="s">&#39;Your</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">here&#39;</span>
  <span class="nt">etl_date</span><span class="p">:</span> <span class="s">&#39;2019-02-21&#39;</span>
</pre></div>

<p>Note that we don't modify the <code>temporal_config</code> section neither the <code>cohort_config</code> or <code>label_config</code>. Triage is smart enough to use the previous tables and matrices instead of generating them from scratch.</p>
<p>For this experiment, we will add the following features:</p>
<ul>
<li>
<p>Number of different types of inspections the facility had in the last year (calculated for an as-of date).</p>
</li>
<li>
<p>Number of different types of inspections that happened in the zip code in the last year from a particular day.</p>
</li>
<li>
<p>Number of inspections</p>
</li>
<li>
<p>Number/proportion of inspections by result type</p>
</li>
<li>
<p>Number/proportion of times that a facility was classify with particular risk level</p>
</li>
</ul>
<p>In all of them we will do the aggregation in the last month, 3 months, 6 months, 1 year and historically. Remember that all this refers to events in the past, i.e. <em>How many times the facility was marked with high risk in the previous 3 Months?</em>, <em>What is the proportion of failed inspections in the previous year?</em></p>
<div class="highlight"><pre><span></span><span class="nt">feature_aggregations</span><span class="p">:</span>
  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;inspections&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">aggregates_imputation</span><span class="p">:</span>
      <span class="nt">count</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero_noflag&#39;</span>

    <span class="nt">aggregates</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">quantity</span><span class="p">:</span>
          <span class="nt">total</span><span class="p">:</span> <span class="s">&quot;*&quot;</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;count&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;risks&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">sum</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero&#39;</span>
      <span class="nt">avg</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero&#39;</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">&#39;risk&#39;</span>
        <span class="nt">choices</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;low&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;medium&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;high&#39;</span><span class="p p-Indicator">]</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;sum&#39;</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;avg&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;zip_code&#39;</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;results&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">all</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero&#39;</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">&#39;result&#39;</span>
        <span class="nt">choice_query</span><span class="p">:</span> <span class="s">&#39;select</span><span class="nv"> </span><span class="s">distinct</span><span class="nv"> </span><span class="s">result</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">semantic.events&#39;</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;sum&#39;</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;avg&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;inspection_types&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">sum</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero_noflag&#39;</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">&#39;type&#39;</span>
        <span class="nt">choice_query</span><span class="p">:</span> <span class="s">&#39;select</span><span class="nv"> </span><span class="s">distinct</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">semantic.events</span><span class="nv"> </span><span class="s">where</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">null&#39;</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;sum&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;zip_code&#39;</span>
</pre></div>

<p>And as stated, we will train some Decision Trees, in particular we are interested in a shallow tree, and in a full grown tree. Both trees will show you the structure of your data. We also we train a middle size tree.</p>
<div class="highlight"><pre><span></span><span class="nt">grid_config</span><span class="p">:</span>
    <span class="nt">&#39;sklearn.tree.DecisionTreeClassifier&#39;</span><span class="p">:</span>
        <span class="nt">max_depth</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="nv">~</span><span class="p p-Indicator">]</span>
        <span class="nt">min_samples_split</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">5</span><span class="p p-Indicator">]</span>
</pre></div>

<p>Some of the parameters in <code>sklearn</code> are <code>None</code>. If you want to try those you need to indicate it with <code>yaml</code>'s <code>null</code> or <code>~</code> keyword.</p>
<p>Besides the algorithm and the hyperparameters, you should specify which subset of features use. First, in the section <code>feature_group_definition</code> you specify how to group the features (you can use the <code>table name</code> or the <code>prefix</code> from the section <code>feature_aggregation</code>) and then a <em>strategy</em> for choosing the subsets: <code>all</code> (all the subsets at once), <code>leave-one-out</code> (try all the subsets except one, do that for all the combinations), or <code>leave-one-in</code> (just try subset at the time).</p>
<div class="highlight"><pre><span></span><span class="nt">feature_group_definition</span><span class="p">:</span>
   <span class="nt">prefix</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;inspections&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;results&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;risks&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;inspection_types&#39;</span>

<span class="nt">feature_group_strategies</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>
</pre></div>

<p>Finally we will leave the <code>scoring</code> section as before.</p>
<p>In this experiment we will end with <strong>6</strong> model groups (number of algorithms [1] <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> number of hyperparameter combinations [2 <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> 3 = 5] <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> number of feature groups strategies [1]]). Also, we will create <strong>18</strong> models (3 per model group) given that we have 3 temporal blocks (one model per temporal group).</p>
<p>Before running the experiment, remember to validate that the configuration is correct:</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_dt.yaml  --validate-only
</pre></div>

<p>and check the temporal cross validation:</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_dt.yaml --show-timechop
</pre></div>

<p><img alt="img" src="triage/images/inspections_dt.png" title="Temporal blocks for inspections experiment. The label is a failed inspection in the next month." /></p>
<p>You can execute the experiment like this:</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment --matrix-format hdf experiments/inspections_dt.yaml  --profile
</pre></div>

<p>After the experiment finishes, you will get <strong>6</strong> new <code>model_groups</code> (1 per combination in <code>grid_config</code>)</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span>
<span class="k">where</span>
    <span class="n">model_group_id</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>type</sub></th>
<th>hyperparameters</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2, "min<sub>samples</sub><sub>split</sub>": 2}</td>
</tr>
<tr>
<td>5</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2, "min<sub>samples</sub><sub>split</sub>": 5}</td>
</tr>
<tr>
<td>6</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 10, "min<sub>samples</sub><sub>split</sub>": 2}</td>
</tr>
<tr>
<td>7</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 10, "min<sub>samples</sub><sub>split</sub>": 5}</td>
</tr>
<tr>
<td>8</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null, "min<sub>samples</sub><sub>split</sub>": 2}</td>
</tr>
<tr>
<td>9</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null, "min<sub>samples</sub><sub>split</sub>": 5}</td>
</tr>
</tbody>
</table>
<p>and <strong>18</strong> models</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">train_end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_end_times</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span>
<span class="k">where</span>
    <span class="n">model_group_id</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>models</th>
<th>train<sub>end</sub><sub>times</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>{10,16,22}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>5</td>
<td>{11,17,23}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>6</td>
<td>{12,18,24}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>7</td>
<td>{13,19,25}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>8</td>
<td>{14,20,26}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>9</td>
<td>{15,21,27}</td>
<td>{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
</tbody>
</table>
<p>Let's see the performance over time of the models so far:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span><span class="p">::</span><span class="nb">date</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">evaluation_start_time</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">evaluation_end_time</span><span class="p">::</span><span class="nb">date</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">evaluation_end_time</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_examples</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">labeled_examples</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">labeled_above_threshold</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_positive_labels</span><span class="p">,</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_positive_labels</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;0.999&#39;</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;precision@10%&quot;</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span> <span class="k">as</span> <span class="n">mg</span> <span class="k">using</span><span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span>  <span class="k">as</span> <span class="n">ev</span> <span class="k">using</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<span class="k">where</span>
     <span class="n">mg</span><span class="p">.</span><span class="n">model_config</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;experiment_type&#39;</span> <span class="o">~</span> <span class="s1">&#39;inspection&#39;</span>
     <span class="k">and</span>
     <span class="n">ev</span><span class="p">.</span><span class="n">metric</span><span class="o">||</span><span class="n">ev</span><span class="p">.</span><span class="k">parameter</span> <span class="o">=</span> <span class="s1">&#39;precision@10_pct&#39;</span>
     <span class="k">and</span> <span class="n">model_group_id</span> <span class="o">&lt;=</span> <span class="mi">9</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>models</th>
<th>evaluation<sub>start</sub><sub>time</sub></th>
<th>evaluation<sub>end</sub><sub>time</sub></th>
<th>labeled<sub>examples</sub></th>
<th>labeled<sub>above</sub><sub>threshold</sub></th>
<th>total<sub>positive</sub><sub>labels</sub></th>
<th>precision@10%</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>{1,4,7}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     824","     811","     546"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.295"," 0.242"," 0.251"}</td>
</tr>
<tr>
<td>2</td>
<td>{2,5,8}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     824","     811","     546"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.295"," 0.242"," 0.251"}</td>
</tr>
<tr>
<td>3</td>
<td>{3,6,9}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     824","     811","     546"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.295"," 0.242"," 0.251"}</td>
</tr>
<tr>
<td>4</td>
<td>{10,16,22}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     871","     702","     517"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.445"," 0.392"," 0.342"}</td>
</tr>
<tr>
<td>5</td>
<td>{11,17,23}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     871","     702","     517"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.445"," 0.392"," 0.342"}</td>
</tr>
<tr>
<td>6</td>
<td>{12,18,24}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     710","     795","     527"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.337"," 0.325"," 0.347"}</td>
</tr>
<tr>
<td>7</td>
<td>{13,19,25}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     689","     798","     517"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.347"," 0.286"," 0.346"}</td>
</tr>
<tr>
<td>8</td>
<td>{14,20,26}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     766","     743","     508"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.343"," 0.328"," 0.274"}</td>
</tr>
<tr>
<td>9</td>
<td>{15,21,27}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{2016-11-01,2017-11-01,2018-11-01}</td>
<td>{"   8,389","   7,756","   5,619"}</td>
<td>{"     773","     809","     513"}</td>
<td>{"   2,326","   2,077","   1,462"}</td>
<td>{" 0.347"," 0.326"," 0.285"}</td>
</tr>
</tbody>
</table>
<p>Which model in production (<em>model selection</em>) is something that we will review later, with <code>Audition</code>, but for now, let's choose the model group <code>5</code> and see the <code>predictions</code> table:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="n">as_of_date</span><span class="p">,</span>
    <span class="n">score</span><span class="p">,</span>
    <span class="n">label_value</span> <span class="k">as</span> <span class="n">label</span>
<span class="k">from</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">predictions</span>
<span class="k">where</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="mi">11</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">as_of_date</span> <span class="k">asc</span><span class="p">,</span> <span class="n">score</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">20</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>id</sub></th>
<th>entity<sub>id</sub></th>
<th>as<sub>of</sub><sub>date</sub></th>
<th>score</th>
<th>label</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>147</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>1</td>
</tr>
<tr>
<td>11</td>
<td>252</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>78</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>1</td>
</tr>
<tr>
<td>11</td>
<td>143</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>172</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>226</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>43</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>72</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>95</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>130</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>30</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>160</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>208</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>222</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>1</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>27</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>49</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>53</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>84</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
<tr>
<td>11</td>
<td>295</td>
<td>2015-12-01 00:00:00</td>
<td>0.387987012987013</td>
<td>¤</td>
</tr>
</tbody>
</table>
<p><strong>NOTE:</strong> Given that this is a <em>shallow</em> tree, there will be a lot of entities with the same <em>score</em>,you probably will get a different set of entities, since <code>postgresql</code> will sort them at random</p>
<p>Note that at the top of the list (sorted by <code>as_of_date</code>, and then by <code>score</code>), the <em>labels</em> are <code>NULL</code>. This means that the facilities that you are classifying as high risk, actually weren't inspected in that <em>as of date</em>. So, you actually don't know if this is a correct prediction or not.</p>
<p>This is a <strong>characteristic</strong> of all the resource optimization problems: You do not have all the information about the elements in your system<sup><a id="fnr.51" class="footref" href="#fn.51">51</a></sup>.</p>
<p>So, how the precision/recall is calculated? The number that is show in the <code>evaluations</code> table is calculated using only the rows that have a non-null label. You could argue that this is fine, if you assume that the distribution of the label in the non-observed facilities is the same that the ones that were inspected that month<sup><a id="fnr.52" class="footref" href="#fn.52">52</a></sup>. We will come back to this problem in the Early Warning problem.</p>
<p>There is a second problem: <em>How do you break ties in the score?</em> If you run the previous query you will see why. The order within all the equal scores will be <em>random</em>. This again will affect the calculation of your metrics. One potential solution to this is calculate the metric in the <em>best case scenario</em> (all the true labels are at the top), and then in the <em>worst case scenario</em> (all the true labels are at the bottom) and then calculate the metric several times with the labels shuffled, so you get the <em>mean</em> metric, plus some confidence intervals. This second problem is <strong>not</strong> specific of an inspection problem, is more related to simple models like a shallow Decision Tree or a Dummy Classifier.</p>
<h4>A more advanced experiment</h4>
<p>Ok, let's add a more complete experiment. First the usual generalities.</p>
<div class="highlight"><pre><span></span><span class="nt">config_version</span><span class="p">:</span> <span class="s">&#39;v6&#39;</span>

<span class="nt">model_comment</span><span class="p">:</span> <span class="nt">&#39;inspections</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">advanced&#39;</span>

<span class="nt">user_metadata</span><span class="p">:</span>
  <span class="nt">label_definition</span><span class="p">:</span> <span class="s">&#39;failed&#39;</span>
  <span class="nt">experiment_type</span><span class="p">:</span> <span class="s">&#39;inspections</span><span class="nv"> </span><span class="s">prioritization&#39;</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Using Ensamble methods</span>
  <span class="nt">purpose</span><span class="p">:</span> <span class="s">&#39;trying</span><span class="nv"> </span><span class="s">ensamble</span><span class="nv"> </span><span class="s">algorithms&#39;</span>
  <span class="nt">org</span><span class="p">:</span> <span class="s">&#39;DSaPP&#39;</span>
  <span class="nt">team</span><span class="p">:</span> <span class="s">&#39;Tutorial&#39;</span>
  <span class="nt">author</span><span class="p">:</span> <span class="s">&#39;Your</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">here&#39;</span>
  <span class="nt">etl_date</span><span class="p">:</span> <span class="s">&#39;2019-02-21&#39;</span>
</pre></div>

<p>We won't change anything related to features, cohort and label definition neither to temporal configuration.</p>
<p>As before, we can check the temporal structure of our crossvalidation:</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_label_failed_01.yaml --show-timechop
</pre></div>

<p><img alt="img" src="triage/images/inspections_label_failed_01.png" title="Temporal blocks for inspections experiment. The label is a failed inspection in the next month." /></p>
<p>We want to use all the features groups (<code>feature_group_definition</code>). The training will be made on matrices with <code>all</code> the feature groups, then leaving one feature group out at a time, <code>leave-one-out</code> (i.e. one model with <code>inspections</code> and <code>results</code>, another with <code>inspections</code> and <code>risks</code>, and another with <code>results</code> and <code>risks), and finally leaving one feature group in at a time (i.e. a model with =inspections</code> only, another with <code>results</code> only, and a third with <code>risks</code> only).</p>
<div class="highlight"><pre><span></span><span class="nt">feature_group_definition</span><span class="p">:</span>
   <span class="nt">prefix</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;inspections&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;results&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;risks&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;inspection_types&#39;</span>

<span class="nt">feature_group_strategies</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;all&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;leave-one-in&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;leave-one-out&#39;</span><span class="p p-Indicator">]</span>
</pre></div>

<p>Finally, we will try some <code>RandomForestClassifier</code>:</p>
<div class="highlight"><pre><span></span><span class="nt">grid_config</span><span class="p">:</span>
    <span class="nt">&#39;sklearn.ensemble.RandomForestClassifier&#39;</span><span class="p">:</span>
        <span class="nt">max_features</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;sqrt&#39;</span><span class="p p-Indicator">]</span>
        <span class="nt">criterion</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;gini&#39;</span><span class="p p-Indicator">]</span>
        <span class="nt">n_estimators</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">]</span>
        <span class="nt">min_samples_split</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">10</span><span class="p p-Indicator">]</span>

<span class="nt">scoring</span><span class="p">:</span>
    <span class="nt">testing_metric_groups</span><span class="p">:</span>
        <span class="p p-Indicator">-</span>
          <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
          <span class="nt">thresholds</span><span class="p">:</span>
            <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
            <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>

    <span class="nt">training_metric_groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">accuracy</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
        <span class="nt">thresholds</span><span class="p">:</span>
          <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
          <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>
</pre></div>

<p>Before running, let's verify the configuration file</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_label_failed_01.yaml  --validate-only
</pre></div>

<p>You can execute the experiment with</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment --matrix-format hdf experiments/inspections_label_failed_01.yaml  --profile
</pre></div>

<p>This will take a looooong time to run. The reason for that is easy to understand: We are computing a <em>lot</em> of models: 3 time splits, 4 model groups and 9 features sets (one for <code>all</code>, four for <code>leave_one_in</code> and four for <code>leave_one_out</code>), so <span><span class="MathJax_Preview">3 \times 4 \times 9 = 108</span><script type="math/tex">3 \times 4 \times 9 = 108</script></span> extra models.</p>
<p>Well, now we have a lot of models. How can you pick the best one? You could try the following query:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">features_groups</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">split_part</span><span class="p">(</span><span class="k">unnest</span><span class="p">(</span><span class="n">feature_list</span><span class="p">),</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">feature_groups</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span>
<span class="p">),</span>

<span class="n">features_arrays</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="k">distinct</span> <span class="n">feature_groups</span><span class="p">)</span> <span class="k">as</span> <span class="n">feature_groups</span>
<span class="k">from</span>
    <span class="n">features_groups</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">feature_groups</span><span class="p">,</span>
     <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;0.999&#39;</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;precision@&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;precision@10%&quot;</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;0.999&#39;</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;recall@&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;recall@10%&quot;</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span>
    <span class="k">join</span>
    <span class="n">features_arrays</span> <span class="k">using</span><span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
    <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span> <span class="k">using</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<span class="k">where</span>
    <span class="n">model_comment</span> <span class="o">~</span> <span class="s1">&#39;inspection&#39;</span>
<span class="k">and</span>
    <span class="k">parameter</span> <span class="o">=</span> <span class="s1">&#39;10_pct&#39;</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">feature_groups</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>type</sub></th>
<th>hyperparameters</th>
<th>feature<sub>groups</sub></th>
<th>precision@10%</th>
<th>recall@10%</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "prior"}</td>
<td>{inspections}</td>
<td>{" 0.295"," 0.242"," 0.251"}</td>
<td>{" 0.104"," 0.094"," 0.094"}</td>
</tr>
<tr>
<td>2</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "uniform"}</td>
<td>{inspections}</td>
<td>{" 0.295"," 0.242"," 0.251"}</td>
<td>{" 0.104"," 0.094"," 0.094"}</td>
</tr>
<tr>
<td>3</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspections}</td>
<td>{" 0.295"," 0.242"," 0.251"}</td>
<td>{" 0.104"," 0.094"," 0.094"}</td>
</tr>
<tr>
<td>4</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.445"," 0.392"," 0.342"}</td>
<td>{" 0.167"," 0.132"," 0.121"}</td>
</tr>
<tr>
<td>5</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2, "min<sub>samples</sub><sub>split</sub>": 5}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.445"," 0.392"," 0.342"}</td>
<td>{" 0.167"," 0.132"," 0.121"}</td>
</tr>
<tr>
<td>6</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 10, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.337"," 0.325"," 0.347"}</td>
<td>{" 0.103"," 0.124"," 0.125"}</td>
</tr>
<tr>
<td>7</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 10, "min<sub>samples</sub><sub>split</sub>": 5}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.347"," 0.286"," 0.346"}</td>
<td>{" 0.103"," 0.110"," 0.122"}</td>
</tr>
<tr>
<td>8</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.343"," 0.328"," 0.274"}</td>
<td>{" 0.113"," 0.117"," 0.095"}</td>
</tr>
<tr>
<td>9</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null, "min<sub>samples</sub><sub>split</sub>": 5}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.347"," 0.326"," 0.285"}</td>
<td>{" 0.115"," 0.127"," 0.100"}</td>
</tr>
<tr>
<td>10</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.430"," 0.369"," 0.451"}</td>
<td>{" 0.159"," 0.158"," 0.159"}</td>
</tr>
<tr>
<td>11</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.453"," 0.403"," 0.470"}</td>
<td>{" 0.177"," 0.160"," 0.169"}</td>
</tr>
<tr>
<td>12</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.441"," 0.387"," 0.462"}</td>
<td>{" 0.162"," 0.162"," 0.166"}</td>
</tr>
<tr>
<td>13</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.456"," 0.383"," 0.469"}</td>
<td>{" 0.172"," 0.158"," 0.170"}</td>
</tr>
<tr>
<td>14</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspections}</td>
<td>{" 0.342"," 0.310"," 0.285"}</td>
<td>{" 0.155"," 0.126"," 0.123"}</td>
</tr>
<tr>
<td>15</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspections}</td>
<td>{" 0.342"," 0.310"," 0.283"}</td>
<td>{" 0.155"," 0.126"," 0.121"}</td>
</tr>
<tr>
<td>16</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspections}</td>
<td>{" 0.342"," 0.310"," 0.297"}</td>
<td>{" 0.155"," 0.126"," 0.128"}</td>
</tr>
<tr>
<td>17</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspections}</td>
<td>{" 0.341"," 0.310"," 0.295"}</td>
<td>{" 0.154"," 0.126"," 0.131"}</td>
</tr>
<tr>
<td>18</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{results}</td>
<td>{" 0.359"," 0.330"," 0.389"}</td>
<td>{" 0.130"," 0.119"," 0.133"}</td>
</tr>
<tr>
<td>19</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{results}</td>
<td>{" 0.368"," 0.326"," 0.380"}</td>
<td>{" 0.132"," 0.115"," 0.129"}</td>
</tr>
<tr>
<td>20</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{results}</td>
<td>{" 0.390"," 0.361"," 0.395"}</td>
<td>{" 0.149"," 0.142"," 0.149"}</td>
</tr>
<tr>
<td>21</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{results}</td>
<td>{" 0.394"," 0.351"," 0.413"}</td>
<td>{" 0.147"," 0.134"," 0.154"}</td>
</tr>
<tr>
<td>22</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{risks}</td>
<td>{" 0.389"," 0.325"," 0.325"}</td>
<td>{" 0.141"," 0.129"," 0.142"}</td>
</tr>
<tr>
<td>23</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{risks}</td>
<td>{" 0.391"," 0.331"," 0.362"}</td>
<td>{" 0.144"," 0.128"," 0.154"}</td>
</tr>
<tr>
<td>24</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{risks}</td>
<td>{" 0.375"," 0.310"," 0.398"}</td>
<td>{" 0.139"," 0.127"," 0.165"}</td>
</tr>
<tr>
<td>25</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{risks}</td>
<td>{" 0.405"," 0.325"," 0.384"}</td>
<td>{" 0.141"," 0.113"," 0.158"}</td>
</tr>
<tr>
<td>26</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection}</td>
<td>{" 0.394"," 0.334"," 0.351"}</td>
<td>{" 0.154"," 0.147"," 0.143"}</td>
</tr>
<tr>
<td>27</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection}</td>
<td>{" 0.374"," 0.330"," 0.352"}</td>
<td>{" 0.142"," 0.142"," 0.138"}</td>
</tr>
<tr>
<td>28</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection}</td>
<td>{" 0.405"," 0.327"," 0.367"}</td>
<td>{" 0.154"," 0.143"," 0.150"}</td>
</tr>
<tr>
<td>29</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection}</td>
<td>{" 0.416"," 0.319"," 0.384"}</td>
<td>{" 0.160"," 0.135"," 0.159"}</td>
</tr>
<tr>
<td>30</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.446"," 0.380"," 0.441"}</td>
<td>{" 0.160"," 0.156"," 0.157"}</td>
</tr>
<tr>
<td>31</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.448"," 0.385"," 0.433"}</td>
<td>{" 0.167"," 0.164"," 0.161"}</td>
</tr>
<tr>
<td>32</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.440"," 0.394"," 0.483"}</td>
<td>{" 0.160"," 0.161"," 0.177"}</td>
</tr>
<tr>
<td>33</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.447"," 0.393"," 0.473"}</td>
<td>{" 0.168"," 0.162"," 0.171"}</td>
</tr>
<tr>
<td>34</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.391"," 0.342"," 0.348"}</td>
<td>{" 0.138"," 0.146"," 0.139"}</td>
</tr>
<tr>
<td>35</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.422"," 0.330"," 0.357"}</td>
<td>{" 0.146"," 0.140"," 0.146"}</td>
</tr>
<tr>
<td>36</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.411"," 0.341"," 0.365"}</td>
<td>{" 0.145"," 0.144"," 0.155"}</td>
</tr>
<tr>
<td>37</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.420"," 0.331"," 0.391"}</td>
<td>{" 0.142"," 0.138"," 0.150"}</td>
</tr>
<tr>
<td>38</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.444"," 0.389"," 0.453"}</td>
<td>{" 0.168"," 0.164"," 0.159"}</td>
</tr>
<tr>
<td>39</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.443"," 0.407"," 0.466"}</td>
<td>{" 0.165"," 0.167"," 0.166"}</td>
</tr>
<tr>
<td>40</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.443"," 0.387"," 0.453"}</td>
<td>{" 0.165"," 0.162"," 0.162"}</td>
</tr>
<tr>
<td>41</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.456"," 0.391"," 0.484"}</td>
<td>{" 0.177"," 0.170"," 0.173"}</td>
</tr>
<tr>
<td>42</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.434"," 0.374"," 0.446"}</td>
<td>{" 0.156"," 0.153"," 0.169"}</td>
</tr>
<tr>
<td>43</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.436"," 0.384"," 0.459"}</td>
<td>{" 0.165"," 0.159"," 0.174"}</td>
</tr>
<tr>
<td>44</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 100, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.433"," 0.374"," 0.464"}</td>
<td>{" 0.159"," 0.150"," 0.179"}</td>
</tr>
<tr>
<td>45</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 10}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.451"," 0.384"," 0.484"}</td>
<td>{" 0.172"," 0.161"," 0.181"}</td>
</tr>
</tbody>
</table>
<p>This table summarizes all our experiments, but it is very difficult to use if you want to choose the best combination of hyperparameters and algorithm (i.e. the model group). In the <code>postmodeling</code> section we will solve this dilemma with the support of <code>audition</code>.</p>
<h3>Selecting the best model</h3>
<p><strong>45</strong> <em>model groups</em>! How to pick the best one and use it for making predictions with <em>new</em> data? What do you mean by “the best”? This is not as easy as it sounds, due to several factors:</p>
<ul>
<li>You can try to pick the best using a metric specified in the config file (<code>precision@</code> and <code>recall@</code>), but at what point of time? Maybe different model groups are best at different prediction times.</li>
<li>You can just use the one that performs best on the last test set.</li>
<li>You can value a model group that provides consistent results over time. It might not be the best on any test set, but you can feel more confident that it will continue to perform similarly.</li>
<li>If there are several model groups that perform similarly and their lists are more or less similar, maybe it doesn't really matter which you pick.</li>
</ul>
<p>The answers to questions like these may not be obvious up front. Let’s discuss an imaginary example, that will help to clarify this<sup><a id="fnr.53" class="footref" href="#fn.53">53</a></sup></p>
<p><img alt="img" src="images/sanjose-2.png" title="A simplified example of our model evaluation process: three different models are trained using information prior to 2014, 2015, and 2016 and evaluated on what actually happened in those years. Looking at how each model performs over time allows us to balance stability and performance. (From Data-Driven Inspections for Safer Housing in San Jose, California)" /></p>
<p>The graphic above provides an imaginary example with three three different <em>models groups</em> on how they performed against the actual results of inspections in 2014, 2015, and 2016. In the <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>-axis, the date of the predictions, inn the <span><span class="MathJax_Preview">y</span><script type="math/tex">y</script></span>-axes the metric of interest (e.g. <em>precision</em>, <em>recall</em>, etc). Recall that the <em>models groups</em> differ in a number of ways, for instance: including or excluding different types of <em>features</em>, employing different algorithms or hyperparameters, or focusing on more or less recent information, this comes from <em>timechop configuration</em>, (e.g <em>how much past data</em> do you want to include).</p>
<p>We start by building a set of models that seek to predict what will happen in 2014, using only information that would have been available to inspectors before January 1, 2014. We then evaluate the models based on what actually happened in 2014. Repeating this process for 2015 and 2016 gives us an idea of how well — and how dependably — a given model is able to predict the future.</p>
<p>Now, for the selection you could have a reasoning process as follows:</p>
<ul>
<li>You can probably eliminate the yellow triangle model right off the bat.</li>
<li>If we only looked at 2016, we’d choose the light blue squares model, but although it does well in 2016, it performed the worst in 2015, so we don’t know if we can trust its performance – what if it dips back down in 2017? Then again, what if 2015 was just some sort of anomaly? We don’t know the future (which is why we need analysis like this), but we want to give ourselves the best advantage we can.</li>
<li>To balance consistency and performance, we choose a model that reliably performs well (blue circles), even if it’s not always the best.</li>
</ul>
<p>In this particular/imaginary example , the “selection process” was kind of easy. Of course,in real life we were choosing between more than three models; we just built and evaluated more than <strong>46</strong> <em>models groups</em>!</p>
<p>Remember, this is only one way of choose! You could have (or better, the organization could have) a different opinion about what consists a <em>best</em> model.</p>
<p>Triage provides this functionality in <code>audition</code> and in <code>postmodel</code>. At the moment of this writing, these two modules require more interaction (i.e. they aren't integrated with the <em>configuration file</em>).</p>
<p>Audition is a tool for picking the best trained classifiers from a predictive analytics experiment. Audition introduces a structured, semi-automated way of filtering models based on what you consider important.</p>
<p><code>Audition</code> formalizes this idea through <em>selection rules</em> that take in the data up to a given point in time, apply some rule to choose a model group, and then evaluate the performance (<strong>regret</strong>) of the chosen model group in the subsequent time window.</p>
<p><code>Audition</code> predefines 7 rules:</p>
<ol>
<li><code>best_current_value</code> :: Pick the model group with the best current metric Value.</li>
<li><code>best_average_value</code> :: Pick the model with the highest average metric value so far.</li>
<li><code>lowest_metric_variance</code> :: Pick the model with the lowest metric variance so far.</li>
<li><code>most_frequent_best_dist</code> :: Pick the model that is most frequently within <code>dist_from_best_case</code> from the best-performing model group across test sets so far.</li>
<li><code>best_average_two_metrics</code> :: Pick the model with the highest average combined value to date of two metrics weighted together using <code>metric1_weight</code>.</li>
<li><code>best_avg_var_penalized</code> :: Pick the model with the highest average metric value so far, penalized for relative variance as: [ =avg_value - (stdev_penalty) * (stdev - min_stdev)= ] where <code>min_stdev</code> is the minimum standard deviation of the metric across all model groups</li>
<li><code>best_avg_recency_weight</code> :: Pick the model with the highest average metric value so far, placing less weight in older results. You need to specify two parameters: the shape of how the weight affects points (<code>decay_type</code>, linear or exponential) and the relative weight of the most recent point (<code>curr_weight</code>).</li>
</ol>
<blockquote>
<p>Before move on, remember the two main <em>caveats</em> for the value of the metric in this kind of ML problems:</p>
<ul>
<li>Could be many entities with the same predicted risk score (<em>ties</em>)</li>
<li>Could be a lot of entities without a label (Weren't inspected, so we don’t know)</li>
</ul>
</blockquote>
<p>We included a <a href="file:///home/nanounanue/projects/dsapp/dirtyduck/triage/inspection_audition_config.yaml">simple configuration file</a> with some rules:</p>
<div class="highlight"><pre><span></span><span class="c1"># CHOOSE MODEL GROUPS</span>
<span class="nt">model_groups</span><span class="p">:</span>
    <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">select distinct(model_group_id)</span>
        <span class="no">from model_metadata.model_groups</span>
        <span class="no">where model_config -&gt;&gt; &#39;experiment_type&#39; ~ &#39;inspection&#39;</span>
<span class="c1"># CHOOSE TIMESTAMPS/TRAIN END TIMES</span>
<span class="nt">time_stamps</span><span class="p">:</span>
    <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">select distinct train_end_time</span>
        <span class="no">from model_metadata.models</span>
        <span class="no">where model_group_id in ({})</span>
        <span class="no">and extract(day from train_end_time) in (1)</span>
        <span class="no">and train_end_time &gt;= &#39;2015-01-01&#39;</span>
<span class="c1"># FILTER</span>
<span class="nt">filter</span><span class="p">:</span>
    <span class="nt">metric</span><span class="p">:</span> <span class="s">&#39;precision@&#39;</span> <span class="c1"># metric of interest</span>
    <span class="nt">parameter</span><span class="p">:</span> <span class="s">&#39;10_pct&#39;</span> <span class="c1"># parameter of interest</span>
    <span class="nt">max_from_best</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span> <span class="c1"># The maximum value that the given metric can be worse than the best model for a given train end time.</span>
    <span class="nt">threshold_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0</span> <span class="c1"># The worst absolute value that the given metric should be.</span>
    <span class="nt">distance_table</span><span class="p">:</span> <span class="s">&#39;inspections_distance_table&#39;</span> <span class="c1"># name of the distance table</span>
    <span class="nt">models_table</span><span class="p">:</span> <span class="s">&#39;models&#39;</span> <span class="c1"># name of the models table</span>

<span class="c1"># RULES</span>
<span class="nt">rules</span><span class="p">:</span>
    <span class="p p-Indicator">-</span>
        <span class="nt">shared_parameters</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">metric</span><span class="p">:</span> <span class="s">&#39;precision@&#39;</span>
                <span class="nt">parameter</span><span class="p">:</span> <span class="s">&#39;10_pct&#39;</span>

        <span class="nt">selection_rules</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;best_current_value&#39;</span> <span class="c1"># Pick the model group with the best current metric value</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;best_average_value&#39;</span> <span class="c1"># Pick the model with the highest average metric value</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;lowest_metric_variance&#39;</span> <span class="c1"># Pick the model with the lowest metric variance</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;most_frequent_best_dist&#39;</span> <span class="c1"># Pick the model that is most frequently within `dist_from_best_case`</span>
                <span class="nt">dist_from_best_case</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0.05</span><span class="p p-Indicator">]</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>

<p><code>Audition</code> will have each rule give you the best <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> <em>model groups</em> based on the metric and parameter following that rule for the most recent time period (in all the rules shown <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> = 3).</p>
<p>We can run the simulation of the rules against the experiment as:</p>
<div class="highlight"><pre><span></span><span class="c1"># Run this in bastion…</span>
triage --tb audition -c inspection_audition_config.yaml --directory audition/inspections
</pre></div>

<p><code>Audition</code> will create several plots that will help you to sort out which is the <em>best</em> model group to use (like in a production setting or just to generate your predictions list).</p>
<h3>Filtering model groups</h3>
<p>Most of the time, <code>audition</code> should be used in a iterative fashion, the result of each iteration will be a reduced set of models groups and a best rule for selecting model groups.</p>
<p>If you look again at the <a href="file:///home/nanounanue/projects/dsapp/dirtyduck/triage/inspection_audition_config.yaml">audition configuration file</a> you can filter the number of models to consider using the parameters <code>max_from_best</code> and <code>threshold_value</code>. The former will filter out <em>models groups</em> with <em>models</em> which performance in the <code>metric</code> is farther than the <code>max_from_best</code> (In this case we are allowing <strong>all</strong> the models, since <code>max_from_best = 1.0</code>, if you want less models you could choose <code>0.1</code> for example, and you will remove the <code>DummyClassifier</code> and some <code>DecisionTreeClassifiers</code>). <code>threshold_value</code> filter out all the <em>models groups</em> with <em>models</em> performing <em>below</em> that the specified value. This could be important if you <strong>don’t</strong> find acceptable models with metrics that are that low.</p>
<p><code>Audition</code> will generate two plots that are meant to be used together: <em>model performance over time</em> and <em>distance from best</em>.</p>
<p><img alt="img" src="audition/inspections/metric_over_time_precision@10_pct.png" title="Model group performance over time. In this case the metric show is precision@10%. We didn’t filter out any model group, so the 45 model groups are shown. See discussion above to learn how to plot less model groups. The black dashed line represents the (theoretical) system's performance if we select the best performant model in a every evaluation date. The colored lines represents different model groups. All the model groups that share an algorithm will be colored the same." /></p>
<p>Next figure shows the proportion of <em>models</em> that are behind the best model. The distance is measured in percentual points. You could use this plot to <em>filter out</em> more model groups, changing the value of <code>max_from_best</code> in the configuration file. This plot is hard to read, but is very helpful since it shows you the <em>consistency</em> of the model group: <em>How consistently are the model group in a specific range, let's say 20 points, from the best?</em></p>
<p><img alt="img" src="audition/inspections/distance_from_best_precision@10_pct.png" title="Proportion of *models* in a *model group* that are separated from the best model. The distance is measured in percentual points, i.e. How much less precision at 10 percent of the population compared to the best model in that date." /></p>
<p>In the figure, you can see that the ~60% of the <code>DummyClassifier</code> models are ~18 percentual points below of the best.</p>
<h3>Selecting the best rule or strategy for choosing model groups</h3>
<p>In this phase of the audition, you will see what will happen in the next time if you choose your model group with an specific strategy or rule. We call this the <strong>regret</strong> of the strategies.</p>
<p>We define <strong>regret</strong> as</p>
<blockquote>
<p><strong>Regret</strong> Is the difference in performance between the model group you picked and the best one in the next time period.</p>
</blockquote>
<p>The next plot show the <em>best</em> model group selected by the strategies specified in the configuration file:</p>
<p><img alt="img" src="audition/inspections/precision@10_pct_next_time.png" title="Given a strategy for selecting model groups (in the figure, 4 are shown), What will be the performace of the model group chosen by that strategy in the next evaluation date?" /></p>
<p>It seems that the strategies <em>best average</em> and <em>best current value</em> select the same <strong>model group</strong>.</p>
<p><img alt="img" src="audition/inspections/regret_distance_from_best_rules_precision@10_pct.png" title="Given a strategy for selecting model groups (in the plot 4 are shown). What will be the distance (*regret*) to the best theoretical model in the following evaluation date? This plot is similar to the [@fig:distance-from-best]" /></p>
<p>Obviously, you don’t know the future, but with the available data, if you stick to an a particular strategy, How much you will <em>regret</em> about that decision? That’s what is represented in plot [@fig:regret-over-time]</p>
<p><img alt="img" src="audition/inspections/regret_over_time_precision@10_pct.png" title="Expected regret for the strategies. The less the better." /></p>
<p>The best <strong>3</strong> <em>model groups</em> per strategy will be stored in the file <code>[[file:audition/inspections/results_model_group_ids.json][results_model_group_ids.json]]</code>:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;best_current_value_precision@_10_pct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">41</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="nt">&quot;best_average_value_precision@_10_pct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">41</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span> <span class="nt">&quot;lowest_metric_variance_precision@_10_pct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">27</span><span class="p">],</span> <span class="nt">&quot;most_frequent_best_dist_precision@_10_pct_0.05&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]}</span>
</pre></div>

<p>The analysis suggests that the best strategies are</p>
<ul>
<li>select the model groups (<code>41,11,45</code>) which have the best average precision@10% value or,</li>
<li>select the best model group (<code>41,32,45</code>) using precision@10% today and use it for the next time period.</li>
</ul>
<p>You will note that both strategies share two models groups and differ in one. In the next two sections, we will investigate further those four model groups selected by <code>audition</code>, using the <em>Postmodeling</em> tool set.</p>
<h3>Postmodeling: Inspecting the best models closely</h3>
<p><em>Postmodeling</em> will help you to understand the behaviour orf your selected models (from audition)</p>
<p>As in <code>Audition</code>, we will split the postmodeling process in two parts. The first one is about exploring the <em>model groups</em> filtered by audition, with the objective of select one. The second part is about learning about <em>models</em> in the model group that was selected.</p>
<p>We will setup some parameters in the <a href="file:///home/nanounanue/projects/dsapp/dirtyduck/triage/inspection_postmodeling_config.yaml">postmodeling configuration file</a>, mainly where is the audition’s output file located.</p>
<div class="highlight"><pre><span></span><span class="c1"># Postmodeling Configuration File</span>

<span class="nt">project_path</span><span class="p">:</span> <span class="s">&#39;/triage&#39;</span> <span class="c1"># Project path defined in triage with matrices and models</span>
<span class="nt">model_group_id</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">41</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">32</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">45</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">11</span>

<span class="nt">thresholds</span><span class="p">:</span> <span class="c1"># Thresholds for defining positive predictions</span>
  <span class="nt">rank_abs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">]</span>
  <span class="nt">rank_pct</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">]</span>

<span class="nt">baseline_query</span><span class="p">:</span> <span class="p p-Indicator">|</span> <span class="c1"># SQL query for defining a baseline for comparison in plots. It needs a metric and parameter</span>
      <span class="no">select g.model_group_id,</span>
             <span class="no">m.model_id,</span>
             <span class="no">extract(&#39;year&#39; from m.evaluation_end_time) as as_of_date_year,</span>
             <span class="no">m.metric,</span>
             <span class="no">m.parameter,</span>
             <span class="no">m.value,</span>
             <span class="no">m.num_labeled_examples,</span>
             <span class="no">m.num_labeled_above_threshold,</span>
             <span class="no">m.num_positive_labels</span>
       <span class="no">from test_results.evaluations m</span>
       <span class="no">left join model_metadata.models g</span>
       <span class="no">using(model_id)</span>
       <span class="no">where g.model_group_id = 1</span>
             <span class="no">and metric = &#39;precision@&#39;</span>
             <span class="no">and parameter = &#39;10_pct&#39;</span>

<span class="nt">max_depth_error_tree</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span> <span class="c1"># For error trees, how depth the decision trees should go?</span>
<span class="nt">n_features_plots</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1"># Number of features for importances</span>
<span class="nt">figsize</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">12</span><span class="p p-Indicator">,</span> <span class="nv">12</span><span class="p p-Indicator">]</span> <span class="c1"># Default size for plots</span>
<span class="nt">fontsize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span> <span class="c1"># Default fontsize for plots</span>
</pre></div>

<p>Compared to the previous sections, <em>postmodeling</em> is not an automated process (yet). Hence, to do the following part of the tutorial, you need to run <code>jupyter</code> inside <code>bastion</code> as follows:</p>
<div class="highlight"><pre><span></span>jupyter-notebook –-ip<span class="o">=</span><span class="m">0</span>.0.0.0  --port<span class="o">=</span><span class="m">56406</span>
</pre></div>

<p>And then in your browser type<sup><a id="fnr.54" class="footref" href="#fn.54">54</a></sup>: <a href="http://0.0.0.0:56406">http://0.0.0.0:56406</a></p>
<p>Now that you are in a jupyter notebook, type the following:</p>
<div class="highlight"><pre><span></span>%matplotlib inline
import matplotlib
matplotlib.use(&#39;Agg&#39;)

import triage
import pandas as pd
import numpy as np

from collections import OrderedDict
from triage.component.postmodeling.contrast.utils.aux_funcs import create_pgconn, get_models_ids
from triage.component.catwalk.storage import ProjectStorage, ModelStorageEngine, MatrixStorageEngine
from triage.component.postmodeling.contrast.parameters import PostmodelParameters
from triage.component.postmodeling.contrast.model_evaluator import ModelEvaluator
from triage.component.postmodeling.contrast. model_group_evaluator import ModelGroupEvaluator
</pre></div>

<p>After importing, we need to create an <code>sqlalchemy engine</code> for connecting to the database, and read the configuration file.</p>
<div class="highlight"><pre><span></span>params = PostmodelParameters(&#39;inspection_postmodeling_config.yaml&#39;)
engine = create_pgconn(&#39;database.yaml&#39;)
</pre></div>

<p>Postmodeling provides the object <code>ModelGroupEvaluator</code> to compare different <em>model groups</em>.</p>
<div class="highlight"><pre><span></span>audited_models_class = ModelGroupEvaluator(tuple(params.model_group_id), engine)
</pre></div>

<h4>Comparing the audited model groups</h4>
<p>First we will compare the performance of the audited model groups and the baseline over time. First, we will plot <code>precision@10_pct</code></p>
<div class="highlight"><pre><span></span>audited_models_class.plot_prec_across_time(param_type=&#39;rank_pct&#39;,
                                           param=10,
                                           baseline=True,
                                           baseline_query=params.baseline_query,
                                           metric=&#39;precision@&#39;,
                                           figsize=params.figsize)
</pre></div>

<p><img alt="img" src="images/inspection_mg_prec_over_time.png" title="Precision@10% over time from the best performing model groups selected by Audition" /></p>
<p>and now the <code>recall@10_pct</code></p>
<div class="highlight"><pre><span></span>audited_models_class.plot_prec_across_time(param_type=&#39;rank_pct&#39;,
                                           param=10,
                                           metric=&#39;recall@&#39;,
                                           figsize=params.figsize)
</pre></div>

<p><img alt="img" src="images/inspection_mg_recall_over_time.png" title="Recall@10% over time from the best performing model groups selected by Audition" /></p>
<p>All the selected model groups have a very similar performance. Let’s see if they are predicting similar lists of facilities that are at risk of fail an inspection.</p>
<div class="highlight"><pre><span></span>audited_models_class.plot_jaccard_preds(param_type=&#39;rank_pct&#39;,
                                        param=10,
                                        temporal_comparison=True)
</pre></div>

<p><img alt="img" src="images/inspection_jaccard_on_lists_over_time.png" title="How similar are the model groups’ generated list? We use Jaccard similarity on the predicted lists (length of list 10%) to asses the overlap between lists." /></p>
<p>The plot will shows the overlap of the predicted list containing the 10% of the facilities between model groups at each <em>as of date</em>. The lists are at least 50% similar. You should investigate why is that so, i.e. <em>Why the models are not learning the same?</em> This could lead you to defining new features or some another conclusion about your data, but for this tutorial we will move on.</p>
<h4>Going deeper with a model</h4>
<p>Imagine that after a deeper analysis, you decide to choose model group <strong>11</strong></p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">model_type</span><span class="p">,</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span> <span class="k">as</span> <span class="n">mg</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
<span class="k">where</span> <span class="n">model_group_id</span> <span class="o">=</span> <span class="mi">11</span>
<span class="k">group</span> <span class="k">by</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>type</sub></th>
<th>hyperparameters</th>
<th>models</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 250, "min<sub>samples</sub><sub>split</sub>": 2}</td>
<td>{29,65,101}</td>
</tr>
</tbody>
</table>
<p>We will investigate what the particular models are doing. <em>Postmodeling</em> created a <code>ModelEvaluator</code> (similar to the <code>ModelGroupEvaluator</code>) to do this exploration:</p>
<div class="highlight"><pre><span></span>models_11 = { f&#39;{model}&#39;: ModelEvaluator(11, model, engine) for model in [29,65,101] }
</pre></div>

<p>In this tutorial, we will just show some parts of the analysis in the most recent model, but feel free of exploring the behavior of all the models in this model group, and check if you can detect any pattern.</p>
<ul>
<li>
<p>Feature importances</p>
<div class="highlight"><pre><span></span>models_11[&#39;101&#39;].plot_feature_importances(path=params.project_path,
                                          n_features_plots=params.n_features_plots,
                                          figsize=params.figsize)
</pre></div>

<p><img alt="img" src="images/inspection_model_group_11_feature_importances.png" title="Top 10 feature importances for de model group 11 at 2017-12-01 (i.e. model 101)." /></p>
<div class="highlight"><pre><span></span>models_11[&#39;101&#39;].plot_feature_group_average_importances()
</pre></div>

<p><img alt="img" src="images/inspection_model_group_11_feature_group_importances.png" title="Feature group “importance” (we are basically taking the average of all the feature importances in a feature group) for the model group 11, model 101." /></p>
</li>
<li>
<p>Our <em>Policy menu</em></p>
<p>The following plot depicts the behavior of the metrics if you change the length of the facilities predicted at risk (i.e. the <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span>). This plot is important from the decision making point of view, since it could be used as a <em>policy menu</em>.</p>
<div class="highlight"><pre><span></span>models_11[&#39;101&#39;].plot_precision_recall_n(figsize=(8,8))
</pre></div>

<p><img alt="img" src="images/inspection_model_group_11_rayid_curve.png" title="Plot of Precision and Recall over the proportion of the facilities. This plot is used as a &quot;policy menu&quot; since allows you to see how much you will gain if you invest more resources or how much you will sacrifice if you reduce your budget for resources. This is also known as “Rayid plot” at DSaPP." /></p>
<p>We selected this model group because it was the best at precision at 10% (i.e. the model group consistently chose facilities will fail inspections at the top 10% of the risk). With the plot above you could decide to double your resources (maybe hiring more inspectors so you could inspect 20% of the facilities) and with this model you will double the detection of facilities that will fail inspections (from ~18% to ~30% in recall) with only a few percent points less of precision ~45% to ~40% (this means that 6 in 10 facilities that the inspectors visit will pass the inspection). You could also go the other way around: if you reduce the length of the list from 10% to 5%, well you will gain a little of precision, but your recall will be ~5%.</p>
</li>
</ul>
<h2>An Early Intervention System</h2>
<h3>Problem description</h3>
<p><code>triage</code> is designed to also build early warning systems (also called early intervention, EIS). While there are several differences between modeling early warnings and inspection prioritization, perhaps the biggest is that the <em>entity</em> is active (i.e. it is doing stuff for which an outcome will happen) in EIS but passive (i.e. inspected) in <strong>inspection prioritization</strong>. Among other things, this difference affects the way the <em>outcome</em> is built.</p>
<p>Here's the question we want to answer:</p>
<blockquote>
<p>Will my restaurant be inspected in the <em>next X period of time?</em></p>
</blockquote>
<p>Where <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> could be 3 days, 2 months, 1 year, etc.</p>
<p>Knowing the answer to this question enables you (as the restaurant owner or manager) to prepare for the inspection.</p>
<h3>What are the labels? What are the outcomes?</h3>
<p>The trick to note is that on any given day there are two possible outcomes: <em>the facility was inspected</em> and <em>the facility wasn't inspected</em>. Our <em>outcomes</em> table will be larger than in the inspection prioritization example because we need an <em>outcome</em> for every <em>active</em> facility on every date. The following image tries to exemplify this reasoning:</p>
<p><img alt="img" src="images/outcomes-eis.png" title="The image shows three facilities, and next to each, a temporal line with 6 days (0-5). Each dot represents the event (whether an inspection happened). Yellow means the inspection happened (TRUE outcome) and blue means it didn't (FALSE outcome). Each facility in the image had two inspections, six in total." /></p>
<p>Fortunately, <code>triage</code> will help us to create this table. The <em>cohort</em> table is the same as the <em>cohort</em> table in the inspection case.</p>
<p>First the usual stuff. Note that we are changing <code>model_comment</code> and <code>label_definition</code> (remember that this is used for generating the <em>hash</em> that differentiates models and model groups).</p>
<div class="highlight"><pre><span></span><span class="nt">config_version</span><span class="p">:</span> <span class="s">&#39;v6&#39;</span>

<span class="nt">model_comment</span><span class="p">:</span> <span class="nt">&#39;eis</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">01&#39;</span>

<span class="nt">user_metadata</span><span class="p">:</span>
  <span class="nt">label_definition</span><span class="p">:</span> <span class="s">&#39;inspected&#39;</span>
  <span class="nt">experiment_type</span><span class="p">:</span> <span class="s">&#39;eis&#39;</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">EIS 01</span>
  <span class="nt">purpose</span><span class="p">:</span> <span class="s">&#39;model</span><span class="nv"> </span><span class="s">creation&#39;</span>
  <span class="nt">org</span><span class="p">:</span> <span class="s">&#39;DSaPP&#39;</span>
  <span class="nt">team</span><span class="p">:</span> <span class="s">&#39;Tutorial&#39;</span>
  <span class="nt">author</span><span class="p">:</span> <span class="s">&#39;Your</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">here&#39;</span>
  <span class="nt">etl_date</span><span class="p">:</span> <span class="s">&#39;2019-02-21&#39;</span>

<span class="nt">model_group_keys</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;class_path&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;parameters&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;feature_names&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;feature_groups&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;cohort_name&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;state&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_name&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_timespan&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;training_as_of_date_frequency&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;max_training_history&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;label_definition&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;experiment_type&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;org&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;team&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;author&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;purpose&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;etl_date&#39;</span>
</pre></div>

<p>For the labels the query is pretty simple, if the facility showed in the data, it will get a <em>positive</em> outcome, if not they will get a <em>negative</em> outcome</p>
<div class="highlight"><pre><span></span><span class="nt">label_config</span><span class="p">:</span>
  <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">select</span>
    <span class="no">entity_id,</span>
    <span class="no">True::integer as outcome</span>
    <span class="no">from semantic.events</span>
    <span class="no">where &#39;{as_of_date}&#39;::timestamp &lt;= date</span>
    <span class="no">and date &lt; &#39;{as_of_date}&#39;::timestamp + interval &#39;{label_timespan}&#39;</span>
    <span class="no">group by entity_id</span>
  <span class="nt">include_missing_labels_in_train_as</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;inspected&#39;</span>
</pre></div>

<p>Note the two introduced changes in this block, first, the <em>outcome</em> is <code>True</code> , because all our observations represent <em>inspected</em> facilities (see discussion above and in particular previous image), second, we added the line <code>include_missing_labels_in_train_as: False</code>. This line tells <code>triage</code> to incorporate all the missing facilities in the <em>training</em> matrices with <code>False</code> as the <em>label</em>.</p>
<p>As stated we will use the same configuration block for <em>cohorts</em> that we used in inspections:</p>
<div class="highlight"><pre><span></span><span class="nt">cohort_config</span><span class="p">:</span>
  <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">with buckets as (</span>
    <span class="no">select *, ntile(5) over (order by number_of_inspections asc) as bucket</span>
    <span class="no">from (</span>
    <span class="no">select entity_id, count(*) as number_of_inspections</span>
    <span class="no">from semantic.events</span>
    <span class="no">group by entity_id</span>
    <span class="no">) as t</span>
    <span class="no">)</span>
    <span class="no">select e.entity_id</span>
    <span class="no">from semantic.entities as e</span>
    <span class="no">inner join</span>
    <span class="no">buckets as b</span>
    <span class="no">using (entity_id)</span>
    <span class="no">where</span>
    <span class="no">daterange(start_time, end_time, &#39;[]&#39;) @&gt; &#39;{as_of_date}&#39;::date</span>
    <span class="no">and bucket in (5)</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;active_facilities&#39;</span>
</pre></div>

<h3>Modeling Using Machine Learning</h3>
<p>We need to specify the temporal configuration too</p>
<ul>
<li>
<p>Temporal configuration</p>
<div class="highlight"><pre><span></span><span class="nt">temporal_config</span><span class="p">:</span>
    <span class="nt">feature_start_time</span><span class="p">:</span> <span class="s">&#39;2010-01-04&#39;</span>
    <span class="nt">feature_end_time</span><span class="p">:</span> <span class="s">&#39;2019-01-01&#39;</span>
    <span class="nt">label_start_time</span><span class="p">:</span> <span class="s">&#39;2015-02-01&#39;</span>
    <span class="nt">label_end_time</span><span class="p">:</span> <span class="s">&#39;2019-01-01&#39;</span>

    <span class="nt">model_update_frequency</span><span class="p">:</span> <span class="s">&#39;1y&#39;</span>
    <span class="nt">training_label_timespans</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">training_as_of_date_frequencies</span><span class="p">:</span> <span class="s">&#39;1month&#39;</span>

    <span class="nt">test_durations</span><span class="p">:</span> <span class="s">&#39;1y&#39;</span>
    <span class="nt">test_label_timespans</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">test_as_of_date_frequencies</span><span class="p">:</span> <span class="s">&#39;1month&#39;</span>

    <span class="nt">max_training_histories</span><span class="p">:</span> <span class="s">&#39;5y&#39;</span>
</pre></div>

<p>As before, you can generate the image of the temporal blocks:</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/eis_01.yaml --show-timechop
</pre></div>

<p><img alt="img" src="triage/images/eis_01.png" title="Temporal blocks for the Early Warning System. We want to predict the most likely facilities to be inspected in the following month." /></p>
</li>
<li>
<p>Features</p>
<p>Regarding the features, we will use the same ones that were used in <a href="inspections.md">inspections prioritization</a>:</p>
<div class="highlight"><pre><span></span><span class="nt">feature_aggregations</span><span class="p">:</span>
  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;inspections&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">aggregates_imputation</span><span class="p">:</span>
      <span class="nt">count</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero_noflag&#39;</span>

    <span class="nt">aggregates</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">quantity</span><span class="p">:</span>
          <span class="nt">total</span><span class="p">:</span> <span class="s">&quot;*&quot;</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;count&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;risks&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">sum</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero&#39;</span>
      <span class="nt">avg</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero&#39;</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">&#39;risk&#39;</span>
        <span class="nt">choices</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;low&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;medium&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;high&#39;</span><span class="p p-Indicator">]</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;sum&#39;</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;avg&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;zip_code&#39;</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;results&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">all</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero&#39;</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">&#39;result&#39;</span>
        <span class="nt">choice_query</span><span class="p">:</span> <span class="s">&#39;select</span><span class="nv"> </span><span class="s">distinct</span><span class="nv"> </span><span class="s">result</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">semantic.events&#39;</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;sum&#39;</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;avg&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&#39;inspection_types&#39;</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">&#39;semantic.events&#39;</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">&#39;date&#39;</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">sum</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;zero_noflag&#39;</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">&#39;type&#39;</span>
        <span class="nt">choice_query</span><span class="p">:</span> <span class="s">&#39;select</span><span class="nv"> </span><span class="s">distinct</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">semantic.events</span><span class="nv"> </span><span class="s">where</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">null&#39;</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;sum&#39;</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;1month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;3month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;6month&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;all&#39;</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;entity_id&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;zip_code&#39;</span>
</pre></div>

<p>We declare that we want to use all possible feature-group combinations for training:</p>
<div class="highlight"><pre><span></span><span class="nt">feature_group_definition</span><span class="p">:</span>
   <span class="nt">prefix</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;inspections&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;results&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;risks&#39;</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;inspection_types&#39;</span>

<span class="nt">feature_group_strategies</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;all&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;leave-one-out&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;leave-one-in&#39;</span><span class="p p-Indicator">]</span>
</pre></div>

<p>i.e. <code>all</code> will train models with all the features groups, <code>leave-one-in</code> will use only one of the feature groups for traning, and lastly, <code>leave-one-out</code> will train the model with all the features except one.</p>
</li>
<li>
<p>Algorithm and hyperparameters</p>
<p>We will collapse the baseline (<code>DummyClassifier</code>) and the exploratory configuration together:</p>
<div class="highlight"><pre><span></span><span class="nt">grid_config</span><span class="p">:</span>
    <span class="nt">&#39;sklearn.tree.DecisionTreeClassifier&#39;</span><span class="p">:</span>
        <span class="nt">max_depth</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">null</span><span class="p p-Indicator">]</span>
    <span class="nt">&#39;sklearn.ensemble.RandomForestClassifier&#39;</span><span class="p">:</span>
        <span class="nt">max_features</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;sqrt&#39;</span><span class="p p-Indicator">]</span>
        <span class="nt">criterion</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;gini&#39;</span><span class="p p-Indicator">]</span>
        <span class="nt">n_estimators</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">500</span><span class="p p-Indicator">]</span>
        <span class="nt">min_samples_leaf</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">]</span>
        <span class="nt">min_samples_split</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">50</span><span class="p p-Indicator">]</span>
    <span class="nt">&#39;sklearn.dummy.DummyClassifier&#39;</span><span class="p">:</span>
        <span class="nt">strategy</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">most_frequent</span><span class="p p-Indicator">]</span>
</pre></div>

<p><code>triage</code> will create <strong>36</strong> <em>model groups</em>: <strong>4</strong> algorithms and hyperparameters (2 <code>DecisionTreeClassifier</code>, 1 <code>RandomForestClassifier</code>, 1 <code>DummyClassifier</code>) &times; <strong>9</strong> features sets (1 <code>all</code>, 4 <code>leave-one-out</code>, <code>4 leave-one-in</code>). The total number of <em>models</em> is three times that (we have 3 time blocks, so <strong>108</strong> models).</p>
<div class="highlight"><pre><span></span><span class="nt">scoring</span><span class="p">:</span>
    <span class="nt">testing_metric_groups</span><span class="p">:</span>
        <span class="p p-Indicator">-</span>
          <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
          <span class="nt">thresholds</span><span class="p">:</span>
            <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
            <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>


    <span class="nt">training_metric_groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">accuracy</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
        <span class="nt">thresholds</span><span class="p">:</span>
          <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
          <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>
</pre></div>

<p>As a last step, we validate that the configuration file is correct:</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/eis_01.yaml  --validate-only
</pre></div>

<p>And then just run it:</p>
<div class="highlight"><pre><span></span><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment --matrix-format hdf experiments/eis_01.yaml --profile
</pre></div>

<p>This will take a <strong>lot</strong> amount of time (on my computer took 3h 42m), so, grab your coffee, chat with your coworkers, check your email, or read the <a href="https://dssg.uchicago.edu/blog">DSSG blog</a>. It's taking that long for several reasons:</p>
<ol>
<li>There are a lot of models, parameters, etc.</li>
<li>We are running in serial mode (i.e. not in parallel).</li>
<li>The database is running on your laptop.</li>
</ol>
<p>You can solve 2 and 3. For the second point you could use the <code>docker</code> container that has the multicore option enabled. For 3, I recommed you to use a PostgreSQL database in the cloud, such as Amazon's <strong>PostgreSQL RDS</strong> (we will explore this later in running triage in AWS Batch).</p>
<p>After the experiment finishes, we can create the following table:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">features_groups</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">split_part</span><span class="p">(</span><span class="k">unnest</span><span class="p">(</span><span class="n">feature_list</span><span class="p">),</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">feature_groups</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span>
<span class="p">),</span>

<span class="n">features_arrays</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="k">distinct</span> <span class="n">feature_groups</span><span class="p">)</span> <span class="k">as</span> <span class="n">feature_groups</span>
<span class="k">from</span>
    <span class="n">features_groups</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">feature_groups</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">train_end_time</span><span class="p">::</span><span class="nb">date</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">times</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;0.999&#39;</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;precision@10%&quot;</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span>
    <span class="k">join</span>
    <span class="n">features_arrays</span> <span class="k">using</span><span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
    <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span> <span class="k">using</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<span class="k">where</span>
    <span class="n">model_comment</span> <span class="o">~</span> <span class="s1">&#39;eis&#39;</span>
    <span class="k">and</span>
    <span class="n">metric</span> <span class="o">||</span> <span class="k">parameter</span> <span class="o">=</span> <span class="s1">&#39;precision@10_pct&#39;</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">feature_groups</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>type</sub></th>
<th>hyperparameters</th>
<th>feature<sub>groups</sub></th>
<th>models</th>
<th>times</th>
<th>precision@10%</th>
</tr>
</thead>
<tbody>
<tr>
<td>46</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{136,154,172}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.271"," 0.265"," 0.181"}</td>
</tr>
<tr>
<td>47</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{137,155,173}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.200"," 0.211"," 0.138"}</td>
</tr>
<tr>
<td>48</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{inspection,results,risks}</td>
<td>{138,156,174}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.271"," 0.265"," 0.181"}</td>
</tr>
<tr>
<td>49</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{inspection,results,risks}</td>
<td>{139,157,175}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.197"," 0.213"," 0.138"}</td>
</tr>
<tr>
<td>50</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{inspection,inspections,risks}</td>
<td>{140,158,176}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.253"," 0.224"," 0.142"}</td>
</tr>
<tr>
<td>51</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{inspection,inspections,risks}</td>
<td>{141,159,177}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.175"," 0.171"," 0.129"}</td>
</tr>
<tr>
<td>52</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{inspection,inspections,results}</td>
<td>{142,160,178}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.271"," 0.265"," 0.181"}</td>
</tr>
<tr>
<td>53</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{inspection,inspections,results}</td>
<td>{143,161,179}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.213"," 0.201"," 0.133"}</td>
</tr>
<tr>
<td>54</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{inspections,results,risks}</td>
<td>{144,162,180}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.271"," 0.265"," 0.181"}</td>
</tr>
<tr>
<td>55</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{inspections,results,risks}</td>
<td>{145,163,181}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.204"," 0.205"," 0.146"}</td>
</tr>
<tr>
<td>56</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{inspections}</td>
<td>{146,164,182}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.171"," 0.145"," 0.113"}</td>
</tr>
<tr>
<td>57</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{inspections}</td>
<td>{147,165,183}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.168"," 0.168"," 0.131"}</td>
</tr>
<tr>
<td>58</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{results}</td>
<td>{148,166,184}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.271"," 0.265"," 0.181"}</td>
</tr>
<tr>
<td>59</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{results}</td>
<td>{149,167,185}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.243"," 0.232"," 0.180"}</td>
</tr>
<tr>
<td>60</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{risks}</td>
<td>{150,168,186}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.253"," 0.224"," 0.142"}</td>
</tr>
<tr>
<td>61</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{risks}</td>
<td>{151,169,187}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.174"," 0.158"," 0.122"}</td>
</tr>
<tr>
<td>62</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": 2}</td>
<td>{inspection}</td>
<td>{152,170,188}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.201"," 0.191"," 0.124"}</td>
</tr>
<tr>
<td>63</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max<sub>depth</sub>": null}</td>
<td>{inspection}</td>
<td>{153,171,189}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.166"," 0.165"," 0.124"}</td>
</tr>
<tr>
<td>64</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{190,208,226}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.348"," 0.346"," 0.239"}</td>
</tr>
<tr>
<td>65</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{191,209,227}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>66</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{inspection,results,risks}</td>
<td>{192,210,228}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.350"," 0.348"," 0.244"}</td>
</tr>
<tr>
<td>67</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspection,results,risks}</td>
<td>{193,211,229}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>68</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{inspection,inspections,risks}</td>
<td>{194,212,230}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.283"," 0.271"," 0.186"}</td>
</tr>
<tr>
<td>69</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspection,inspections,risks}</td>
<td>{195,213,231}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>70</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{inspection,inspections,results}</td>
<td>{196,214,232}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.339"," 0.335"," 0.245"}</td>
</tr>
<tr>
<td>71</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspection,inspections,results}</td>
<td>{197,215,233}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>72</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{inspections,results,risks}</td>
<td>{198,216,234}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.344"," 0.342"," 0.239"}</td>
</tr>
<tr>
<td>73</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspections,results,risks}</td>
<td>{199,217,235}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>74</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{inspections}</td>
<td>{200,218,236}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.168"," 0.169"," 0.131"}</td>
</tr>
<tr>
<td>75</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspections}</td>
<td>{201,219,237}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>76</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{results}</td>
<td>{202,220,238}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.314"," 0.301"," 0.213"}</td>
</tr>
<tr>
<td>77</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{results}</td>
<td>{203,221,239}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>78</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{risks}</td>
<td>{204,222,240}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.280"," 0.263"," 0.178"}</td>
</tr>
<tr>
<td>79</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{risks}</td>
<td>{205,223,241}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
<tr>
<td>80</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{inspection}</td>
<td>{206,224,242}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.272"," 0.259"," 0.179"}</td>
</tr>
<tr>
<td>81</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "most<sub>frequent</sub>"}</td>
<td>{inspection}</td>
<td>{207,225,243}</td>
<td>{2015-12-01,2016-12-01,2017-12-01}</td>
<td>{" 0.121"," 0.119"," 0.088"}</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h3>Audition: So many models, how can I choose the best one?</h3>
<p>Let’s select the best model groups, using Audition. We need to make small changes to the <a href="file:///home/nanounanue/projects/dsapp/dirtyduck/triage/eis_audition_config.yaml">configuration file</a> compared to the inspection’s one:</p>
<div class="highlight"><pre><span></span><span class="c1"># CHOOSE MODEL GROUPS</span>
<span class="nt">model_groups</span><span class="p">:</span>
    <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">select distinct(model_group_id)</span>
        <span class="no">from model_metadata.model_groups</span>
        <span class="no">where model_config -&gt;&gt; &#39;experiment_type&#39; ~ &#39;eis&#39;</span>
<span class="c1"># CHOOSE TIMESTAMPS/TRAIN END TIMES</span>
<span class="nt">time_stamps</span><span class="p">:</span>
    <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">select distinct train_end_time</span>
        <span class="no">from model_metadata.models</span>
        <span class="no">where model_group_id in ({})</span>
        <span class="no">and extract(day from train_end_time) in (1)</span>
        <span class="no">and train_end_time &gt;= &#39;2015-01-01&#39;</span>
<span class="c1"># FILTER</span>
<span class="nt">filter</span><span class="p">:</span>
    <span class="nt">metric</span><span class="p">:</span> <span class="s">&#39;precision@&#39;</span> <span class="c1"># metric of interest</span>
    <span class="nt">parameter</span><span class="p">:</span> <span class="s">&#39;10_pct&#39;</span> <span class="c1"># parameter of interest</span>
    <span class="nt">max_from_best</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span> <span class="c1"># The maximum value that the given metric can be worse than the best model for a given train end time.</span>
    <span class="nt">threshold_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0</span> <span class="c1"># The worst absolute value that the given metric should be.</span>
    <span class="nt">distance_table</span><span class="p">:</span> <span class="s">&#39;eis_distance_table&#39;</span> <span class="c1"># name of the distance table</span>
    <span class="nt">models_table</span><span class="p">:</span> <span class="s">&#39;models&#39;</span> <span class="c1"># name of the models table</span>

<span class="c1"># RULES</span>
<span class="nt">rules</span><span class="p">:</span>
    <span class="p p-Indicator">-</span>
        <span class="nt">shared_parameters</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">metric</span><span class="p">:</span> <span class="s">&#39;precision@&#39;</span>
                <span class="nt">parameter</span><span class="p">:</span> <span class="s">&#39;10_pct&#39;</span>

        <span class="nt">selection_rules</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;best_current_value&#39;</span> <span class="c1"># Pick the model group with the best current metric value</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;best_average_value&#39;</span> <span class="c1"># Pick the model with the highest average metric value</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;lowest_metric_variance&#39;</span> <span class="c1"># Pick the model with the lowest metric variance</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;most_frequent_best_dist&#39;</span> <span class="c1"># Pick the model that is most frequently within `dist_from_best_case`</span>
                <span class="nt">dist_from_best_case</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0.05</span><span class="p p-Indicator">]</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>

<p>And then we run the simulation of the rules againts the experiment as:</p>
<div class="highlight"><pre><span></span>triage --tb audition -c eis_audition_config.yaml --directory audition/eis
</pre></div>

<p><code>Audition</code> will create several plots that will help you to sort out which is the <em>best</em> model group to use (like in a production setting or just to generate your list).</p>
<h4>Filtering model groups</h4>
<p><code>Audition</code> will generate two plots that are meant to be used together: <em>model performance over time</em> and <em>distance from best</em>.</p>
<p><img alt="img" src="audition/eis/metric_over_time_precision@10_pct.png" title="Model group performance over time. In this case the metric show is precision@10%. The black dashed line represents the (theoretical) system's performance if we select the best performant model in a every evaluation date. The colored lines represents different model groups. All the model groups that share an algorithm will be colored the same." /></p>
<p><img alt="img" src="audition/eis/distance_from_best_precision@10_pct.png" title="Proportion of **all** the *models* in a *model group* that are separated from the best model. The distance is measured in percentual points, i.e. How much less precision at 10 percent of the population compared to the best model in that date." /></p>
<h4>Selecting the best rule or strategy for choosing model groups</h4>
<p>In this phase of the audition, you will see what will happen in the next time if you choose your model group with an specific strategy or rule.</p>
<p>You then, can calculate the <em>regret</em>. <em>Regret</em> is defined as the difference between the performance of the best model evaluated on the "next time" and the performance of the model selected by a particular rule.</p>
<p><img alt="img" src="audition/eis/precision@10_pct_next_time.png" title="Given a strategy for selecting model groups (in the plot 4 are shown), What will be the performace of the model group chosen by that strategy in the next evaluation date?" /></p>
<p><img alt="img" src="audition/eis/regret_distance_from_best_rules_precision@10_pct.png" title="Given a strategy for selecting model groups (in the plot 4 are shown). What will be the distance (*regret*) to the best theoretical model in the following evaluation date? This plot is similar to the [@fig:distance-from-best-2]" /></p>
<p><img alt="img" src="audition/eis/regret_over_time_precision@10_pct.png" title="Expected regret for the strategies. The less the better." /></p>
<p>It seems that the <em>worst</em> strategy (the one with the bigger “regret”) for selecting a <em>model<sub>group</sub></em> is <code>lowest_metric_variance_precision</code>. The other three seem almost indistinguishable. We will dig in using Postmodeling. And afterwards instead of using the feature importance to characterize the facilities, we will explore how the model is splitting the facilities using <em>crosstabs</em>.</p>
<p>As before, the best <strong>3</strong> <em>model groups</em> per strategy will be stored in the file <code>[[file:audition/eis/results_model_group_ids.json][results_model_group_ids.json]]</code>:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;best_current_value_precision@_10_pct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">70</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span> <span class="nt">&quot;best_average_value_precision@_10_pct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">66</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">72</span><span class="p">],</span> <span class="nt">&quot;lowest_metric_variance_precision@_10_pct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">65</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">69</span><span class="p">],</span> <span class="nt">&quot;most_frequent_best_dist_precision@_10_pct_0.05&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">70</span><span class="p">]}</span>
</pre></div>

<h3>Postmodeling: Inspecting the best models closely</h3>
<p>Given that almost all the strategies perform well, we will change the parameter <code>model_group_id</code> in the <a href="file:///home/nanounanue/projects/dsapp/dirtyduck/triage/eis_postmodeling_config.yaml">postmodeling's configuration file</a> and we will use the complete set of model groups selected by audition:</p>
<div class="highlight"><pre><span></span><span class="c1"># Postmodeling Configuration File</span>

  <span class="nt">project_path</span><span class="p">:</span> <span class="s">&#39;/triage&#39;</span> <span class="c1"># Project path defined in triage with matrices and models</span>
  <span class="nt">audition_output_path</span><span class="p">:</span> <span class="s">&#39;/triage/audition/eis/results_model_group_ids.json&#39;</span>

  <span class="nt">thresholds</span><span class="p">:</span> <span class="c1"># Thresholds for2 defining positive predictions</span>
        <span class="nt">rank_abs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">]</span>
        <span class="nt">rank_pct</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">]</span>

  <span class="nt">baseline_query</span><span class="p">:</span> <span class="p p-Indicator">|</span> <span class="c1"># SQL query for defining a baseline for comparison in plots. It needs a metric and parameter</span>
      <span class="no">select g.model_group_id,</span>
             <span class="no">m.model_id,</span>
             <span class="no">extract(&#39;year&#39; from m.evaluation_end_time) as as_of_date_year,</span>
             <span class="no">m.metric,</span>
             <span class="no">m.parameter,</span>
             <span class="no">m.value,</span>
             <span class="no">m.num_labeled_examples,</span>
             <span class="no">m.num_labeled_above_threshold,</span>
             <span class="no">m.num_positive_labels</span>
       <span class="no">from test_results.evaluations m</span>
       <span class="no">left join model_metadata.models g</span>
       <span class="no">using(model_id)</span>
       <span class="no">where g.model_group_id = 81</span>
             <span class="no">and metric = &#39;precision@&#39;</span>
             <span class="no">and parameter = &#39;10_pct&#39;</span>

  <span class="nt">max_depth_error_tree</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span> <span class="c1"># For error trees, how depth the decision trees should go?</span>
  <span class="nt">n_features_plots</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1"># Number of features for importances</span>
  <span class="nt">figsize</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">12</span><span class="p p-Indicator">,</span> <span class="nv">12</span><span class="p p-Indicator">]</span> <span class="c1"># Default size for plots</span>
  <span class="nt">fontsize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span> <span class="c1"># Default fontsize for plots</span>
</pre></div>

<p>Again launch jupyter in <code>bastion</code>:</p>
<h4>Setup</h4>
<p>The first lines of code are the same as in the inspection’s section</p>
<div class="highlight"><pre><span></span>%matplotlib inline
import pandas as pd
import numpy as np
from collections import OrderedDict
from triage.component.postmodeling.contrast.utils.aux_funcs import create_pgconn, get_models_ids
from triage.component.catwalk.storage import ProjectStorage, ModelStorageEngine, MatrixStorageEngine
from triage.component.postmodeling.contrast.parameters import PostmodelParameters
from triage.component.postmodeling.contrast.model_evaluator import ModelEvaluator
from triage.component.postmodeling.contrast.model_group_evaluator import ModelGroupEvaluator

params = PostmodelParameters(&#39;../triage/eis_postmodeling_config.yaml&#39;)

engine = create_pgconn(&#39;database.yaml&#39;)

# Model group object (useful to compare across model_groups and models in time)
audited_models_class = ModelGroupEvaluator(tuple(params.model_group_id), engine)
</pre></div>

<h4>Model groups</h4>
<p>Let’s start with the behavior in time of the selected model groups</p>
<div class="highlight"><pre><span></span>audited_models_class.plot_prec_across_time(param_type=&#39;rank_pct&#39;,
                                           param=10,
                                           baseline=True,
                                           baseline_query=params.baseline_query,
                                           metric=&#39;precision@&#39;,
                                           figsize=params.figsize)
</pre></div>

<p><img alt="img" src="images/eis_mg_prec_over_time.png" title="Precision@10% over time from the best performing model groups selected by Audition" /></p>
<p>Every model selected by audition has a very similar performance across time, and they are ~2.5 times above the baseline in precision@10%. We could also check the recall of the model groups.</p>
<div class="highlight"><pre><span></span>audited_models_class.plot_prec_across_time(param_type=&#39;rank_pct&#39;,
                                           param=10,
                                           metric=&#39;recall@&#39;,
                                           figsize=params.figsize)
</pre></div>

<p><img alt="img" src="images/eis_mg_recall_over_time.png" title="Recall@10% over time from the best performing model groups selected by Audition" /></p>
<p>That behavior is similar for the recall@10%, except for the model group <strong>69</strong></p>
<div class="highlight"><pre><span></span>audited_models_class.plot_jaccard_preds(param_type=&#39;rank_pct&#39;,
                                        param=10,
                                        temporal_comparison=True)
</pre></div>

<p><img alt="img" src="images/eis_jaccard_on_lists_over_time.png" title="How similar are the model groups’ generated list? We use Jaccard similarity on the predicted lists (length of list 10%) to asses the overlap between lists." /></p>
<p>There are a high jaccard similarity between some model groups across time. This could be an indicator that they are so similar that you can choose any and it won’t matter.</p>
<h4>Going deeper with a model</h4>
<p>We will choose the model group <strong>64</strong> as the winner.</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">model_type</span><span class="p">,</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span>
<span class="k">from</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">model_groups</span> <span class="k">as</span> <span class="n">mg</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">model_metadata</span><span class="p">.</span><span class="n">models</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
<span class="k">where</span> <span class="n">model_group_id</span> <span class="o">=</span> <span class="mi">64</span>
<span class="k">group</span> <span class="k">by</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>group</sub><sub>id</sub></th>
<th>model<sub>type</sub></th>
<th>hyperparameters</th>
<th>models</th>
</tr>
</thead>
<tbody>
<tr>
<td>64</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 500, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td>{190,208,226}</td>
</tr>
</tbody>
</table>
<p>But before going to production and start making predictions in unseen data, let’s see what the particular models are doing. <em>Postmodeling</em> created a <code>ModelEvaluator</code> (similar to the <code>ModelGroupEvaluator</code>) to do this exploration:</p>
<div class="highlight"><pre><span></span>models_64 = { f&#39;{model}&#39;: ModelEvaluator(64, model, engine) for model in [190,208,226] }
</pre></div>

<p>In this tutorial, we will just show some parts of the analysis in the most recent model, but feel free of exploring the behavior of all the models in this model group, and check if you can detect any pattern.</p>
<ul>
<li>
<p>Feature importances</p>
<div class="highlight"><pre><span></span>models_64[&#39;226&#39;].plot_feature_importances(path=params.project_path,
                                          n_features_plots=params.n_features_plots,
                                          figsize=params.figsize)
</pre></div>

<p><img alt="img" src="images/eis_model_group_64_feature_importances.png" title="Top 10 feature importances for de model group 64 at 2017-12-01 (i.e. model 226)." /></p>
<div class="highlight"><pre><span></span>models_64[&#39;226&#39;].plot_feature_group_average_importances()
</pre></div>

<p><img alt="img" src="images/eis_model_group_64_feature_group_importances.png" title="Feature group “importance” (we are basically taking the average of all the feature importances in a feature group) for the model group 64, model 226." /></p>
</li>
</ul>
<h3>Crosstabs: How are the entities classified?</h3>
<p>Model interpretation is a huge topic nowadays, the most obvious path is using the <em>features importance</em> from the model. This could be useful, but we could do a lot better.</p>
<p><code>Triage</code> uses <code>crosstabs</code> as a different approach that complements the list of <em>features importance</em>. <code>crosstabs</code> will run statistical tests to compare the predicted positive and the predicted false facilities in <em>each</em> feature.</p>
<div class="highlight"><pre><span></span><span class="nt">output</span><span class="p">:</span>
  <span class="nt">schema</span><span class="p">:</span> <span class="s">&#39;test_results&#39;</span>
  <span class="nt">table</span><span class="p">:</span> <span class="s">&#39;eis_crosstabs&#39;</span>

<span class="nt">thresholds</span><span class="p">:</span>
    <span class="nt">rank_abs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">50</span><span class="p p-Indicator">]</span>
    <span class="nt">rank_pct</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">5</span><span class="p p-Indicator">]</span>

<span class="c1">#(optional): a list of entity_ids to subset on the crosstabs analysis</span>
<span class="nt">entity_id_list</span><span class="p">:</span> <span class="p p-Indicator">[]</span>

<span class="nt">models_list_query</span><span class="p">:</span> <span class="s">&quot;select</span><span class="nv"> </span><span class="s">unnest(ARRAY[226])</span><span class="nv"> </span><span class="s">::</span><span class="nv"> </span><span class="s">int</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">model_id&quot;</span>

<span class="nt">as_of_dates_query</span><span class="p">:</span> <span class="s">&quot;select</span><span class="nv"> </span><span class="s">generate_series(&#39;2017-12-01&#39;::date,</span><span class="nv"> </span><span class="s">&#39;2018-09-01&#39;::date,</span><span class="nv"> </span><span class="s">interval</span><span class="nv"> </span><span class="s">&#39;1month&#39;)</span><span class="nv">  </span><span class="s">as</span><span class="nv"> </span><span class="s">as_of_date&quot;</span>

<span class="c1">#don&#39;t change this query unless strictly necessary. It is just validating pairs of (model_id,as_of_date)</span>
<span class="c1">#it is just a join with distinct (model_id, as_of_date) in a predictions table</span>
<span class="nt">models_dates_join_query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
  <span class="no">select model_id,</span>
  <span class="no">as_of_date</span>
  <span class="no">from models_list_query as m</span>
  <span class="no">cross join as_of_dates_query a join (select distinct model_id, as_of_date from test_results.predictions) as p</span>
  <span class="no">using (model_id, as_of_date)</span>

<span class="c1">#features_query must join models_dates_join_query with 1 or more features table using as_of_date</span>
<span class="nt">features_query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
  <span class="no">select m.model_id, m.as_of_date, f4.entity_id, f4.results_entity_id_1month_result_fail_avg, f4.results_entity_id_3month_result_fail_avg, f4.results_entity_id_6month_result_fail_avg,</span>
  <span class="no">f2.inspection_types_zip_code_1month_type_canvass_sum, f3.risks_zip_code_1month_risk_high_sum, f4.results_entity_id_6month_result_pass_avg,</span>
  <span class="no">f3.risks_entity_id_all_risk_high_sum, f2.inspection_types_zip_code_3month_type_canvass_sum, f4.results_entity_id_6month_result_pass_sum,</span>
  <span class="no">f2.inspection_types_entity_id_all_type_canvass_sum</span>
  <span class="no">from features.inspection_types_aggregation_imputed as f2</span>
  <span class="no">inner join features.risks_aggregation_imputed as f3 using (entity_id, as_of_date)</span>
  <span class="no">inner join features.results_aggregation_imputed as f4 using (entity_id, as_of_date)</span>
  <span class="no">inner join models_dates_join_query as m using (as_of_date)</span>

<span class="c1">#the predictions query must return model_id, as_of_date, entity_id, score, label_value, rank_abs and rank_pct</span>
<span class="c1">#it must join models_dates_join_query using both model_id and as_of_date</span>
<span class="nt">predictions_query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
  <span class="no">select model_id,</span>
      <span class="no">as_of_date,</span>
      <span class="no">entity_id,</span>
      <span class="no">score,</span>
      <span class="no">label_value,</span>
      <span class="no">coalesce(rank_abs, row_number() over (partition by (model_id, as_of_date) order by score desc)) as rank_abs,</span>
      <span class="no">coalesce(rank_pct*100, ntile(100) over (partition by (model_id, as_of_date) order by score desc)) as rank_pct</span>
      <span class="no">from test_results.predictions</span>
      <span class="no">join models_dates_join_query using(model_id, as_of_date)</span>
      <span class="no">where model_id in (select model_id from models_list_query)</span>
      <span class="no">and as_of_date in (select as_of_date from as_of_dates_query)</span>
</pre></div>

<div class="highlight"><pre><span></span>triage --tb crosstabs /triage/eis_crosstabs_config.yaml
</pre></div>

<p>When it finish, you could explore the table with the following code:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">significant_features</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span>
    <span class="n">feature_column</span><span class="p">,</span>
    <span class="n">as_of_date</span><span class="p">,</span>
    <span class="n">threshold_unit</span>
<span class="k">from</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">eis_crosstabs</span>
<span class="k">where</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;ttest_p&#39;</span>
    <span class="k">and</span>
    <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">05</span> <span class="k">and</span> <span class="n">as_of_date</span> <span class="o">=</span> <span class="s1">&#39;2018-09-01&#39;</span>
    <span class="p">)</span>

<span class="k">select</span>
    <span class="k">distinct</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">as_of_date</span><span class="p">::</span><span class="nb">date</span> <span class="k">as</span> <span class="n">as_of_date</span><span class="p">,</span>
    <span class="n">format</span><span class="p">(</span><span class="s1">&#39;%s %s&#39;</span><span class="p">,</span> <span class="n">threshold_value</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">threshold_unit</span><span class="p">)</span> <span class="k">as</span> <span class="n">threshold</span><span class="p">,</span>
    <span class="n">feature_column</span><span class="p">,</span>
    <span class="n">value</span> <span class="k">as</span> <span class="ss">&quot;ratio PP / PN&quot;</span>
<span class="k">from</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">eis_crosstabs</span> <span class="k">as</span> <span class="n">t1</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">significant_features</span> <span class="k">as</span> <span class="n">t2</span> <span class="k">using</span><span class="p">(</span><span class="n">feature_column</span><span class="p">,</span> <span class="n">as_of_date</span><span class="p">)</span>
<span class="k">where</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;ratio_predicted_positive_over_predicted_negative&#39;</span>
    <span class="k">and</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">threshold_unit</span> <span class="o">=</span> <span class="s1">&#39;pct&#39;</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">value</span> <span class="k">desc</span>
</pre></div>

<table>
<thead>
<tr>
<th>model<sub>id</sub></th>
<th>as<sub>of</sub><sub>date</sub></th>
<th>threshold</th>
<th>feature<sub>column</sub></th>
<th>ratio PP / PN</th>
</tr>
</thead>
<tbody>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>results<sub>entity</sub><sub>id</sub><sub>1month</sub><sub>result</sub><sub>fail</sub><sub>avg</sub></td>
<td>11.7306052855925</td>
</tr>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>results<sub>entity</sub><sub>id</sub><sub>3month</sub><sub>result</sub><sub>fail</sub><sub>avg</sub></td>
<td>3.49082798996376</td>
</tr>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>results<sub>entity</sub><sub>id</sub><sub>6month</sub><sub>result</sub><sub>fail</sub><sub>avg</sub></td>
<td>1.27344759545161</td>
</tr>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>risks<sub>zip</sub><sub>code</sub><sub>1month</sub><sub>risk</sub><sub>high</sub><sub>sum</sub></td>
<td>1.17488357227451</td>
</tr>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>inspection<sub>types</sub><sub>entity</sub><sub>id</sub><sub>all</sub><sub>type</sub><sub>canvass</sub><sub>sum</sub></td>
<td>0.946432281075976</td>
</tr>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>inspection<sub>types</sub><sub>zip</sub><sub>code</sub><sub>3month</sub><sub>type</sub><sub>canvass</sub><sub>sum</sub></td>
<td>0.888940127100436</td>
</tr>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>results<sub>entity</sub><sub>id</sub><sub>6month</sub><sub>result</sub><sub>pass</sub><sub>sum</sub></td>
<td>0.041806916457784</td>
</tr>
<tr>
<td>226</td>
<td>2018-09-01</td>
<td>5 pct</td>
<td>results<sub>entity</sub><sub>id</sub><sub>6month</sub><sub>result</sub><sub>pass</sub><sub>avg</sub></td>
<td>0.0232523724927717</td>
</tr>
</tbody>
</table>
<p>This table represents the ratio between the predicted positives at the top 5% and predicted negatives (the rest). For example, you can see that in PP are eleven times more inspected if they have a failed inspection in the last month, 3.5 times more if they have a failed inspection in the previous 3 months, etc.</p>
<h2>Scaling out: AWS Batch</h2>
<blockquote>
<p>If your laptop choked in the previous sections or if you can't afford to look your laptop just lagging forever, you should read this section&#x2026;</p>
</blockquote>
<p>For bigger experiment, one option is use <code>[[https://aws.amazon.com/batch/][AWS Batch]]</code>. AWS Batch dynamically provisions the optimal quantity and type of compute resources based on the specific resource requirements of the tasks submitted. AWS Batch will manage (i.e. plans, schedules, and executes) the resources (CPU, Memory) that we need to run the pipeline. In other words, AWS Batch will provide you with a computer (an AWS EC2 machine) that satisfies your computing requirements, and then it will execute the software that you intend to run.</p>
<p>AWS Batch dependes in other two technologies in order to work: Elastic Container Registry (Amazon ECR) as the Docker image registry (allowing AWS Batch to fetch the task images), and Elastic Compute Cloud (Amazon EC2) instances located in the cluster as the docker host (allowing AWS Batch to execute the task).</p>
<p><img alt="img" src="images/AWS_Batch_Architecture.png" title="Diagram showing the AWS Batch main components and their relationships." /></p>
<p>An AWS ECS task will be executed by an EC2 instance belonging to the ECS cluster (if there are resources available). The EC2 machine operates as a Docker host: it will run the task definition, download the appropriate image from the ECS registry, and execute the container.</p>
<h3>What do you need to setup?</h3>
<p>AWS Batch requires setup the following infrastructure:</p>
<ul>
<li>An <a href="https://aws.amazon.com/s3/?nc2=h_m1">AWS S3 bucket</a> for storing the original data and the successive transformations of it made by the pipeline.</li>
<li>A PostgreSQL database (provided by <a href="https://aws.amazon.com/rds/">AWS RDS</a>) for storing the data in a relational form.</li>
<li>An Elastic Container Registry (<a href="https://aws.amazon.com/ecs/">AWS ECR</a>) for storing the triage's Docker image used in the pipeline.</li>
<li><a href="https://aws.amazon.com/batch/">AWS Batch Job Queue</a> configured and ready to go.</li>
</ul>
<h3>Assumptions</h3>
<ul>
<li>You have <code>[[https://stedolan.github.io/jq/download/][jq]]</code> installed</li>
<li>You have IAM credentials with permissions to run AWS Batch, read AWS S3 and create AWS EC2 machines.</li>
<li>You installed <code>awscli</code> and configure your credentials following the standard instructions.</li>
<li>You have access to a S3 bucket:</li>
<li>You have a AWS ECR repository with the following form: <code>dsapp/triage-cli</code></li>
<li>You have a AWS Batch job queue configured and have permissions for adding, running, canceling jobs.</li>
</ul>
<p>You can check if you have the <code>AWS S3</code> permissions like:</p>
<div class="codehilite"><pre><span></span>[AWS_PROFILE=your_profile] aws ls [your-bucket]   # (dont&#39;t forget the last backslash)
</pre></div>


<p>And for the <code>AWS Batch</code> part:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> aws batch describe-job-queues
<span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> aws batch describe-job-definitions
</pre></div>

<h3>Configuration</h3>
<p>First we need to customize the file <code>.aws_env</code> (yes, another environment file).</p>
<p>Copy the file <code>aws_env.example</code> to <code>.aws_env</code> and fill the blanks</p>
<p><strong>NOTE</strong>: Don't include the <code>s3://</code> protocol prefix in the <code>S3_BUCKET</code></p>
<h4>(Local) Environment variables</h4>
<div class="highlight"><pre><span></span>#!/usr/bin/env bash

PROJECT_NAME=dirtyduck
TRIAGE_VERSION=3.3.0
ENV=development
AWS_REGISTRY={your-ecr-registry}
AWS_JOB_QUEUE={your-job-queue}
POSTGRES_DB={postgresql://user:password@db_server/dbname}
S3_BUCKET={your-bucket}
</pre></div>

<p>To check if everything is correct you can run:</p>
<div class="codehilite"><pre><span></span>[AWS_PROFILE=your_profile]  ./deploy.sh -h
</pre></div>


<p>Next, we need 3 files for running in AWS Batch, copy the files and remove the <code>.example</code> extension and adapt them to your case:</p>
<h4>Job definition</h4>
<p>Change the <code>PROJECT_NAME</code> and <code>AWS_ACCOUNT</code> for their real values</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;containerProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;--tb&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::experiment_file&quot;</span><span class="p">,</span>
      <span class="s2">&quot;--project-path&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::output_path&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::replace&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::save_predictions&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::profile&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::validate&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_ACCOUNT.dkr.ecr.us-west-2.amazonaws.com/YOUR_TRIAGE_IMAGE&quot;</span><span class="p">,</span>
    <span class="nt">&quot;jobRoleArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::AWS_ACCOUNT:role/dsappBatchJobRole&quot;</span><span class="p">,</span>
    <span class="nt">&quot;memory&quot;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span>
    <span class="nt">&quot;vcpus&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nt">&quot;jobDefinitionName&quot;</span><span class="p">:</span> <span class="s2">&quot;triage-cli-experiment&quot;</span><span class="p">,</span>
  <span class="nt">&quot;retryStrategy&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;attempts&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;container&quot;</span>
<span class="p">}</span>
</pre></div>

<h4>Environment variables overrides (for docker container inside the AWS EC2)</h4>
<p>Fill out the missing values</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;environment&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;us-west-2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS_JOB_QUEUE&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_HOST&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<h4><code>credentials-filter</code></h4>
<p>Leave this file as is (We will use it for storing the temporal token in <code>deploy.sh</code>)</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="nt">&quot;environment&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="err">.Credentials.AccessKeyId</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="err">.Credentials.SecretAccessKey</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SESSION_TOKEN&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="err">.Credentials.SessionToken</span>
                <span class="p">}</span>
        <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<h4>Running an experiment</h4>
<p>We provided a simple bash file for creating the image, uploading/updating the job definition and running the experiment:</p>
<div class="codehilite"><pre><span></span>./deploy.sh -h

Usage: ./deploy.sh (-h | -i | -u | -b | -r | -a | --sync_{to,from}_s3 )
OPTIONS:
   -h|--help                   Show this message
   -i|--info                   Show information about the environment
   -b|--update-images          Build the triage image and push it to the AWS ECR
   -u|--update-jobs            Update the triage job definition in AWS Batch
   -r|--run-experiment         Run experiments on chile-dt data
   --sync-to-s3                Uploads the experiments and configuration files to s3://your_project
   --sync-from-s3              Gets the experiments and configuration files from s3://your_project
EXAMPLES:
   Build and push the images to your AWS ECR:
        $ ./deploy.sh -b
   Update the job&#39;s definitions:
        $ ./deploy.sh -u
   Run triage experiments:
        $ ./deploy.sh -r --experiment_file=s3://your_project/experiments/test.yaml,project_path=s3://your_project/triage,replace=--replace
</pre></div>


<p>If you have multiple AWS profiles use <code>deploy.sh</code> as follows:</p>
<div class="codehilite"><pre><span></span>[AWS_PROFILE=your_profile] ./deploy.sh -r [job-run-name] experiment_file=s3://{your_bucket}/experiments/simple_test_skeleton.yaml,output_path=s3://{your_bucket}/triage,replace=--no-replace,save_predictions=--no-save-predictions,profile=--profile,validate=--validate
</pre></div>


<p>Where <code>your_profile</code> is the name of the profile in <code>~/.aws/credentials</code></p>
<h4>Suggested workflow</h4>
<p>The workflow now is:</p>
<ul>
<li>
<p>At the beginning of the project</p>
<ul>
<li>Set a <code>docker image</code> and publish it to the AWS ECR (if needed, or you can use the <code>triage</code> official one).</li>
</ul>
<blockquote>
<p>You could create different images if you want to run something more tailored to you (like not using the <code>cli</code> interface)</p>
</blockquote>
<ul>
<li>
<p>Create a <em>job definition</em> and publish it:</p>
<p>[AWS_PROFILE=your_profile] ./deploy.sh -u</p>
</li>
</ul>
<blockquote>
<p>You could create different jobs if, for example, you want to have different resources (maybe small resources for testing or a lot of resources for a big experiment)</p>
</blockquote>
</li>
<li>
<p>Every time that you have an idea about how to improve the results</p>
<ul>
<li>
<p>Create experiment files and publish them to the <code>s3</code> bucket:</p>
<p>[AWS_PROFILE=your_profile] ./deploy.sh --synt-to-s3</p>
</li>
<li>
<p>Run the experiments</p>
<p>[AWS_PROFILE=your_profile] ./deploy.sh -r [job-run-name] experiment_file=s3://{your_bucket}/experiments/simple_test_skeleton.yaml,output_path=s3://{your_bucket}/triage,replace=--no-replace,save_predictions=--no-save-predictions,profile=--profile,validate=--validate</p>
</li>
</ul>
</li>
</ul>
<h2>What's next?</h2>
<ul>
<li>Add the shape file <a href="https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&amp;format=Shapefile">https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&amp;format=Shapefile</a> and generate geospatial variables using <code>location</code></li>
<li>Text analysis on the <em>violations</em>' <code>comments</code> column and generate new <em>outcomes</em> or <em>features</em>?</li>
<li>Run <code>some deduplication and had a better =semantic.entities</code>?</li>
<li>Routing based on the inspection list?</li>
<li>Add more data sources (Census, Schools, bus stops, ACS data, Yelp!):<ul>
<li><a href="https://data.cityofchicago.org/Community-Economic-Development/Business-Licenses/r5kz-chrr">Business Licenses</a></li>
<li>Food Inspections</li>
<li><a href="https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2">Crime</a></li>
<li>Garbage Cart Complaints</li>
<li><a href="https://data.cityofchicago.org/Service-Requests/311-Service-Requests-Sanitation-Code-Complaints/me59-5fac">Sanitation Complaints</a></li>
<li>Weather</li>
<li>Sanitarian Information</li>
</ul>
</li>
</ul>
<h2>Appendix: For the impatient</h2>
<p>If you want to skip all the cleansing and transformation and deep directly into <code>triage</code> you can execute the following <em>inside bastion</em>:</p>
<div class="highlight"><pre><span></span>     curl <span class="s2">&quot;https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD&quot;</span> &gt; data/inspections.csv

     psql <span class="si">${</span><span class="nv">DATABASE_URL</span><span class="si">}</span> -c <span class="s2">&quot;\copy raw.inspections FROM &#39;/data/inspections.csv&#39; WITH HEADER CSV&quot;</span>

     psql <span class="si">${</span><span class="nv">DATABASE_URL</span><span class="si">}</span> &lt; /sql/create_cleaned_inspections_table.sql

     psql <span class="si">${</span><span class="nv">DATABASE_URL</span><span class="si">}</span> &lt; /sql/create_violations_table.sql

     psql <span class="si">${</span><span class="nv">DATABASE_URL</span><span class="si">}</span> &lt; /sql/create_semantic_tables.sql
</pre></div>

<p>If everything works, you should end with two new schemas: <code>cleaned</code> and <code>semantic</code>.</p>
<p>You could check that (from <code>psql</code>) With</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">dn</span>
</pre></div>

<table>
<thead>
<tr>
<th>List of schemas</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td>Owner</td>
</tr>
<tr>
<td>cleaned</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>postgis</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>public</td>
<td>postgres</td>
</tr>
<tr>
<td>raw</td>
<td>food<sub>user</sub></td>
</tr>
<tr>
<td>semantic</td>
<td>food<sub>user</sub></td>
</tr>
</tbody>
</table>
<p>Now you can continue to the introduction to triage section.</p>
<h3>Footnotes</h3>
<p><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> Several examples use this dataset, such as <a href="https://chicago.github.io/food-inspections-evaluation/">City of Chicago Food Inspection Forecasting</a>, <a href="https://youtu.be/lyDLAutA88s">PyCon 2016 keynote: Built in Super Heroes</a>, and <a href="https://youtu.be/1dKonIT-Yak">PyData 2016: Forecasting critical food violations at restaurants using open data</a>.</p>
<p><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> It is also possible to do "visit-level prediction" type of ML problem.</p>
<p><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> Examples include <a href="http://dsapp.uchicago.edu/projects/environment/">Predictive Enforcement of Hazardous Waste Regulations</a> and <a href="http://dsapp.uchicago.edu/projects/health/lead-prevention/">Targeting Proactive Inspections for Lead Hazards</a>.</p>
<p><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> Examples include <a href="http://dsapp.uchicago.edu/projects/education/">Increasing High School Graduation Rates: Early Warnings and Predictive Systems</a>, <a href="http://dsapp.uchicago.edu/projects/public-safety/police-eis/">Building Data-Driven Early Intervention Systems for Police Officers</a>, and <a href="http://dsapp.uchicago.edu/projects/criminal-justice/data-driven-justice-initiative/">Data-Driven Justice Initiative: Identifying Frequent Users of Multiple Public Systems for More Effective Early Assistance</a>.</p>
<p><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> Defined as "bakery, banquet hall, candy store, caterer, coffee shop, day care center (for ages less than 2), day care center (for ages 2 – 6), day care center (combo, for ages less than 2 and 2 – 6 combined), gas station, Golden Diner, grocery store, hospital, long term care center(nursing home), liquor store, mobile food dispenser, restaurant, paleteria, school, shelter, tavern, social club, wholesaler, or Wrigley Field Rooftop" (<a href="https://data.cityofchicago.org/api/views/4ijn-s7e5/files/O9cwLJ4wvxQJ2MirxkNzAUCCMQiM31DMzRkckMsKlxc?download=true&amp;filename=foodinspections_description.pdf">source</a>).</p>
<p><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> This points is particularly acute: Imagine the scenario in which the <em>inspections</em> problem is <strong>crime prediction</strong> in order to send cops (inspectors)to that "risky" area (facilities)&#x2026;</p>
<p><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> Reproducible, scalable, flexible, etc.</p>
<p><sup><a id="fn.8" class="footnum" href="#fnr.8">8</a></sup> And other things through this tutorial, like the execution of the model training, etc.</p>
<p><sup><a id="fn.9" class="footnum" href="#fnr.9">9</a></sup> If you have a postgresql client installed, you can use <code>psql -h 0.0.0.0 -p 5434 -d food -U food_user</code> rather than the <code>bastion</code> container.</p>
<p><sup><a id="fn.10" class="footnum" href="#fnr.10">10</a></sup> Welcome to the not-so-sexy part of the (supposedly) <em>sexiest job</em> of the XXI century.</p>
<p><sup><a id="fn.11" class="footnum" href="#fnr.11">11</a></sup> If you want to try different columns (or you don't remember which columns try <code>\d raw.inspectios</code> first</p>
<p><sup><a id="fn.12" class="footnum" href="#fnr.12">12</a></sup> We are following the <a href="https://en.wikipedia.org/wiki/Event_(relativity)">event's definition from physics</a>: "an event is the instantaneous physical situation or occurrence associated with a point in spacetime"</p>
<p><sup><a id="fn.13" class="footnum" href="#fnr.13">13</a></sup> It will make your life easier and most of the Machine Learning algorithms only accept data in matrix form (i.e. one big table)</p>
<p><sup><a id="fn.14" class="footnum" href="#fnr.14">14</a></sup> Verbatim from the datasource documentation.</p>
<p><sup><a id="fn.15" class="footnum" href="#fnr.15">15</a></sup> A controversial decision, I know.</p>
<p><sup><a id="fn.16" class="footnum" href="#fnr.16">16</a></sup> This problem is related to the process of <em>deduplication</em> and there is another DSaPP tool for that: <a href="https://dssg.github.io/matching-tool/">matching-tool</a>.</p>
<p><sup><a id="fn.17" class="footnum" href="#fnr.17">17</a></sup> It is the <em>Chicago</em> Food Inspections dataset, after all.</p>
<p><sup><a id="fn.18" class="footnum" href="#fnr.18">18</a></sup> We could also use the default geometric data type from postgresql: <code>point</code> (<a href="https://www.postgresql.org/docs/10/datatype-geometric.html">https://www.postgresql.org/docs/10/datatype-geometric.html</a>)</p>
<p><sup><a id="fn.19" class="footnum" href="#fnr.19">19</a></sup> We will store the <code>Point</code> as a <code>geography</code> object. As a result, spatial database operations (like calculating the distances between two facilities) will return answers in meters instead of degrees. See <a href="http://workshops.boundlessgeo.com/postgis-intro/geography.html">this</a>.</p>
<p><sup><a id="fn.20" class="footnum" href="#fnr.20">20</a></sup> As a real geographical object <a href="https://postgis.net/docs/ST_MakePoint.html">check the PostGIS documentation</a></p>
<p><sup><a id="fn.21" class="footnum" href="#fnr.21">21</a></sup> Remember our tip at the beginning of this section!</p>
<p><sup><a id="fn.22" class="footnum" href="#fnr.22">22</a></sup> If the code looks funny to you, it is because we are using <a href="https://www.postgresql.org/docs/devel/queries-table-expressions.html#QUERIES-GROUPING-SETS">grouping sets</a>, in particular <code>rollup</code>. See the docs.</p>
<p><sup><a id="fn.23" class="footnum" href="#fnr.23">23</a></sup> Yeah, you wish</p>
<p><sup><a id="fn.24" class="footnum" href="#fnr.24">24</a></sup> Almost. At least good for this tutorial. Look carefully.</p>
<p><sup><a id="fn.25" class="footnum" href="#fnr.25">25</a></sup> <strong>ALWAYS</strong> add indexes to your tables!</p>
<p><sup><a id="fn.26" class="footnum" href="#fnr.26">26</a></sup> If you want to have a deep explanation about why is this good check <a href="http://coussej.github.io/2016/01/14/Replacing-EAV-with-JSONB-in-PostgreSQL/">this blog post</a></p>
<p><sup><a id="fn.27" class="footnum" href="#fnr.27">27</a></sup> As a general rule I hate to add the suffix <code>_id</code>, I would rather prefer to name them as <code>event</code> and <code>entity</code> instead of <code>event_id</code> and <code>entity_id</code>. But <code>triage</code> named those columns in that way and for that we are stuck with that nomenclature.</p>
<p><sup><a id="fn.28" class="footnum" href="#fnr.28">28</a></sup> This will simplify the creation of <em>features</em> for our machine learning models.</p>
<p><sup><a id="fn.29" class="footnum" href="#fnr.29">29</a></sup> <a href="https://en.wikipedia.org/wiki/Exploratory_data_analysis">Defined</a> by John Tukey as: <em>Procedures for analyzing data, techniques for interpreting the results of such procedures, ways of planning the gathering of data to make its analysis easier, more precise or more accurate, and all the machinery and results of (mathematical) statistics which apply to analyzing data.</em></p>
<p><sup><a id="fn.30" class="footnum" href="#fnr.30">30</a></sup> <em>Would be my restaurant inspected in the following month?</em> in the case of an <strong>early warning</strong> case.</p>
<p><sup><a id="fn.31" class="footnum" href="#fnr.31">31</a></sup> It's a little more complicated than that as we will see.</p>
<p><sup><a id="fn.32" class="footnum" href="#fnr.32">32</a></sup> All events produce some <em>outcome</em>. In theory <strong>every</strong> event of interest in stored in a database. These events are <em>immutable</em>: you can't (shouldn't) change them (they already happen).</p>
<p><sup><a id="fn.33" class="footnum" href="#fnr.33">33</a></sup> We could consider different states, for example: we can use the column <code>risk</code> as an state. Another possibility is define a new state called <code>failed</code> that indicates if the facility failed in the last time it was inspected. One more: you could create cohorts based on the <code>facility_type.</code></p>
<p><sup><a id="fn.34" class="footnum" href="#fnr.34">34</a></sup> The city in this toy example has very low resources.</p>
<p><sup><a id="fn.35" class="footnum" href="#fnr.35">35</a></sup> See for example: <a href="https://robjhyndman.com/hyndsight/tscv/">https://robjhyndman.com/hyndsight/tscv/</a></p>
<p><sup><a id="fn.36" class="footnum" href="#fnr.36">36</a></sup> I know, I know. And in order to cover all the cases, we are still missing one or two parameters, but we are working on it.</p>
<p><sup><a id="fn.37" class="footnum" href="#fnr.37">37</a></sup> Obscure reference to the "<a href="https://www.imdb.com/title/tt0417299/">Avatar: The Last Airbender</a>" cartoon series. I'm sorry.</p>
<p><sup><a id="fn.38" class="footnum" href="#fnr.38">38</a></sup> <code>collate</code> is to <em>feature generation</em> what <code>timechop</code> is to <em>date temporal splitting</em></p>
<p><sup><a id="fn.39" class="footnum" href="#fnr.39">39</a></sup> <code>triage</code> uses <strong>a lot</strong> of <code>yaml</code>, <a href="https://github.com/Animosity/CraftIRC/wiki/Complete-idiot%27s-introduction-to-yaml">this guide</a> could be handy</p>
<p><sup><a id="fn.40" class="footnum" href="#fnr.40">40</a></sup> Note that the name <code>categoricals</code> is confusing here: The original variable (i.e. a column) is categorical, the aggregate of that column is not. The same with the <code>aggregates</code>: The original column could be a categorical or a numeric (to be fare most of the time is a numeric column, but see the example: <em>we are counting</em>), and then <code>triage</code> applies an aggregate that will be numeric. That is how triage named things, and yes, I know is confusing.</p>
<p><sup><a id="fn.41" class="footnum" href="#fnr.41">41</a></sup> <code>triage</code> will generate also a new binary column that indicates if the value of the feature was imputed (<code>1</code>) or not (<code>0</code>): <code>inspections_entity_id_6month_total_count_imp</code>.</p>
<p><sup><a id="fn.42" class="footnum" href="#fnr.42">42</a></sup> Literally from the configuration file. If you modify something it will generate a new hash. Handle with care!</p>
<p><sup><a id="fn.43" class="footnum" href="#fnr.43">43</a></sup> If you assume a <em>uniform</em> distribution, it will make sense to select facilities at random.</p>
<p><sup><a id="fn.44" class="footnum" href="#fnr.44">44</a></sup> The underlying assumption here is that the City of Chicago is <em>currently</em> doing <em>random</em> selection for the inspections. This is not true (and probably unfair). In a real project, you will setup a <strong>real</strong> baseline and you will compare your models against it. This baseline could be a rule or a model.</p>
<p><sup><a id="fn.45" class="footnum" href="#fnr.45">45</a></sup> You need to check this! Fortunately, <code>triage</code> allows you to try several options here, so, if you think that this is too high or too low you can change that and fit your needs.</p>
<p><sup><a id="fn.46" class="footnum" href="#fnr.46">46</a></sup> Think about it: we <strong>can’t</strong> learn the relationship between the <em>features</em> and the <em>label</em> if we <strong>don't know</strong> the label.</p>
<p><sup><a id="fn.47" class="footnum" href="#fnr.47">47</a></sup> In order to reduce the computational time that takes running this tutorial, we sample the facilities. If you want to train in the complete set of <strong>active</strong> ones, please remove the <code>CTE</code> part of the query and the <code>WHERE</code> clause referring the <code>bucket</code>.</p>
<p><sup><a id="fn.48" class="footnum" href="#fnr.48">48</a></sup> The formulas are, for <code>precision@k</code>, is the proportion of facilities correctly identified in the top-<span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> facilities ranked by risk:</p>
<div>
<div class="MathJax_Preview"> precision@k = \frac{TP \in k}{k} </div>
<script type="math/tex; mode=display"> precision@k = \frac{TP \in k}{k} </script>
</div>
<p>This is a measure about <em>how efficiently</em> are your system using your resources.</p>
<p><code>recall@k</code>, in the other hand is the proportion of <em>all</em> the facilities that are risk found in the top-<span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span></p>
<div>
<div class="MathJax_Preview"> recall@k = \frac{TP \in k}{TP} </div>
<script type="math/tex; mode=display"> recall@k = \frac{TP \in k}{TP} </script>
</div>
<p><em>recall</em> is a measure about the <em>coverage</em> of your system, i.e. <em>how good is identifying in the top-<span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> the facilities at risk</em>.</p>
<p>One possible variation of this is to <strong>only</strong> include in the denominator the <em>labeled</em> rows in <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span>. <strong>This the approach</strong> used by <code>triage</code>.</p>
<p><sup><a id="fn.49" class="footnum" href="#fnr.49">49</a></sup> We will explore how to one way to tackle this in the advance part of this tutorial.</p>
<p><sup><a id="fn.50" class="footnum" href="#fnr.50">50</a></sup> The flags <code>-no-save-predictions</code> and <code>profile</code> are not necessary but useful. The first one configure triage to not store the predictions (at this stage you don't need them, and you can always could recreate them from the model and the matrix). This will save you execution time. The flag <code>profile</code> stores the <em>execution</em> profile times in a file, so you can check which models or matrices are taking a lot of time on been built.</p>
<p><sup><a id="fn.51" class="footnum" href="#fnr.51">51</a></sup> From a more mathematical point of view: Your data actually reflects the empirical probability: <span><span class="MathJax_Preview">P(violation|inspected)</span><script type="math/tex">P(violation|inspected)</script></span>, i.e. the probability of find a violation given that the facility is inspected. But the probability that you want is <span><span class="MathJax_Preview">P(violation)</span><script type="math/tex">P(violation)</script></span> (yes, I know that there are no such things as unconditional probabilities, please bare with me),i.e. the probability that the facility is in violation.</p>
<p><sup><a id="fn.52" class="footnum" href="#fnr.52">52</a></sup> You should see that this assumption is very dangerous in other settings, for example, crime prediction.</p>
<p><sup><a id="fn.53" class="footnum" href="#fnr.53">53</a></sup> The discussion was <del>taken</del> stolen from <a href="https://dssg.uchicago.edu/2017/07/14/data-driven-inspections-for-safer-housing-in-san-jose-california/">Data-Driven Inspections for Safer Housing in San Jose, California</a> (Kit Rodolfa, Jane Zanzig 2016) Great read by the way!</p>
<p><sup><a id="fn.54" class="footnum" href="#fnr.54">54</a></sup> This assumes that you are in a GNU/Linux machine, if not (you should reconsider what are you doing with your life) you should change the ip address (<code>0.0.0.0</code>) and use the one from the docker virtual machine.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/dssg/hitchhikers-guide" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/datascifellows" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/center-for-data-science-and-public-policy-university-of-chicago" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.267712eb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../js/mermaid.min.js"></script>
      
    
  </body>
</html>