



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for Triage.">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.2.0">
    
    
      
        <title>Data preparation - Triage Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.750b69bd.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#data-preparation" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Triage Documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon">book</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Triage Documentation
            </span>
            <span class="md-header-nav__topic">
              Data preparation
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="http://github.com/dssg/triage/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Triage Documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">book</i>
      
    </a>
    Triage Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="http://github.com/dssg/triage/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Get started with your own project
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Get started with your own project
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../quickstart/" title="Quickstart guide" class="md-nav__link">
      Quickstart guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../triage_project_workflow/" title="Suggested workflow" class="md-nav__link">
      Suggested workflow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Dirty Duck Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Dirty Duck Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Welcome!" class="md-nav__link">
      Welcome!
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dirty_duckling/" title="Dirty duckling" class="md-nav__link">
      Dirty duckling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Case studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Case studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../problem_description/" title="Problem description" class="md-nav__link">
      Problem description
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../eis/" title="Early Warning System" class="md-nav__link">
      Early Warning System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../inspections/" title="Resource prioritization" class="md-nav__link">
      Resource prioritization
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Triage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Triage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../triage_intro/" title="A deeper look into triage" class="md-nav__link">
      A deeper look into triage
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5" checked>
    
    <label class="md-nav__link" for="nav-3-5">
      Are you curious about the setup?
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Are you curious about the setup?
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../infrastructure/" title="Infrastructure" class="md-nav__link">
      Infrastructure
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Data preparation
      </label>
    
    <a href="./" title="Data preparation" class="md-nav__link md-nav__link--active">
      Data preparation
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#load-the-data" title="Load the data" class="md-nav__link">
    Load the data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transforming-and-cleaning-the-data" title="Transforming (and cleaning) the data" class="md-nav__link">
    Transforming (and cleaning) the data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rationale" title="Rationale" class="md-nav__link">
    Rationale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-road" title="Data road" class="md-nav__link">
    Data road
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset-documentation" title="Dataset documentation" class="md-nav__link">
    Dataset documentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reality-check" title="Reality check" class="md-nav__link">
    Reality check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleaning" title="Cleaning" class="md-nav__link">
    Cleaning
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#semantic-tables" title="Semantic tables" class="md-nav__link">
    Semantic tables
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entities-table" title="Entities table" class="md-nav__link">
    Entities table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-table" title="Events table" class="md-nav__link">
    Events table
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lets-eda" title="Let's EDA &#x2026;" class="md-nav__link">
    Let's EDA &#x2026;
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspections-over-time" title="Inspections over time" class="md-nav__link">
    Inspections over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-facilities-inspected-over-time" title="Number of facilities inspected over time" class="md-nav__link">
    Number of facilities inspected over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-failed-inspections-over-time" title="Number of failed inspections over time" class="md-nav__link">
    Number of failed inspections over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-facilities-with-failed-inspections-over-time" title="Number of facilities with failed inspections over time" class="md-nav__link">
    Number of facilities with failed inspections over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-severe-violations-found-in-a-failed-inspection-over-time" title="Number of severe violations found in a failed inspection over time" class="md-nav__link">
    Number of severe violations found in a failed inspection over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-facilities-with-severe-violations-found-in-a-failed-inspection-over-time" title="Number of facilities with severe violations found in a failed inspection over time" class="md-nav__link">
    Number of facilities with severe violations found in a failed inspection over time
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" title="What’s next?" class="md-nav__link">
    What’s next?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../for_the_impatient/" title="Quick setup" class="md-nav__link">
      Quick setup
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Triage documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Triage documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Experiment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Experiment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/experiment-config/" title="Experiment Configuration" class="md-nav__link">
      Experiment Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/feature-testing/" title="Testing Feature Configuration" class="md-nav__link">
      Testing Feature Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/running/" title="Running an Experiment" class="md-nav__link">
      Running an Experiment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-4" type="checkbox" id="nav-4-1-4">
    
    <label class="md-nav__link" for="nav-4-1-4">
      Upgrading an Experiment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-4">
        Upgrading an Experiment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/upgrade-to-v7/" title="v6 -> v7" class="md-nav__link">
      v6 -> v7
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/upgrade-to-v6/" title="v5 -> v6" class="md-nav__link">
      v5 -> v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/upgrade-to-v5/" title="v3/v4 -> v5" class="md-nav__link">
      v3/v4 -> v5
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/temporal-validation/" title="Temporal Validation Deep Dive" class="md-nav__link">
      Temporal Validation Deep Dive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/cohort-labels/" title="Cohort and Label Deep Dive" class="md-nav__link">
      Cohort and Label Deep Dive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/prediction-ranking/" title="Prediction Ranking" class="md-nav__link">
      Prediction Ranking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/features/" title="Feature Generation Recipe Book" class="md-nav__link">
      Feature Generation Recipe Book
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/algorithm/" title="Experiment Algorithm" class="md-nav__link">
      Experiment Algorithm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experiments/architecture/" title="Experiment Architecture" class="md-nav__link">
      Experiment Architecture
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      Model selection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        Model selection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../audition/audition/" title="Using Audition" class="md-nav__link">
      Using Audition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../audition/audition-config/" title="Audition Configuration" class="md-nav__link">
      Audition Configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      Postmodeling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        Postmodeling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../postmodeling/" title="Using Postmodeling" class="md-nav__link">
      Using Postmodeling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../postmodeling/postmodeling-config/" title="Postmodeling & Crosstabs Configuration" class="md-nav__link">
      Postmodeling & Crosstabs Configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ml_governance/" title="Model governance" class="md-nav__link">
      Model governance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aws_batch/" title="Scaling up" class="md-nav__link">
      Scaling up
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#load-the-data" title="Load the data" class="md-nav__link">
    Load the data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transforming-and-cleaning-the-data" title="Transforming (and cleaning) the data" class="md-nav__link">
    Transforming (and cleaning) the data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rationale" title="Rationale" class="md-nav__link">
    Rationale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-road" title="Data road" class="md-nav__link">
    Data road
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset-documentation" title="Dataset documentation" class="md-nav__link">
    Dataset documentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reality-check" title="Reality check" class="md-nav__link">
    Reality check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleaning" title="Cleaning" class="md-nav__link">
    Cleaning
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#semantic-tables" title="Semantic tables" class="md-nav__link">
    Semantic tables
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entities-table" title="Entities table" class="md-nav__link">
    Entities table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-table" title="Events table" class="md-nav__link">
    Events table
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lets-eda" title="Let's EDA &#x2026;" class="md-nav__link">
    Let's EDA &#x2026;
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspections-over-time" title="Inspections over time" class="md-nav__link">
    Inspections over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-facilities-inspected-over-time" title="Number of facilities inspected over time" class="md-nav__link">
    Number of facilities inspected over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-failed-inspections-over-time" title="Number of failed inspections over time" class="md-nav__link">
    Number of failed inspections over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-facilities-with-failed-inspections-over-time" title="Number of facilities with failed inspections over time" class="md-nav__link">
    Number of facilities with failed inspections over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-severe-violations-found-in-a-failed-inspection-over-time" title="Number of severe violations found in a failed inspection over time" class="md-nav__link">
    Number of severe violations found in a failed inspection over time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-of-facilities-with-severe-violations-found-in-a-failed-inspection-over-time" title="Number of facilities with severe violations found in a failed inspection over time" class="md-nav__link">
    Number of facilities with severe violations found in a failed inspection over time
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" title="What’s next?" class="md-nav__link">
    What’s next?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="http://github.com/dssg/triage/edit/master/docs/sources/dirtyduck/data_preparation.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="data-preparation">Data preparation<a class="headerlink" href="#data-preparation" title="Permanent link">#</a></h1>
<p>We need to get the data and transform it into a shape that is suitable for the analysis.</p>
<p><strong>NOTE:</strong> Unless we say otherwise, you should run all the following commands inside <code>bastion</code>.</p>
<h2 id="load-the-data">Load the data<a class="headerlink" href="#load-the-data" title="Permanent link">#</a></h2>
<p>Before loading the data into the database, verify that the database
table is empty by running the following code:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>count</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
</tr>
</tbody>
</table>
<p>We will use some <code>postgresql</code> magic in order to get the data in our
database. In particular we will use the powerful
<a href="https://www.postgresql.org/docs/10/sql-copy.html">copy</a> command and
the City of Chicago's data API:</p>
<div class="highlight"><pre><span></span><span class="err">\</span><span class="k">copy</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span> <span class="k">from</span> <span class="n">program</span> <span class="s1">&#39;curl &quot;https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD&quot;&#39;</span> <span class="n">HEADER</span> <span class="n">CSV</span>
</pre></div>

<p>Now, you should have some data:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;facilities inspected&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>facilities inspected</th>
</tr>
</thead>
<tbody>
<tr>
<td>186,426</td>
</tr>
</tbody>
</table>
<p>You'll probably get a different number because the data are updated
every day. Let's peek inside the table<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">inspection</span><span class="p">,</span>
    <span class="n">dba_name</span><span class="p">,</span>
    <span class="n">risk</span><span class="p">,</span>
    <span class="n">results</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>inspection</th>
<th>dba_name</th>
<th>risk</th>
<th>results</th>
</tr>
</thead>
<tbody>
<tr>
<td>2268241</td>
<td>ANTOJITOS PUEBLITA INC</td>
<td>Risk 1 (High)</td>
<td>Pass w/ Conditions</td>
</tr>
</tbody>
</table>
<p>Ok, now you have some data loaded! But we still need to <em>munge</em> it to
use it in our machine learning task.</p>
<h2 id="transforming-and-cleaning-the-data">Transforming (and cleaning) the data<a class="headerlink" href="#transforming-and-cleaning-the-data" title="Permanent link">#</a></h2>
<h3 id="rationale">Rationale<a class="headerlink" href="#rationale" title="Permanent link">#</a></h3>
<p>To tackle a machine learning problem, you need to identify the
<strong>entities</strong> for your problem domain. Also, if your problem involves
time, you will need to understand how those entities change, either
what <strong>events</strong> happen to the
entity or what <strong>events</strong> the entity affects.</p>
<p>We will encode this information into two tables, one named <code>entities</code>
and the other named <code>events</code>.</p>
<p>The entity, in this example, is the food <strong>facility</strong>, and the events
are the <strong>inspections</strong> on the facility.</p>
<p>The <code>entities</code> table should contain a unique identifier for the entity
and some data about that entity (like name, age and status). The <code>events</code>
table will include data related to the inspection, including the two
most important attributes: its spatial and temporal positions <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.</p>
<p>Before we start the data cleaning, make your life easier by following this
rule:</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><em>Do not change the original data</em></p>
</div>
<p>The reason is, if you make a mistake or want to try a different data
transformation, you can always can go back to the <code>raw</code> data and start
over.</p>
<h3 id="data-road">Data road<a class="headerlink" href="#data-road" title="Permanent link">#</a></h3>
<p>The transformation "road" that we will take in this tutorial is as follows:</p>
<ol>
<li>Put a copy of the data in the <code>raw</code> schema. (We just did that.)</li>
<li>Apply some simple transformations and store the resulting data in the <code>cleaned</code> schema.</li>
<li>Organize the data into two <em>unnormalized</em><sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> tables in the
    semantic schema: <code>events</code> and <code>entities</code>.</li>
<li>Run <code>triage</code>. It will create several schemas (<code>model_metadata</code>, <code>test_results</code>, <code>train_results</code>).</li>
</ol>
<p><img alt="img" src="../images/data_road.png" /></p>
<p><a id="orga5ba5d1"></a></p>
<h3 id="dataset-documentation">Dataset documentation<a class="headerlink" href="#dataset-documentation" title="Permanent link">#</a></h3>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For an updated version of the documentation of this dataset see
<a href="https://www.chicago.gov/city/en/depts/cdph/provdrs/healthy_restaurants/svcs/food-protection-services.html">Food Protection
Services</a>.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The Food Code Rules (effective 2/1/2019) could be consulted
<a href="https://www.chicago.gov/content/dam/city/depts/cdph/food_env/general/Food_Protection/FoodCodeRules_Effective_Feb12019.pdf">here</a>.</p>
</div>
<p>The Chicago Food Inspection dataset has documentation
<a href="https://data.cityofchicago.org/api/assets/BAD5301B-681A-4202-9D25-51B2CAE672FF?download=true">here</a>.</p>
<p>We can use this documentation to better understand each column's meaning, and the process that generates the data.</p>
<p>Most columns are self-explanatory, but some are not<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup>:</p>
<div class="admonition quote">
<p class="admonition-title">Risk category of facility (<code>risk</code>)</p>
<p>Each establishment is categorized by its risk of adversely
affecting the public’s health, with 1 being the highest and 3 the
lowest. The frequency of inspection is tied to this risk, with risk =
1 establishments inspected most frequently and risk = 3 least
frequently.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Inspection type (<code>type</code>)</p>
<p>An inspection can be one of the following types:</p>
<ul>
<li><strong>Canvass</strong>, the most common type of inspection performed at a frequency relative to the
    risk of the establishment;</li>
<li><strong>Consultation</strong>, when the inspection is done at the request of the
    owner prior to the opening of the establishment;</li>
<li><strong>Complaint</strong>, when the inspection is done in response to  a
    complaint against the establishment</li>
<li><strong>License</strong>, when the inspection  is done as a requirement for the
    establishment to receive its license to operate;</li>
<li><strong>Suspect food poisoning</strong>, when the inspection is done in response
    to one or more persons claiming to have gotten ill as a result of
    eating at the establishment (a specific type of  complaint-based inspection);</li>
<li><strong>Task-force inspection</strong>, when an inspection of a bar or tavern is
    done.</li>
<li><strong>Re-inspections</strong> can occur for most types of these inspections and are indicated as such.</li>
</ul>
</div>
<div class="admonition quote">
<p class="admonition-title">Results (<code>results</code>)</p>
<p>An inspection can pass, pass with conditions, or fail. Establishments
receiving a ‘pass’ were found to have no critical or serious
violations (violation number 1-14 and 15-29,
respectively). Establishments receiving a ‘pass with conditions’ were
found to have critical or serious violations, but these were corrected
during the inspection. Establishments receiving a ‘fail’ were found to
have critical or serious violations that were not correctable during
the inspection. An establishment receiving a ‘fail’ does not
necessarily mean the establishment’s licensed is
suspended. Establishments found to be out of business or not located
are indicated as such.</p>
<div class="admonition info">
<p class="admonition-title">Important!</p>
<p>The result of the inspections (pass, pass with conditions or fail)
as well as the violations noted are based on the findings
identified and reported by the inspector at the time of the
inspection, and may not reflect the findings noted at other
times.</p>
</div>
</div>
<div class="admonition quote">
<p class="admonition-title">Violations (<code>violations</code>)</p>
<p>An establishment can receive <strong>one or more</strong> of 45 distinct
 violations (violation numbers 1-44 and 70). For each violation
 number listed for a given establishment, <em>the requirement the
 establishment must meet in order for it</em> to <strong>NOT</strong> <em>receive a
 violation is noted, followed by a specific description of the
 findings that caused the violation to be issued</em>.</p>
<div class="admonition warning">
<p class="admonition-title">Data Changes</p>
<p>On 7/1/2018 the Chicago Department of Public Health’s Food
Protection unit changed the definition of violations.
The changes don’t affect structurally the dataset (e.g. how the
violations are inputted to the database), but the redefinition
will change the distribution and interpretation of the violation codes.
See
<a href="https://www.cityofchicago.org/content/dam/city/depts/cdph/FoodProtection/ChicagoFoodCodeMajorChangesFinal2018.pdf">here</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Data Changes</p>
<p>On 2/1/2019 the Chicago Department of Public Health’s Food
Protection unit changed the requirements that the facilities must
follow.
See <a href="https://www.chicago.gov/content/dam/city/depts/cdph/food_env/general/Food_Protection/2019_ChicagoFoodCodeMajorChanges.pdf">here</a></p>
</div>
</div>
<p>We added emphasis to the last one.</p>
<p>From these definitions, we can infer the following:</p>
<ol>
<li><em>risk</em> is related to the frequency of inspections of type <em>canvass</em>.</li>
<li><em>consultation</em> is an inspection <em>before</em> the facility opens (so we can remove it from the data). The same happens with <em>license</em>.</li>
<li><em>complaint</em> and <em>suspected food poisoning</em> are triggered by people.</li>
<li><em>consultation</em> is triggered by the owner of the facility.</li>
<li><em>task-force</em> occurs at bars or taverns.</li>
<li><strong>Critical violations</strong> are coded between <code>1-14</code>, <strong>serious
    violations</strong> between <code>15-29</code>. We can assume that the violations
    code <code>30</code> and higher are <em>minor</em> violations. (see below)</li>
<li><em>violation</em> describes the problems found, and the comment section
    describes the steps the facility should take to fix the problem.</li>
<li>There are only three possible results of the inspection. (Also, an
    inspection may not happen if the facility was not located or went
    out of business).</li>
<li>There can be several <code>violations</code> per <code>inspection</code>.</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Data Changes</p>
<p>On 7/1/2018 <em>Critical violation</em> changed to <strong>Priority (P)
Violation</strong>, <em>Serious violation</em> changed to <strong>Priority Foundation
(PF) Violation</strong> and <em>Minor violation</em> changed to <strong>Core (C)
Violation</strong>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Data Changes</p>
<p>On 7/1/2018 the number of potential violations has increased from
45 to <strong>63</strong>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Data Changes</p>
<p>On 7/1/2018 <em>Corrected Dduring Inspection (CDI)</em> has been changed
to <strong>Corrected on Site (COS)</strong>. <em>Potentially Hazardous Foods
(PHF)</em> changed to <strong>Time/Temperature Control for Safety Foods (TCS
Foods)</strong>.</p>
</div>
<h3 id="reality-check">Reality check<a class="headerlink" href="#reality-check" title="Permanent link">#</a></h3>
<p>It is important to verify that the documentation is correct. Let's start by checking that the <code>risk</code> column <strong>only</strong> has three classifications:</p>
<p><strong>NOTE</strong> Execute this in <code>psql</code> inside the container <code>bastion</code>.</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">risk</span><span class="p">,</span>
      <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">risk</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>risk</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>Risk 1 (High)</td>
<td>133,170</td>
</tr>
<tr>
<td>Risk 2 (Medium)</td>
<td>36,597</td>
</tr>
<tr>
<td>Risk 3 (Low)</td>
<td>16,556</td>
</tr>
<tr>
<td>¤</td>
<td>75</td>
</tr>
<tr>
<td>All</td>
<td>28</td>
</tr>
</tbody>
</table>
<p>Ok, there are two extra <code>risk</code> types, <code>All</code> and <code>NULL</code>, for a grand total of <strong>5</strong>.</p>
<p>What about <code>types</code> of inspections?</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="k">type</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;types of inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>types of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>108</td>
</tr>
</tbody>
</table>
<p>Wow, there are <strong>108</strong> types of inspections instead of the expected <strong>5</strong>!</p>
<p>What are those types? How bad is it?</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">type</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">type</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span>
    <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>type</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>Canvass</td>
<td>99,792</td>
</tr>
<tr>
<td>License</td>
<td>24,385</td>
</tr>
<tr>
<td>Canvass Re-Inspection</td>
<td>19,380</td>
</tr>
<tr>
<td>Complaint</td>
<td>17,289</td>
</tr>
<tr>
<td>License Re-Inspection</td>
<td>8,572</td>
</tr>
<tr>
<td>Complaint Re-Inspection</td>
<td>7,060</td>
</tr>
<tr>
<td>Short Form Complaint</td>
<td>6,534</td>
</tr>
<tr>
<td>Suspected Food Poisoning</td>
<td>834</td>
</tr>
<tr>
<td>Consultation</td>
<td>671</td>
</tr>
<tr>
<td>License-Task Force</td>
<td>605</td>
</tr>
</tbody>
</table>
<p>This column will require also cleaning.</p>
<p>Finally, let's look <code>results</code> (should be 3)</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">results</span><span class="p">,</span>
      <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">results</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>results</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pass</td>
<td>103,528</td>
</tr>
<tr>
<td>Fail</td>
<td>35,948</td>
</tr>
<tr>
<td>Pass w/ Conditions</td>
<td>23,258</td>
</tr>
<tr>
<td>Out of Business</td>
<td>16,212</td>
</tr>
<tr>
<td>No Entry</td>
<td>5,784</td>
</tr>
<tr>
<td>Not Ready</td>
<td>1,630</td>
</tr>
<tr>
<td>Business Not Located</td>
<td>66</td>
</tr>
</tbody>
</table>
<p>Ok, disheartening. But that's the reality of <em>real</em> data. We'll try to clean this mess.</p>
<h3 id="cleaning">Cleaning<a class="headerlink" href="#cleaning" title="Permanent link">#</a></h3>
<p>Let's look at the data to figure out how we need to transform
it. We'll start with all the columns except <code>violations</code>. We'll deal
with that one later because it's more complex.</p>
<p>First, we'll remove superfluous spaces; convert the columns <code>type,
results, dba_name, aka_name, facility_type, address, city</code> to lower
case; and clean <code>risk</code>, keeping only the description (e.g. <code>high</code>
instead of <code>Risk 1 (High)</code>).</p>
<p>We still need to clean further the column <code>type</code> (which contains more
values than the <strong>seven</strong> mentioned in the documentation: <em>canvass</em>,
<em>complaint</em>, <em>license</em>, <em>re-inspection</em>, <em>task-force</em>, <em>consultation</em>,
and <em>suspected food poisoning</em>). For simplicity, we will use <em>regular
expressions</em> and ignore <em>re-inspection</em>.</p>
<p>For the column <code>risk</code>, we will impute as <code>high</code> all the <code>NULL</code> and <code>All</code> values<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup>.</p>
<p>As we have seen (and will continue see) through this tutorial, <em>real
data are messy</em>; for example, the column <code>dba_name</code> has several
spellings for the same thing: <code>SUBWAY</code> and <code>Subway</code>, <code>MCDONALDS</code> and
<code>MC DONALD'S</code>, <code>DUNKIN DONUTS/BASKIN ROBBINS</code> and <code>DUNKIN DONUTS /
BASKIN ROBBINS</code>, etc.</p>
<p>We could use
<a href="https://www.postgresql.org/docs/current/static/fuzzystrmatch.html">soundex</a>
or machine learning <em>deduplication</em><sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup> to clean these names, but
we'll go with a very simple cleaning strategy: convert all the names
to lowercase, remove the trailing spaces, remove the apostrophe, and
remove the spaces around "<code>/</code>". It won't completely clean those names,
but it's good enough for this example project.</p>
<p>Let's review the status of the spatial columns (<code>state, city, zip,
latitude, longitude</code>). Beginning with <code>state</code>, all the facilities in
the data should be located in <strong>Illinois</strong>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">state</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">state</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>state</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>IL</td>
<td>186,392</td>
</tr>
<tr>
<td>¤</td>
<td>34</td>
</tr>
</tbody>
</table>
<p>Ok, almost correct, there are some <code>NULL</code> values. We will assume that the <code>NULL</code> values are actually <code>IL</code> (i.e. we will impute them). Moving to the next spatial column, we expect that all the values in the column <code>city</code> are Chicago<sup id="fnref:7"><a class="footnote-ref" href="#fn:7">7</a></sup>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">lower</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">as</span> <span class="n">city</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">lower</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span>
    <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>city</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>chicago</td>
<td>186,009</td>
</tr>
<tr>
<td>¤</td>
<td>161</td>
</tr>
<tr>
<td>cchicago</td>
<td>44</td>
</tr>
<tr>
<td>schaumburg</td>
<td>23</td>
</tr>
<tr>
<td>maywood</td>
<td>16</td>
</tr>
<tr>
<td>elk grove village</td>
<td>13</td>
</tr>
<tr>
<td>evanston</td>
<td>10</td>
</tr>
<tr>
<td>chestnut street</td>
<td>9</td>
</tr>
<tr>
<td>cicero</td>
<td>9</td>
</tr>
<tr>
<td>inactive</td>
<td>8</td>
</tr>
</tbody>
</table>
<p>Oh boy. There are 150-ish rows with <code>NULL</code> values and forty-ish rows
with the value <code>cchicago</code>. Farther down the list (if you dare), we
even have <code>chicagochicago</code>. All the values are near Chicago, even if
they're in different counties, so we will ignore this column (or
equivalently, we will assume that all the records are from Chicago).</p>
<p>Zip code has a similar <code>NULL</code> problem:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections w/o zip code&quot;</span>
<span class="k">from</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">where</span>
    <span class="n">zip</span> <span class="k">is</span> <span class="k">null</span> <span class="k">or</span> <span class="n">btrim</span><span class="p">(</span><span class="n">zip</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>number of inspections w/o zip code</th>
</tr>
</thead>
<tbody>
<tr>
<td>75</td>
</tr>
</tbody>
</table>
<p>We could attempt to replace these <code>NULL</code> values using the location
point or using similar names of restaurants, but for this tutorial we
will remove them. Also, we will convert the coordinates latitude and
longitude to a Postgres <code>Point</code><sup id="fnref:8"><a class="footnote-ref" href="#fn:8">8</a></sup><sup id="fnref:9"><a class="footnote-ref" href="#fn:9">9</a></sup><sup id="fnref:10"><a class="footnote-ref" href="#fn:10">10</a></sup>.</p>
<p>We will drop the columns <code>state</code>, <code>latitude</code>, and <code>longitude</code> because
the <code>Point</code> contains all that information. We also will remove the
column <code>city</code> because almost everything happens in Chicago.</p>
<p>If you're keeping count, we are only keeping two columns related to
the spatial location of the events: the location of the facility
(<code>location</code>) and one related to inspection assignments (<code>zip_code</code>).</p>
<p>Additionally, we will keep the columns <code>wards, historical_wards,
census_tracts</code> and <code>community_areas</code>.</p>
<p>Each inspection can have multiple violations. To handle that as simply
as possible, we'll put violations in their own table.</p>
<div class="admonition info">
<p class="admonition-title">Decisions regarding data</p>
<p>We will inspections that occurred <em>before</em>  <code>2018-07-01</code>. This is
due the changes in the types and definition of the violations. See
<a href="https://www.cityofchicago.org/content/dam/city/depts/cdph/FoodProtection/ChicagoFoodCodeMajorChangesFinal2018.pdf">here</a></p>
</div>
<p>Finally, we will improve the names of the columns (e.g. <code>results -&gt;
result, dba_name -&gt; facility</code>, etc).</p>
<p>We will create a new <code>schema</code> called <code>cleaned</code>. The objective of this
schema is twofold: to keep our raw data <em>as is</em><sup id="fnref:11"><a class="footnote-ref" href="#fn:11">11</a></sup> and to store our
assumptions and cleaning decisions separate from the <em>raw</em> data in a
schema that <em>semantically</em> transmits that "this is our cleaned data."</p>
<p>The <code>cleaned</code> schema will contain two tables: <code>cleaned.inspections</code> and <code>cleaned.violations</code>.</p>
<div class="highlight"><pre><span></span>  <span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">;</span>
</pre></div>

<p>Then, we will create our mini <strong>ETL</strong> with our cleaning decisions:</p>
<div class="admonition note">
<p class="admonition-title">Data changes</p>
<p>At least from May 2019 the dataset contains news columns:
<code>zip_codes, historical_wards, wards, community_areas</code> and <code>census_tracts</code>. The most
recent code reflects those changes.</p>
</div>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">;</span>

<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">with</span> <span class="n">cleaned</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span>
            <span class="n">inspection</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
            <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">results</span><span class="p">))</span> <span class="k">as</span> <span class="k">result</span><span class="p">,</span>
            <span class="n">license_num</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
            <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">dba_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">facility</span><span class="p">,</span>
            <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">aka_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">facility_aka</span><span class="p">,</span>
            <span class="k">case</span> <span class="k">when</span>
            <span class="n">facility_type</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="k">else</span> <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">facility_type</span><span class="p">))</span>
            <span class="k">end</span> <span class="k">as</span> <span class="n">facility_type</span><span class="p">,</span>
            <span class="k">lower</span><span class="p">(</span><span class="k">substring</span><span class="p">(</span><span class="n">risk</span> <span class="k">from</span> <span class="s1">&#39;\((.+)\)&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">risk</span><span class="p">,</span>
            <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">address</span><span class="p">))</span> <span class="k">as</span> <span class="n">address</span><span class="p">,</span>
            <span class="n">zip</span> <span class="k">as</span> <span class="n">zip_code</span><span class="p">,</span>
            <span class="n">community_areas</span> <span class="k">as</span> <span class="n">community_area</span><span class="p">,</span>
            <span class="n">census_tracts</span> <span class="k">as</span> <span class="n">census_tracts</span><span class="p">,</span>
            <span class="n">historical_wards</span> <span class="k">as</span> <span class="n">historical_ward</span><span class="p">,</span>
            <span class="n">wards</span> <span class="k">as</span> <span class="n">ward</span><span class="p">,</span>
            <span class="k">substring</span><span class="p">(</span>
                <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="k">type</span><span class="p">,</span> <span class="s1">&#39;liquor&#39;</span><span class="p">,</span> <span class="s1">&#39;task force&#39;</span><span class="p">,</span> <span class="s1">&#39;gi&#39;</span><span class="p">)))</span>
            <span class="k">from</span> <span class="s1">&#39;canvass|task force|complaint|food poisoning|consultation|license|tag removal&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">type</span><span class="p">,</span>
            <span class="nb">date</span><span class="p">,</span>
            <span class="c1">-- point(longitude, latitude) as location</span>
            <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">),</span> <span class="mi">4326</span><span class="p">)::</span><span class="n">geography</span> <span class="k">as</span> <span class="k">location</span>  <span class="c1">-- We use geography so the measurements are in meters</span>
        <span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
        <span class="k">where</span> <span class="n">zip</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>  <span class="c1">-- removing NULL zip codes</span>
        <span class="k">and</span> <span class="nb">date</span> <span class="o">&lt;</span> <span class="s1">&#39;2018-07-01&#39;</span>
            <span class="p">)</span>

    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">cleaned</span> <span class="k">where</span> <span class="k">type</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
        <span class="p">);</span>
</pre></div>

<p>The number of inspections now is:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">inspection</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of</span>
<span class="ss">    inspections (until 07/01/2018)&quot;</span>
<span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>number of inspections (until 07/01/2018)</th>
</tr>
</thead>
<tbody>
<tr>
<td>172,052</td>
</tr>
</tbody>
</table>
<p>Note that quantity is smaller than the one from <code>raw.inspections</code>,
since we throw away some inspections.</p>
<p>With the <code>cleaned.inspections</code> table created, let's take a closer look
at the <code>violations</code> column to figure out how to clean it.</p>
<p>The first thing to note is that the column <code>violation</code> has a lot of
information: it describes the code violation, what's required to
address it (see <a href="#dataset-documentation">Dataset documentation</a>), and
the inspector's comments. The comments are free text, which means that
they can contain line breaks, mispellings, etc. In particular, note
that pipes (<code>|</code>) seperate multiple violations.</p>
<p>The following <code>sql</code> code removes line breaks and multiple spaces and creates an array with all the violations for inspection number <code>2145736</code>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="s1">&#39;[\n\r]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span> <span class="p">),</span> <span class="s1">&#39;|&#39;</span><span class="p">))</span>  <span class="k">as</span> <span class="n">violations_array</span>
<span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">where</span>
    <span class="n">inspection</span> <span class="o">=</span> <span class="s1">&#39;2145736&#39;</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>violations<sub>array</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td>32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: FIRST FLOOR GIRL'S WASHROOM,MIDDLE WASHBOWL SINK FAUCET NOT IN GOOD REPAIR, MUST REPAIR AND MAINTAIN.   ONE OUT OF TWO HAND DRYER NOT WORKING IN THE FOLLOWING WASHROOM: FIRST FLOOR  BOY'S AND GIRL'S WASHROOM, AND  BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR AND MAINTAIN.</td>
</tr>
<tr>
<td>34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: DAMAGED FLOOR INSIDE THE BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR, MAKE THE FLOOR SMOOTH EASILY CLEANABLE.</td>
</tr>
<tr>
<td>35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: MISSING PART OF THE COVING(BASEBOARD) BY THE EXPOSED HAND SINK IN THE KITCHEN. MUST REPAIR AND MAINTAIN.   WATER STAINED CEILING TILES IN THE LUNCH ROOM. MUST REPLACE CEILING TILES AND MAINTAIN.  PEELING PAINT ON THE CEILING AND WALLS THROUGHOUT THE SCHOOL. HALLWAYS, INSIDE THE CLASSROOMS, INSIDE THE WASHROOMS IN ALL FLOORS. INSTRUCTED TO SCRAPE PEELING PAINT AND RE PAINT.</td>
</tr>
</tbody>
</table>
<p>This little piece of code is doing a lot: first it replaces all the line breaks <code>[\n\r]+</code> with spaces, then, it splits the string using the pipe and stores it in an array (<code>string_to_array</code>), finally it returns every violation description in a row (<code>unnest</code>).</p>
<p>From this, we can learn that the structure of the <code>violations</code> column follows:</p>
<ul>
<li>If there are several violations reported, those violations will be separated by <code>'|'</code></li>
<li>Every violation begins with a code and a description</li>
<li>Every violation can have <strong>comments</strong>, which appear after the string <code>- Comments:</code></li>
</ul>
<p>We will create a new table called <code>cleaned.violations</code> to store</p>
<ul>
<li>inspection</li>
<li>code</li>
<li>description</li>
<li>comments</li>
</ul>
<div class="highlight"><pre><span></span>   <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">cascade</span><span class="p">;</span>

   <span class="k">create</span> <span class="k">table</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="p">(</span>
   <span class="k">select</span>
       <span class="n">inspection</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
       <span class="n">license_num</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
       <span class="nb">date</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
       <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">as</span> <span class="n">code</span><span class="p">,</span>
       <span class="k">lower</span><span class="p">(</span><span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="k">as</span> <span class="n">description</span><span class="p">,</span>
       <span class="k">lower</span><span class="p">(</span><span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="k">as</span> <span class="k">comment</span><span class="p">,</span>
       <span class="p">(</span><span class="k">case</span>
           <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">then</span> <span class="k">NULL</span>
           <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])::</span><span class="nb">int</span> <span class="k">between</span> <span class="mi">1</span> <span class="k">and</span> <span class="mi">14</span> <span class="k">then</span> <span class="s1">&#39;critical&#39;</span> <span class="c1">-- From the documentation</span>
           <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])::</span><span class="nb">int</span> <span class="k">between</span> <span class="mi">15</span> <span class="k">and</span> <span class="mi">29</span>  <span class="k">then</span> <span class="s1">&#39;serious&#39;</span>
           <span class="k">else</span> <span class="s1">&#39;minor&#39;</span>
           <span class="k">end</span>
           <span class="p">)</span> <span class="k">as</span> <span class="n">severity</span> <span class="k">from</span>
       <span class="p">(</span>
       <span class="k">select</span>
           <span class="n">inspection</span><span class="p">,</span>
           <span class="n">license_num</span><span class="p">,</span>
           <span class="nb">date</span><span class="p">,</span>
           <span class="n">regexp_split_to_array</span><span class="p">(</span>   <span class="c1">-- Create an array we will split the code, description, comment</span>
               <span class="n">regexp_split_to_table</span><span class="p">(</span> <span class="c1">-- Create a row per each comment we split by |</span>
                   <span class="n">coalesce</span><span class="p">(</span>            <span class="c1">-- If there isn&#39;t a violation add &#39;- Comments:&#39;</span>
                       <span class="n">regexp_replace</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="s1">&#39;[\n\r]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span> <span class="p">)</span>  <span class="c1">-- Remove line breaks</span>
                       <span class="p">,</span> <span class="s1">&#39;- Comments:&#39;</span><span class="p">)</span>
                   <span class="p">,</span> <span class="s1">&#39;\|&#39;</span><span class="p">)</span>  <span class="c1">-- Split the violations</span>
               <span class="p">,</span> <span class="s1">&#39;(?&lt;=\d+)\.\s*|\s*-\s*Comments:&#39;</span><span class="p">)</span>  <span class="c1">-- Split each violation in three</span>
            <span class="c1">-- , &#39;\.\s*|\s*-\s*Comments:&#39;)  -- Split each violation in three (Use this if your postgresql is kind off old</span>
           <span class="k">as</span> <span class="n">tuple</span>
       <span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
       <span class="k">where</span> <span class="n">results</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;Fail&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass w/ Conditions&#39;</span><span class="p">)</span> <span class="k">and</span> <span class="n">license_num</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
           <span class="p">)</span> <span class="k">as</span> <span class="n">t</span>
       <span class="p">);</span>
</pre></div>

<p>This code is in <code>/sql/create_violations_table.sql</code>.</p>
<p>We can verify the result of the previous script</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">inspection</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">description</span>
<span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span>
<span class="k">where</span>
    <span class="n">inspection</span> <span class="o">=</span> <span class="mi">2145736</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">code</span> <span class="k">asc</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>inspection</th>
<th>date</th>
<th>code</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>2145736</td>
<td>2018-03-01</td>
<td>32</td>
<td>food and non-food contact surfaces properly designed, constructed and maintained</td>
</tr>
<tr>
<td>2145736</td>
<td>2018-03-01</td>
<td>34</td>
<td>floors: constructed per code, cleaned, good repair, coving installed, dust-less cleaning methods used</td>
</tr>
<tr>
<td>2145736</td>
<td>2018-03-01</td>
<td>35</td>
<td>walls, ceilings, attached equipment constructed per code: good repair, surfaces clean and dust-less cleaning methods</td>
</tr>
</tbody>
</table>
<p>If everything worked correctly you should be able to run the following
code<sup id="fnref:12"><a class="footnote-ref" href="#fn:12">12</a></sup>:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">case</span>
    <span class="k">when</span>
    <span class="k">grouping</span><span class="p">(</span><span class="n">severity</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="s1">&#39;TOTAL&#39;</span>
    <span class="k">else</span>
    <span class="n">severity</span>
    <span class="k">end</span> <span class="k">as</span> <span class="n">severity</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="k">rollup</span> <span class="p">(</span><span class="n">severity</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">severity</span> <span class="n">nulls</span> <span class="k">first</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>severity</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>¤</td>
<td>26,415</td>
</tr>
<tr>
<td>critical</td>
<td>51,486</td>
</tr>
<tr>
<td>minor</td>
<td>478,340</td>
</tr>
<tr>
<td>serious</td>
<td>55,583</td>
</tr>
<tr>
<td>TOTAL</td>
<td>611,824</td>
</tr>
</tbody>
</table>
<p>As a last step, we should create from the cleaned tables the <code>entities</code> and <code>events</code> tables.</p>
<h2 id="semantic-tables">Semantic tables<a class="headerlink" href="#semantic-tables" title="Permanent link">#</a></h2>
<h3 id="entities-table">Entities table<a class="headerlink" href="#entities-table" title="Permanent link">#</a></h3>
<p>The <code>entities</code> table should uniquely identify each facility and
contain descriptive attributes. First, we should investigate how we
can uniquely identify a facility. Let's hope it's easy<sup id="fnref:13"><a class="footnote-ref" href="#fn:13">13</a></sup>.</p>
<p>Let's start with the obvious option. Perhaps <code>license_num</code> is a unique
identifier. Let's confirm our hypothesis with some queries.</p>
<p>We will begin with the following query: <em>What are 5 licenses with the
most inspections?</em></p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">license_num</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span><span class="p">,</span>
    <span class="n">coalesce</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">as</span> <span class="ss">&quot;number of failed inspections&quot;</span>
<span class="k">from</span>
    <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">license_num</span>
<span class="k">order</span> <span class="k">by</span>
     <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span>
    <span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>license<sub>num</sub></th>
<th>number of inspections</th>
<th>number of failed inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>442</td>
<td>111</td>
</tr>
<tr>
<td>1354323</td>
<td>192</td>
<td>1</td>
</tr>
<tr>
<td>14616</td>
<td>174</td>
<td>31</td>
</tr>
<tr>
<td>1574001</td>
<td>82</td>
<td>4</td>
</tr>
<tr>
<td>1974745</td>
<td>59</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>This looks weird. There are three license numbers, in particular
license number <code>0</code>, that have many more inspections than the
rest. Let's investigate <code>license_num</code> = <code>0</code>.</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">facility_type</span><span class="p">,</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span><span class="p">,</span>
      <span class="n">coalesce</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of failed inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">where</span>
      <span class="n">license_num</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">facility_type</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="ss">&quot;number of inspections&quot;</span> <span class="k">desc</span>
  <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>facility<sub>type</sub></th>
<th>number of inspections</th>
<th>number of failed inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>restaurant</td>
<td>103</td>
<td>43</td>
</tr>
<tr>
<td>special event</td>
<td>70</td>
<td>8</td>
</tr>
<tr>
<td>unknown</td>
<td>44</td>
<td>10</td>
</tr>
<tr>
<td>shelter</td>
<td>31</td>
<td>6</td>
</tr>
<tr>
<td>navy pier kiosk</td>
<td>30</td>
<td>4</td>
</tr>
<tr>
<td>church</td>
<td>30</td>
<td>3</td>
</tr>
<tr>
<td>grocery store</td>
<td>16</td>
<td>7</td>
</tr>
<tr>
<td>school</td>
<td>13</td>
<td>1</td>
</tr>
<tr>
<td>long term care</td>
<td>11</td>
<td>2</td>
</tr>
<tr>
<td>church kitchen</td>
<td>11</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>It seems that <code>license_number</code> <code>0</code> is a generic placeholder: Most of
these are related to <em>special events</em>, <em>churches</em>, <em>festivals</em>,
etc. But what about the <code>restaurants</code> that have <code>license_num</code> = <code>0</code>?
Are those the same restaurant?</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
      <span class="n">license_num</span><span class="p">,</span>
      <span class="n">facility</span><span class="p">,</span>
      <span class="n">address</span><span class="p">,</span>
      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span><span class="p">,</span>
      <span class="n">coalesce</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">as</span> <span class="ss">&quot;number of failed inspections&quot;</span>
  <span class="k">from</span>
      <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
  <span class="k">where</span>
      <span class="n">license_num</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">and</span>
      <span class="n">facility_type</span> <span class="o">=</span> <span class="s1">&#39;restaurant&#39;</span>
  <span class="k">group</span> <span class="k">by</span>
      <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">address</span>
  <span class="k">order</span> <span class="k">by</span>
      <span class="ss">&quot;number of inspections&quot;</span> <span class="k">desc</span>
  <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>license<sub>num</sub></th>
<th>facility</th>
<th>address</th>
<th>number of inspections</th>
<th>number of failed inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>british airways</td>
<td>11601 w touhy ave</td>
<td>5</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>rib lady 2</td>
<td>4203 w cermak rd</td>
<td>4</td>
<td>3</td>
</tr>
<tr>
<td>0</td>
<td>taqueria la capital</td>
<td>3508 w 63<sup>rd</sup> st</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>nutricion familiar</td>
<td>3000 w 59<sup>th</sup> st</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>salvation army</td>
<td>506 n des plaines st</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>herbalife</td>
<td>6214 w diversey ave</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>0</td>
<td>la michoacana</td>
<td>4346 s california ave</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>las quecas</td>
<td>2500 s christiana ave</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>mrs ts southern fried chicken</td>
<td>3343 n broadway</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>unlicensed</td>
<td>7559 n ridge blvd</td>
<td>3</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Nope. Unfortunately, <code>license_num</code> is not a unique identifier.</p>
<p>Perhaps <code>license_num</code> and <code>address</code> are a unique identifier.</p>
<div class="highlight"><pre><span></span>  <span class="k">select</span>
  <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">license_num</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of licenses&quot;</span><span class="p">,</span>
  <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">facility</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of facilities&quot;</span><span class="p">,</span>
  <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">address</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of addresses&quot;</span>
  <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>number of licenses</th>
<th>number of facilities</th>
<th>number of addresses</th>
</tr>
</thead>
<tbody>
<tr>
<td>34,364</td>
<td>25,371</td>
<td>17,252</td>
</tr>
</tbody>
</table>
<p>We were expecting (naively) that we should get one <code>license_num</code> per
<code>facility</code> per <code>address</code>, but that isn't the case. Perhaps several
facilities share a name (e.g. "Subway" or "McDonalds") or license, or
perhaps several facilities share the same address, such as facilities
at the stadium or the airport.</p>
<p>We will try to use the combination of <code>license_num</code>, <code>facility</code>,
<code>facility_aka</code>, <code>facility_type</code>, and <code>address</code> to identify a facility:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span> <span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;number of inspections&quot;</span>
<span class="k">from</span>
    <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">desc</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility_type</span>
<span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>license_num</th>
<th>facility</th>
<th>facility_type</th>
<th>facility_aka</th>
<th>address</th>
<th>number of inspections</th>
</tr>
</thead>
<tbody>
<tr>
<td>1490035</td>
<td>mcdonald's</td>
<td>restaurant</td>
<td>mcdonald's</td>
<td>6900 s lafayette ave</td>
<td>46</td>
</tr>
<tr>
<td>1142451</td>
<td>jewel food  store # 3345</td>
<td>grocery store</td>
<td>jewel food  store # 3345</td>
<td>1224 s wabash ave</td>
<td>45</td>
</tr>
<tr>
<td>1596210</td>
<td>food 4 less midwest #552</td>
<td>grocery store</td>
<td>food 4 less</td>
<td>7030 s ashland ave</td>
<td>44</td>
</tr>
<tr>
<td>2083833</td>
<td>mariano's fresh market #8503</td>
<td>grocery store</td>
<td>mariano's fresh market</td>
<td>333 e benton pl</td>
<td>41</td>
</tr>
<tr>
<td>1302136</td>
<td>mcdonald's</td>
<td>restaurant</td>
<td>mcdonald's</td>
<td>70 e garfield blvd</td>
<td>40</td>
</tr>
<tr>
<td>1476553</td>
<td>pete's produce</td>
<td>grocery store</td>
<td>pete's produce</td>
<td>1543 e 87<sup>th</sup> st</td>
<td>40</td>
</tr>
<tr>
<td>1000572</td>
<td>jewel food store #3030</td>
<td>grocery store</td>
<td>jewel food store #3030</td>
<td>7530 s stony island ave</td>
<td>39</td>
</tr>
<tr>
<td>1094</td>
<td>one stop food &amp; liquor store</td>
<td>grocery store</td>
<td>one stop food &amp; liquor store</td>
<td>4301-4323 s lake park ave</td>
<td>39</td>
</tr>
<tr>
<td>60184</td>
<td>taqueria el ranchito</td>
<td>restaurant</td>
<td>taqueria el ranchito</td>
<td>2829 n milwaukee ave</td>
<td>39</td>
</tr>
<tr>
<td>9154</td>
<td>jimmy g's</td>
<td>restaurant</td>
<td>jimmy g's</td>
<td>307 s kedzie ave</td>
<td>37</td>
</tr>
</tbody>
</table>
<p>Yay, it looks like these columns enable us to identify a facility!<sup id="fnref:14"><a class="footnote-ref" href="#fn:14">14</a></sup></p>
<p>The <code>entities</code> table should store two other types of attributes. The
first type describe the entity no matter the time. If the entity were
a person, date of birth would be an example but age would not because
the latter changes but the former does not. We'll include <code>zip_code</code>
and <code>location</code> as two facility attributes.</p>
<p>The second type describes when the entity is available for action
(e.g. inspection). In this case, the columns <code>start_time, end_time</code>
describe the interval in which the facility is in business or
<em>active</em>. These columns are important because we don't want to make
predictions for inactive entities.</p>
<p>The data don't contain active/inactive date columns, so we will use
the date of the facility's first inspection as <code>start_time</code>, and
either <code>NULL</code> or the date of inspection if the result was <code>out of
business</code> or <code>business not located</code> as <code>end_time</code>.</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">;</span>

<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">with</span> <span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span>
            <span class="k">distinct</span> <span class="k">on</span> <span class="p">(</span>
                <span class="n">license_num</span><span class="p">,</span>
                <span class="n">facility</span><span class="p">,</span>
                <span class="n">facility_aka</span><span class="p">,</span>
                <span class="n">facility_type</span><span class="p">,</span>
                <span class="n">address</span>
                <span class="p">)</span>
            <span class="n">license_num</span><span class="p">,</span>
            <span class="n">facility</span><span class="p">,</span>
            <span class="n">facility_aka</span><span class="p">,</span>
            <span class="n">facility_type</span><span class="p">,</span>
            <span class="n">address</span><span class="p">,</span>
            <span class="n">zip_code</span><span class="p">,</span>
            <span class="k">location</span><span class="p">,</span>
            <span class="k">min</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">start_time</span><span class="p">,</span>
            <span class="k">max</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="k">result</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;out of business&#39;</span><span class="p">,</span> <span class="s1">&#39;business not located&#39;</span><span class="p">)</span>
                <span class="k">then</span> <span class="nb">date</span>
                <span class="k">else</span> <span class="k">NULL</span>
                <span class="k">end</span><span class="p">)</span>
            <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">end_time</span>
        <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>
        <span class="k">order</span> <span class="k">by</span>
            <span class="n">license_num</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_aka</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_type</span> <span class="k">asc</span><span class="p">,</span> <span class="n">address</span> <span class="k">asc</span><span class="p">,</span>
            <span class="nb">date</span> <span class="k">asc</span> <span class="c1">-- IMPORTANT!!</span>
            <span class="p">)</span>

    <span class="k">select</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">start_time</span> <span class="k">asc</span><span class="p">,</span> <span class="n">license_num</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_aka</span> <span class="k">asc</span><span class="p">,</span> <span class="n">facility_type</span> <span class="k">asc</span><span class="p">,</span> <span class="n">address</span> <span class="k">asc</span> <span class="p">)</span> <span class="k">as</span> <span class="n">entity_id</span><span class="p">,</span>
        <span class="n">license_num</span><span class="p">,</span>
        <span class="n">facility</span><span class="p">,</span>
        <span class="n">facility_aka</span><span class="p">,</span>
        <span class="n">facility_type</span><span class="p">,</span>
        <span class="n">address</span><span class="p">,</span>
        <span class="n">zip_code</span><span class="p">,</span>
        <span class="k">location</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">,</span>
        <span class="n">end_time</span><span class="p">,</span>
        <span class="n">daterange</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">activity_period</span>
    <span class="k">from</span> <span class="n">entities</span>
        <span class="p">);</span>
</pre></div>

<p>Note that we added a <em>unique</em> identifier (<code>entity_id</code>) to this
table. This identifier was assigned using a PostgreSQL idiom:
<code>distinct on()</code>. <code>DISTINCT ON</code> keeps the "first" row of each group. If
you are interested in this powerful technique see this
<a href="http://www.postgresqltutorial.com/postgresql-select-distinct/">blogpost</a>.</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">entity_id</span><span class="p">),</span> <span class="s1">&#39;999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">entities</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>entities</th>
</tr>
</thead>
<tbody>
<tr>
<td>35,668</td>
</tr>
</tbody>
</table>
<p>We will add some indexes to this table<sup id="fnref:15"><a class="footnote-ref" href="#fn:15">15</a></sup>:</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">index</span> <span class="n">entities_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">entity_id</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_license_num_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">license_num</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_facility_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">facility</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_facility_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">facility_type</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_zip_code_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">zip_code</span><span class="p">);</span>

<span class="c1">-- Spatial index</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">entities_location_gix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">using</span> <span class="n">gist</span> <span class="p">(</span><span class="k">location</span><span class="p">);</span>

<span class="k">create</span> <span class="k">index</span> <span class="n">entities_full_key_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</pre></div>

<h3 id="events-table">Events table<a class="headerlink" href="#events-table" title="Permanent link">#</a></h3>
<p>We are ready to create the events table. This table will describe the
inspection, like the <em>type</em> of inspection, <em>when</em> and <em>where</em> the
inspection happened, and the inspection <em>result</em>. We will add the
violations as a <code>JSONB</code> column<sup id="fnref:16"><a class="footnote-ref" href="#fn:16">16</a></sup>. Finally, we'll rename
<code>inspection</code> as <code>event_id</code><sup id="fnref:17"><a class="footnote-ref" href="#fn:17">17</a></sup>.</p>
<div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">as</span> <span class="p">(</span>

        <span class="k">with</span> <span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span>
            <span class="p">),</span>

        <span class="n">inspections</span> <span class="k">as</span> <span class="p">(</span>
        <span class="k">select</span>
            <span class="n">i</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_aka</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
            <span class="n">jsonb_agg</span><span class="p">(</span>
                <span class="n">jsonb_build_object</span><span class="p">(</span>
                    <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">severity</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="k">comment</span>
                <span class="p">)</span>
            <span class="k">order</span>  <span class="k">by</span> <span class="n">code</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
        <span class="k">from</span>
            <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">as</span> <span class="n">i</span>
            <span class="k">inner</span> <span class="k">join</span>
            <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="n">v</span>
            <span class="k">on</span> <span class="n">i</span><span class="p">.</span><span class="n">inspection</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">inspection</span>
        <span class="k">group</span> <span class="k">by</span>
            <span class="n">i</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="n">facility_aka</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
            <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span>
            <span class="p">)</span>

    <span class="k">select</span>
        <span class="n">i</span><span class="p">.</span><span class="n">inspection</span> <span class="k">as</span> <span class="n">event_id</span><span class="p">,</span>
        <span class="n">e</span><span class="p">.</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span><span class="p">,</span>
        <span class="n">e</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
        <span class="n">i</span><span class="p">.</span><span class="n">violations</span>
    <span class="k">from</span>
        <span class="n">entities</span> <span class="k">as</span> <span class="n">e</span>
        <span class="k">inner</span> <span class="k">join</span>
        <span class="n">inspections</span> <span class="k">as</span> <span class="n">i</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">zip_code</span><span class="p">)</span>
        <span class="p">);</span>

<span class="c1">-- Add some indices</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_entity_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">entity_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_event_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">event_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="k">type</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_date_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span><span class="p">(</span><span class="nb">date</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_facility_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>  <span class="p">(</span><span class="n">facility_type</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_zip_code_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>  <span class="p">(</span><span class="n">zip_code</span><span class="p">);</span>

<span class="c1">-- Spatial index</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_location_gix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gist</span> <span class="p">(</span><span class="k">location</span><span class="p">);</span>

<span class="c1">-- JSONB indices</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_violations</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gin</span><span class="p">(</span><span class="n">violations</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">events_violations_json_path</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gin</span><span class="p">(</span><span class="n">violations</span> <span class="n">jsonb_path_ops</span><span class="p">);</span>

<span class="k">create</span> <span class="k">index</span> <span class="n">events_event_entity_zip_code_date</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">event_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">,</span> <span class="n">entity_id</span> <span class="k">asc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">,</span> <span class="n">zip_code</span><span class="p">,</span> <span class="nb">date</span> <span class="k">desc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
</pre></div>

<p>Success! We have one row per event<sup id="fnref:18"><a class="footnote-ref" href="#fn:18">18</a></sup> Our semantic data looks like:</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">event_id</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="k">type</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">risk</span><span class="p">,</span>
    <span class="k">result</span><span class="p">,</span>
    <span class="n">facility_type</span><span class="p">,</span>
    <span class="n">zip_code</span>
<span class="k">from</span>
    <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>event_id</th>
<th>entity_id</th>
<th>type</th>
<th>date</th>
<th>risk</th>
<th>result</th>
<th>facility_type</th>
<th>zip_code</th>
</tr>
</thead>
<tbody>
<tr>
<td>1343315</td>
<td>22054</td>
<td>canvass</td>
<td>2013-06-06</td>
<td>low</td>
<td>fail</td>
<td>newsstand</td>
<td>60623</td>
</tr>
</tbody>
</table>
<p>We omitted <code>violations</code> and <code>location</code> for brevity. The total number of inspections is</p>
<div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">to_char</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">event_id</span><span class="p">),</span> <span class="s1">&#39;999,999,999&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">events</span>
<span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span><span class="p">;</span>
</pre></div>

<table>
<thead>
<tr>
<th>events</th>
</tr>
</thead>
<tbody>
<tr>
<td>148,724</td>
</tr>
</tbody>
</table>
<p>Now that we have our data in a good shape, we are ready to use <strong>Triage</strong>.</p>
<h2 id="lets-eda">Let's EDA &#x2026;<a class="headerlink" href="#lets-eda" title="Permanent link">#</a></h2>
<p>It is always a good idea to do some <em>Exploratory Data Analysis</em><sup id="fnref:19"><a class="footnote-ref" href="#fn:19">19</a></sup>
or <strong>EDA</strong> for short. This will help us to learn more about the
dynamics of the entities or the inspections.</p>
<p>We will generate a few plots, just to know:</p>
<ul>
<li>how many entities/events are every month?</li>
<li>how many entities/events ended in a failed state every month? and,</li>
<li>how many entities/events have in a critical violation in a failed inspection?</li>
</ul>
<h3 id="inspections-over-time">Inspections over time<a class="headerlink" href="#inspections-over-time" title="Permanent link">#</a></h3>
<p>First, we will try the answer the question: <em>how many inspections are realized every month?</em></p>
<p><img alt="img" src="../images/EDA/inspections_over_time.png" title="Number of inspections per month across our whole dataset" /></p>
<h3 id="number-of-facilities-inspected-over-time">Number of facilities <em>inspected</em> over time<a class="headerlink" href="#number-of-facilities-inspected-over-time" title="Permanent link">#</a></h3>
<p>The previous plot was about the number of <em>events</em> every month, now we will plot how many <em>entities</em> are acted every month.</p>
<p>One question, that is useful to answer is: Are there facilities that are inspected more than once in a month?</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are doing an emphasis in <em>inspected</em> since our data set doesn't
contain <strong>all</strong> the facilities in Chicago. This will have an effect
on the modeling stage.</p>
</div>
<p><img alt="img" src="../images/EDA/facilities_inspected_over_time.png" title="Number of unique facilities inspected every month." /></p>
<h3 id="number-of-failed-inspections-over-time">Number of failed inspections over time<a class="headerlink" href="#number-of-failed-inspections-over-time" title="Permanent link">#</a></h3>
<p>What is the proportion of inspections every month that actually end in a failed inspection?</p>
<p><img alt="img" src="../images/EDA/failed_inspections_over_time.png" title="Number of failed inspections every month." /></p>
<h3 id="number-of-facilities-with-failed-inspections-over-time">Number of facilities with failed inspections over time<a class="headerlink" href="#number-of-facilities-with-failed-inspections-over-time" title="Permanent link">#</a></h3>
<p>Now let's see the behavior of the <em>outcomes</em> of the inspection across
time. First just if the inspection failed.</p>
<p><img alt="img" src="../images/EDA/facilities_with_inspections_failed_over_time.png" title="Number of unique facilities with failed inspections every month." /></p>
<h3 id="number-of-severe-violations-found-in-a-failed-inspection-over-time">Number of severe violations found in a failed inspection over time<a class="headerlink" href="#number-of-severe-violations-found-in-a-failed-inspection-over-time" title="Permanent link">#</a></h3>
<p>Finally let's analyze the evolution of failed inspections with severe
violations (violation code in 15-29)</p>
<p><img alt="img" src="../images/EDA/failed_inspections_severe_violations_over_time.png" title="Number of failed inspection with critical violation found" /></p>
<h3 id="number-of-facilities-with-severe-violations-found-in-a-failed-inspection-over-time">Number of facilities with severe violations found in a failed inspection over time<a class="headerlink" href="#number-of-facilities-with-severe-violations-found-in-a-failed-inspection-over-time" title="Permanent link">#</a></h3>
<p><img alt="img" src="../images/EDA/facilities_with_failed_inspections_severe_violations_over_time.png" title="Number of facilities which failed inspections with severe violations." /></p>
<p>This few plots give us a sense of how the data behaves and will help
us in detect weird bugs or model-behavior later.</p>
<h2 id="whats-next">What’s next?<a class="headerlink" href="#whats-next" title="Permanent link">#</a></h2>
<ul>
<li>Learn more about <a href="../triage_intro/">triage</a></li>
<li>Learn more about <a href="../eis/">early warning systems</a></li>
<li>Learn more about <a href="../inspections/">resource prioritization systems</a></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>If you want to try different columns (or you don't remember
which columns try <code>\d raw.inspectios</code> first&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>We are following the <a href="https://en.wikipedia.org/wiki/Event_(relativity)">event's definition from
physics</a>: "an
event is the instantaneous physical situation or occurrence
associated with a point in spacetime"&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>It will make your life easier and most of the Machine Learning
algorithms only accept data in matrix form (i.e. one big table)&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Verbatim from the datasource documentation.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>A controversial decision, I know.&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>This problem is related to the process of <em>deduplication</em> and there is
another DSaPP tool for that:
<a href="https://dssg.github.io/matching-tool/">matching-tool</a>.&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>It is the <em>Chicago</em> Food Inspections dataset, after all.&#160;<a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:8">
<p>We could also use the default geometric data type from postgresql:
<code>point</code>
(<a href="https://www.postgresql.org/docs/10/datatype-geometric.html">https://www.postgresql.org/docs/10/datatype-geometric.html</a>)&#160;<a class="footnote-backref" href="#fnref:8" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:9">
<p>We will store the <code>Point</code> as a <code>geography</code> object. As a result,
spatial database operations (like calculating the distances
between two facilities) will return answers in meters instead of
degrees. See
<a href="http://workshops.boundlessgeo.com/postgis-intro/geography.html">this</a>.&#160;<a class="footnote-backref" href="#fnref:9" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:10">
<p>As a real geographical object <a href="https://postgis.net/docs/ST_MakePoint.html">check the PostGIS
documentation</a>&#160;<a class="footnote-backref" href="#fnref:10" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:11">
<p>Remember our tip at the beginning of this section!&#160;<a class="footnote-backref" href="#fnref:11" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
<li id="fn:12">
<p>If the code looks funny to you, it is because we are using
<a href="https://www.postgresql.org/docs/devel/queries-table-expressions.html#QUERIES-GROUPING-SETS">grouping
sets</a>,
in particular <code>rollup</code>. See the docs.&#160;<a class="footnote-backref" href="#fnref:12" title="Jump back to footnote 12 in the text">&#8617;</a></p>
</li>
<li id="fn:13">
<p>Yeah, you wish&#160;<a class="footnote-backref" href="#fnref:13" title="Jump back to footnote 13 in the text">&#8617;</a></p>
</li>
<li id="fn:14">
<p>Almost. At least good for this tutorial. Look carefully.&#160;<a class="footnote-backref" href="#fnref:14" title="Jump back to footnote 14 in the text">&#8617;</a></p>
</li>
<li id="fn:15">
<p><strong>ALWAYS</strong> add indexes to your tables!&#160;<a class="footnote-backref" href="#fnref:15" title="Jump back to footnote 15 in the text">&#8617;</a></p>
</li>
<li id="fn:16">
<p>If you want to have a deep explanation about why is this good
check <a href="http://coussej.github.io/2016/01/14/Replacing-EAV-with-JSONB-in-PostgreSQL/">this blog
post</a>&#160;<a class="footnote-backref" href="#fnref:16" title="Jump back to footnote 16 in the text">&#8617;</a></p>
</li>
<li id="fn:17">
<p>As a general rule I hate to add the suffix <code>_id</code>, I would rather
prefer to name them as <code>event</code> and <code>entity</code> instead of <code>event_id</code>
and <code>entity_id</code>. But <code>triage</code> named those columns in that way and
for that we are stuck with that nomenclature.&#160;<a class="footnote-backref" href="#fnref:17" title="Jump back to footnote 17 in the text">&#8617;</a></p>
</li>
<li id="fn:18">
<p>This will simplify the creation of <em>features</em> for our machine
learning models.&#160;<a class="footnote-backref" href="#fnref:18" title="Jump back to footnote 18 in the text">&#8617;</a></p>
</li>
<li id="fn:19">
<p><a href="https://en.wikipedia.org/wiki/Exploratory_data_analysis">Defined</a>
by John Tukey as: <em>Procedures for analyzing data, techniques for
interpreting the results of such procedures, ways of planning the
gathering of data to make its analysis easier, more precise or
more accurate, and all the machinery and results of (mathematical)
statistics which apply to analyzing data.</em>&#160;<a class="footnote-backref" href="#fnref:19" title="Jump back to footnote 19 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../infrastructure/" title="Infrastructure" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Infrastructure
              </span>
            </div>
          </a>
        
        
          <a href="../for_the_impatient/" title="Quick setup" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Quick setup
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/dssg/triage" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/datascifellows" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/center-for-data-science-and-public-policy-university-of-chicago" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.39abc4af.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../js/mermaid.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>