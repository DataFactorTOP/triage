



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for Triage.">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.2">
    
    
      
        <title>Scaling up - Triage Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Triage Documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon">book</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Triage Documentation
            </span>
            <span class="md-header-nav__topic">
              Scaling up
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="http://github.com/dssg/triage" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Triage Documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">book</i>
      
    </a>
    Triage Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="http://github.com/dssg/triage" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Dirty Duck Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Dirty Duck Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../choose_your_own_adventure/" title="Choose your own adventure" class="md-nav__link">
      Choose your own adventure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../for_the_impatient/" title="For the impatient" class="md-nav__link">
      For the impatient
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../infrastructure/" title="Infrastructure" class="md-nav__link">
      Infrastructure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data_preparation/" title="Data preparation" class="md-nav__link">
      Data preparation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Case studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        Case studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../intro/" title="Problem description" class="md-nav__link">
      Problem description
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../inspections/" title="Resource prioritization" class="md-nav__link">
      Resource prioritization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../eis/" title="Early Warning System" class="md-nav__link">
      Early Warning System
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">
    
    <label class="md-nav__link" for="nav-2-5">
      Triage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Triage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../triage_intro/" title="A deeper look into triage" class="md-nav__link">
      A deeper look into triage
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Experiment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Experiment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/defining/" title="Defining an Experiment" class="md-nav__link">
      Defining an Experiment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/feature-testing/" title="Testing Feature Configuration" class="md-nav__link">
      Testing Feature Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/running/" title="Running an Experiment" class="md-nav__link">
      Running an Experiment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/upgrading/" title="Upgrading an Experiment" class="md-nav__link">
      Upgrading an Experiment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/temporal-validation/" title="Temporal Validation Deep Dive" class="md-nav__link">
      Temporal Validation Deep Dive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/cohort-labels/" title="Cohort and Label Deep Dive" class="md-nav__link">
      Cohort and Label Deep Dive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/prediction-ranking/" title="Prediction Ranking" class="md-nav__link">
      Prediction Ranking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/features/" title="Feature Generation Recipe Book" class="md-nav__link">
      Feature Generation Recipe Book
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/algorithm/" title="Experiment Algorithm" class="md-nav__link">
      Experiment Algorithm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../experiments/architecture/" title="Experiment Architecture" class="md-nav__link">
      Experiment Architecture
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../audition/" title="Model selection" class="md-nav__link">
      Model selection
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../postmodeling/" title="Postmodeling" class="md-nav__link">
      Postmodeling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ml_governance/" title="Model governance" class="md-nav__link">
      Model governance
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
    <a href="./" title="Scaling up" class="md-nav__link md-nav__link--active">
      Scaling up
    </a>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Scaling up</h1>
                
                <h2>Scaling out: AWS Batch</h2>
<blockquote>
<p>If your laptop choked in the previous sections or if you can't afford to look your laptop just lagging forever, you should read this section&#x2026;</p>
</blockquote>
<p>For bigger experiment, one option is use <code>[[https://aws.amazon.com/batch/][AWS Batch]]</code>. AWS Batch dynamically provisions the optimal quantity and type of compute resources based on the specific resource requirements of the tasks submitted. AWS Batch will manage (i.e. plans, schedules, and executes) the resources (CPU, Memory) that we need to run the pipeline. In other words, AWS Batch will provide you with a computer (an AWS EC2 machine) that satisfies your computing requirements, and then it will execute the software that you intend to run.</p>
<p>AWS Batch dependes in other two technologies in order to work: Elastic Container Registry (Amazon ECR) as the Docker image registry (allowing AWS Batch to fetch the task images), and Elastic Compute Cloud (Amazon EC2) instances located in the cluster as the docker host (allowing AWS Batch to execute the task).</p>
<p><img alt="img" src="../images/AWS_Batch_Architecture.png" title="Diagram showing the AWS Batch main components and their relationships." /></p>
<p>An AWS ECS task will be executed by an EC2 instance belonging to the ECS cluster (if there are resources available). The EC2 machine operates as a Docker host: it will run the task definition, download the appropriate image from the ECS registry, and execute the container.</p>
<h3>What do you need to setup?</h3>
<p>AWS Batch requires setup the following infrastructure:</p>
<ul>
<li>An <a href="https://aws.amazon.com/s3/?nc2=h_m1">AWS S3 bucket</a> for storing the original data and the successive transformations of it made by the pipeline.</li>
<li>A PostgreSQL database (provided by <a href="https://aws.amazon.com/rds/">AWS RDS</a>) for storing the data in a relational form.</li>
<li>An Elastic Container Registry (<a href="https://aws.amazon.com/ecs/">AWS ECR</a>) for storing the triage's Docker image used in the pipeline.</li>
<li><a href="https://aws.amazon.com/batch/">AWS Batch Job Queue</a> configured and ready to go.</li>
</ul>
<h3>Assumptions</h3>
<ul>
<li>You have <code>[[https://stedolan.github.io/jq/download/][jq]]</code> installed</li>
<li>You have IAM credentials with permissions to run AWS Batch, read AWS S3 and create AWS EC2 machines.</li>
<li>You installed <code>awscli</code> and configure your credentials following the standard instructions.</li>
<li>You have access to a S3 bucket:</li>
<li>You have a AWS ECR repository with the following form: <code>dsapp/triage-cli</code></li>
<li>You have a AWS Batch job queue configured and have permissions for adding, running, canceling jobs.</li>
</ul>
<p>You can check if you have the <code>AWS S3</code> permissions like:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> aws ls <span class="o">[</span>your-bucket<span class="o">]</span>   <span class="c1"># (dont&#39;t forget the last backslash)</span>
</pre></div>

<p>And for the <code>AWS Batch</code> part:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> aws batch describe-job-queues
<span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> aws batch describe-job-definitions
</pre></div>

<h3>Configuration</h3>
<p>First we need to customize the file <code>.aws_env</code> (yes, another environment file).</p>
<p>Copy the file <code>aws_env.example</code> to <code>.aws_env</code> and fill the blanks</p>
<p><strong>NOTE</strong>: Don't include the <code>s3://</code> protocol prefix in the <code>S3_BUCKET</code></p>
<h4>(Local) Environment variables</h4>
<div class="highlight"><pre><span></span>#!/usr/bin/env bash

PROJECT_NAME=dirtyduck
TRIAGE_VERSION=3.3.0
ENV=development
AWS_REGISTRY={your-ecr-registry}
AWS_JOB_QUEUE={your-job-queue}
POSTGRES_DB={postgresql://user:password@db_server/dbname}
S3_BUCKET={your-bucket}
</pre></div>

<p>To check if everything is correct you can run:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span>  ./deploy.sh -h
</pre></div>

<p>Next, we need 3 files for running in AWS Batch, copy the files and remove the <code>.example</code> extension and adapt them to your case:</p>
<h4>Job definition</h4>
<p>Change the <code>PROJECT_NAME</code> and <code>AWS_ACCOUNT</code> for their real values</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;containerProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;--tb&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::experiment_file&quot;</span><span class="p">,</span>
      <span class="s2">&quot;--project-path&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::output_path&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::replace&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::save_predictions&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::profile&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ref::validate&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_ACCOUNT.dkr.ecr.us-west-2.amazonaws.com/YOUR_TRIAGE_IMAGE&quot;</span><span class="p">,</span>
    <span class="nt">&quot;jobRoleArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::AWS_ACCOUNT:role/dsappBatchJobRole&quot;</span><span class="p">,</span>
    <span class="nt">&quot;memory&quot;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span>
    <span class="nt">&quot;vcpus&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nt">&quot;jobDefinitionName&quot;</span><span class="p">:</span> <span class="s2">&quot;triage-cli-experiment&quot;</span><span class="p">,</span>
  <span class="nt">&quot;retryStrategy&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;attempts&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;container&quot;</span>
<span class="p">}</span>
</pre></div>

<h4>Environment variables overrides (for docker container inside the AWS EC2)</h4>
<p>Fill out the missing values</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;environment&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;us-west-2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS_JOB_QUEUE&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;POSTGRES_HOST&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<h4><code>credentials-filter</code></h4>
<p>Leave this file as is (We will use it for storing the temporal token in <code>deploy.sh</code>)</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="nt">&quot;environment&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="err">.Credentials.AccessKeyId</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="err">.Credentials.SecretAccessKey</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SESSION_TOKEN&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="err">.Credentials.SessionToken</span>
                <span class="p">}</span>
        <span class="p">]</span>
<span class="p">}</span>
</pre></div>

<h4>Running an experiment</h4>
<p>We provided a simple bash file for creating the image, uploading/updating the job definition and running the experiment:</p>
<div class="highlight"><pre><span></span>    ./deploy.sh -h

    Usage: ./deploy.sh <span class="o">(</span>-h <span class="p">|</span> -i <span class="p">|</span> -u <span class="p">|</span> -b <span class="p">|</span> -r <span class="p">|</span> -a <span class="p">|</span> --sync_<span class="o">{</span>to,from<span class="o">}</span>_s3 <span class="o">)</span>
    OPTIONS:
       -h<span class="p">|</span>--help                   Show this message
       -i<span class="p">|</span>--info                   Show information about the environment
       -b<span class="p">|</span>--update-images          Build the triage image and push it to the AWS ECR
       -u<span class="p">|</span>--update-jobs            Update the triage job definition in AWS Batch
       -r<span class="p">|</span>--run-experiment         Run experiments on chile-dt data
       --sync-to-s3                Uploads the experiments and configuration files to s3://your_project
       --sync-from-s3              Gets the experiments and configuration files from s3://your_project
    EXAMPLES:
       Build and push the images to your AWS ECR:
            $ ./deploy.sh -b
       Update the job<span class="err">&#39;</span>s definitions:
            $ ./deploy.sh -u
       Run triage experiments:
            $ ./deploy.sh -r --experiment_file<span class="o">=</span>s3://your_project/experiments/test.yaml,project_path<span class="o">=</span>s3://your_project/triage,replace<span class="o">=</span>--replace
</pre></div>

<p>If you have multiple AWS profiles use <code>deploy.sh</code> as follows:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> ./deploy.sh -r <span class="o">[</span>job-run-name<span class="o">]</span> <span class="nv">experiment_file</span><span class="o">=</span>s3://<span class="o">{</span>your_bucket<span class="o">}</span>/experiments/simple_test_skeleton.yaml,output_path<span class="o">=</span>s3://<span class="o">{</span>your_bucket<span class="o">}</span>/triage,replace<span class="o">=</span>--no-replace,save_predictions<span class="o">=</span>--no-save-predictions,profile<span class="o">=</span>--profile,validate<span class="o">=</span>--validate
</pre></div>

<p>Where <code>your_profile</code> is the name of the profile in <code>~/.aws/credentials</code></p>
<h4>Suggested workflow</h4>
<p>The workflow now is:</p>
<ul>
<li>
<p>At the beginning of the project</p>
<ul>
<li>Set a <code>docker image</code> and publish it to the AWS ECR (if needed, or you can use the <code>triage</code> official one).</li>
</ul>
<blockquote>
<p>You could create different images if you want to run something more tailored to you (like not using the <code>cli</code> interface)</p>
</blockquote>
<ul>
<li>Create a <em>job definition</em> and publish it:</li>
</ul>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> ./deploy.sh -u
</pre></div>

<blockquote>
<p>You could create different jobs if, for example, you want to have different resources (maybe small resources for testing or a lot of resources for a big experiment)</p>
</blockquote>
</li>
<li>
<p>Every time that you have an idea about how to improve the results</p>
<ul>
<li>Create experiment files and publish them to the <code>s3</code> bucket:</li>
</ul>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> ./deploy.sh --synt-to-s3
</pre></div>

<ul>
<li>Run the experiments</li>
</ul>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="nv">AWS_PROFILE</span><span class="o">=</span>your_profile<span class="o">]</span> ./deploy.sh -r <span class="o">[</span>job-run-name<span class="o">]</span> <span class="nv">experiment_file</span><span class="o">=</span>s3://<span class="o">{</span>your_bucket<span class="o">}</span>/experiments/simple_test_skeleton.yaml,output_path<span class="o">=</span>s3://<span class="o">{</span>your_bucket<span class="o">}</span>/triage,replace<span class="o">=</span>--no-replace,save_predictions<span class="o">=</span>--no-save-predictions,profile<span class="o">=</span>--profile,validate<span class="o">=</span>--validate
</pre></div>

</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../ml_governance/" title="Model governance" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Model governance
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/dssg/hitchhikers-guide" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/datascifellows" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/center-for-data-science-and-public-policy-university-of-chicago" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.267712eb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="../../../js/mermaid.min.js"></script>
      
    
  </body>
</html>